<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.1.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://cdn.jsdelivr.net'>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  <title>Nacos源码分析 - 灰色と青</title>

  
    <meta name="description" content="Nacos TutorialNacos总览nacos服务健康探测机制与保护阈值引入第一个问题，健康探测机制，服务注册中心都必须是要有的 nacos健康探测机制，分成两种，临时实例、持久化实例，针对不同的实例，他的健康探测机制不太一样，dubbo服务注册的时候要带上一个参数[ephemeral]，可以取值为两个，临时和持久化 默认情况下都不用去主动设置这个参数，默认都是ephemeral，临时实例">
<meta property="og:type" content="article">
<meta property="og:title" content="Nacos源码分析">
<meta property="og:url" content="http://example.com/2022/03/21/Nacos%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="灰色と青">
<meta property="og:description" content="Nacos TutorialNacos总览nacos服务健康探测机制与保护阈值引入第一个问题，健康探测机制，服务注册中心都必须是要有的 nacos健康探测机制，分成两种，临时实例、持久化实例，针对不同的实例，他的健康探测机制不太一样，dubbo服务注册的时候要带上一个参数[ephemeral]，可以取值为两个，临时和持久化 默认情况下都不用去主动设置这个参数，默认都是ephemeral，临时实例">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203210117403.png">
<meta property="og:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203211156633.png">
<meta property="og:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203221208632.png">
<meta property="article:published_time" content="2022-03-20T16:26:41.000Z">
<meta property="article:modified_time" content="2022-03-23T08:04:12.195Z">
<meta property="article:author" content="sean">
<meta property="article:tag" content="Nacos">
<meta property="article:tag" content="SpringCloud Alibaba">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203210117403.png">
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="灰色と青" type="application/atom+xml">
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  
</head>

<body>
  


  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    


<header class="header">

<div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://cdn.jsdelivr.net/gh/cdn-x/placeholder@1.0.2/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/images/header.jpg" onerror="javascript:this.classList.add('error');this.src='https://cdn.jsdelivr.net/gh/cdn-x/placeholder@1.0.1/image/2659360.svg';"></a><a class="title" href="/"><div class="main">灰色と青</div><div class="sub cap">Eurekawm's Blog</div></a></div>
<nav class="menu dis-select"><a class="nav-item active" href="/">文章</a><a class="nav-item" href="/wiki/">项目</a><a class="nav-item" href="/notes/">笔记</a><a class="nav-item" href="/more/">更多</a></nav></header>

<div class="widgets">

<div class="widget-wrap single" id="toc"><div class="widget-header cap dis-select"><span class="name">本文目录</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E6%80%BB%E8%A7%88"><span class="toc-text">Nacos总览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E6%9C%8D%E5%8A%A1%E5%81%A5%E5%BA%B7%E6%8E%A2%E6%B5%8B%E6%9C%BA%E5%88%B6%E4%B8%8E%E4%BF%9D%E6%8A%A4%E9%98%88%E5%80%BC"><span class="toc-text">nacos服务健康探测机制与保护阈值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8Anacos%E5%81%A5%E5%BA%B7%E4%BF%9D%E6%8A%A4%E9%98%88%E5%80%BC"><span class="toc-text">服务雪崩问题以及nacos健康保护阈值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E9%98%88%E5%80%BC%E6%9C%BA%E5%88%B6%E5%BC%80%E5%90%AF%E5%90%8E%E7%9A%84CAP%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">保护阈值机制开启后的CAP问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E7%A0%94Distro%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="toc-text">自研Distro分布式一致性协议分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ERaft%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%BC%B1CP%E6%9C%BA%E5%88%B6"><span class="toc-text">基于Raft协议的弱CP机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B%E5%92%8C%E6%8C%81%E4%B9%85%E5%AE%9E%E4%BE%8B"><span class="toc-text">临时实例和持久实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Naocs-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">Naocs 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-Client%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">Nacos Client源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%A6%81API"><span class="toc-text">重要API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">Nacos启动流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1"><span class="toc-text">Nacos获取所有服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos%E5%AE%9A%E6%97%B6%E6%9B%B4%E6%96%B0%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1"><span class="toc-text">Nacos定时更新本地服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos-Client%E8%8E%B7%E5%8F%96%E8%A6%81%E8%B0%83%E7%94%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%8F%90%E4%BE%9B%E8%80%85%E5%88%97%E8%A1%A8"><span class="toc-text">Nacos Client获取要调用的服务的提供者列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">Nacos Server源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%A6%81API%E4%BB%8B%E7%BB%8D"><span class="toc-text">重要API介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-%E5%A4%84%E7%90%86client%E6%B3%A8%E5%86%8C%E8%AF%B7%E6%B1%82"><span class="toc-text">Server 处理client注册请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFService%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text">开启Service健康检测定时任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFCluster%E7%9A%84%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text">开启Cluster的健康检测定时任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos-Server%E5%A4%84%E7%90%86%E6%B3%A8%E9%94%80%E8%AF%B7%E6%B1%82"><span class="toc-text">Nacos Server处理注销请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server%E5%A4%84%E7%90%86%E5%BF%83%E8%B7%B3%E8%AF%B7%E6%B1%82"><span class="toc-text">Server处理心跳请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%A2%E9%98%85"><span class="toc-text">Server处理客户端订阅</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server%E5%92%8CClient%E4%B9%8B%E9%97%B4%E7%9A%84UDP%E9%80%9A%E4%BF%A1"><span class="toc-text">Server和Client之间的UDP通信</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%91%E9%80%81UDP%E6%8E%A8%E9%80%81"><span class="toc-text">服务端发送UDP推送</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%B6%E5%88%B0UDP%E6%8A%A5%E6%96%87%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">客户端收到UDP报文的处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-text">Server间通信</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E6%8A%A5%E6%9C%AC%E5%9C%B0%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%BB%BB%E5%8A%A1"><span class="toc-text">上报本地注册表任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E5%85%B6%E4%BB%96Nacos%E8%8E%B7%E5%8F%96%E6%9C%80%E6%96%B0%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%B9%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="toc-text">从其他Nacos获取最新注册表并更新到本地</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E6%B8%85%E7%90%86%E7%A9%BAService"><span class="toc-text">定时清理空Service</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div>


</div>


    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Java/">Java</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/Java/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></div><div id="post-meta">发布于&nbsp;<time datetime="2022-03-20T16:26:41.000Z">2022-03-21</time></div></div>

<article class='content md post'>
<h1 class="article-title"><span>Nacos源码分析</span></h1>
<h1 id="Nacos-Tutorial"><a href="#Nacos-Tutorial" class="headerlink" title="Nacos Tutorial"></a>Nacos Tutorial</h1><h2 id="Nacos总览"><a href="#Nacos总览" class="headerlink" title="Nacos总览"></a>Nacos总览</h2><h3 id="nacos服务健康探测机制与保护阈值"><a href="#nacos服务健康探测机制与保护阈值" class="headerlink" title="nacos服务健康探测机制与保护阈值"></a>nacos服务健康探测机制与保护阈值</h3><p>引入第一个问题，健康探测机制，服务注册中心都必须是要有的</p>
<p>nacos健康探测机制，分成两种，临时实例、持久化实例，针对不同的实例，他的健康探测机制不太一样，dubbo服务注册的时候要带上一个参数[ephemeral]，可以取值为两个，临时和持久化</p>
<p>默认情况下都不用去主动设置这个参数，默认都是ephemeral，临时实例</p>
<p>临时的话，默认每隔5s上报一次心跳，nacos如果15s没收到心跳就标记为不健康，超过30s没收到就摘除这个服务实例</p>
<p>持久化的话，nacos主动探测，20s探测一次，即使探测失败，也就是不健康状态，但是不会摘除这个服务实例</p>
<p>默认情况下，不健康的实例是不返回的，但是如果健康实例比例太低，会导致健康实例请求压力过大，被打死，引发服务雪崩，所以有保护阈值的概念</p>
<p>保护阈值，可以设置为0~1之间的比例，如果健康实例比例太低，则把不健康实例一起返回，此时会让很多请求走到不健康实例，会导致请求失败，但是可以避免健康实例的请求流量过大被打死，牺牲了一致性，得到了可用性 </p>
<h3 id="服务雪崩问题以及nacos健康保护阈值"><a href="#服务雪崩问题以及nacos健康保护阈值" class="headerlink" title="服务雪崩问题以及nacos健康保护阈值"></a>服务雪崩问题以及nacos健康保护阈值</h3><p>服务雪崩问题，nacos健康保护阈值</p>
<p>库存服务有10台机器，10个服务实例，订单服务会大范围的去调用库存服务，假设每个库存服务实例单机可以抗每秒500次请求，QPS 500，高峰 QPS 500 * 10 &#x3D; 5000，某一天，库存服务实例10个，里面有5个都崩溃了</p>
<p>5台机器都是虚拟机，部署在一个物理机，物理机故障了，就会导致5个虚拟机一起故障了这样子</p>
<p>每秒5000次请求，都会发送给剩下的5台健康的实例，平均每台实例会收到每秒1000次请求，远远超出了单机极限QPS，800，1000已经超过了。 </p>
<p>nacos有一个保护阈值， 比如设置为0.8 那么10台实例挂了两台都是没关系的，不会触发保护机制，订单服务会去请求这些剩下的8个健康实例，如果挂了4个，剩下6个，如果订单服务来请求，可能扛不住，如果设置阈值为0.6，所以nacos会返回订单服务6个健康的实例和4个挂了的实例，订单那边请求失败，但是不会把机器打垮，防止雪崩。</p>
<h3 id="保护阈值机制开启后的CAP问题分析"><a href="#保护阈值机制开启后的CAP问题分析" class="headerlink" title="保护阈值机制开启后的CAP问题分析"></a>保护阈值机制开启后的CAP问题分析</h3><p>一句话， 开了保护阈值机制打开了，会保障可用性，牺牲了一致性，订单看起来这些实例就不是一致。如果不打开保护阈值机制，那么请求的都是健康的服务实例，那么订单服务看起来都是一致的。</p>
<h3 id="自研Distro分布式一致性协议分析"><a href="#自研Distro分布式一致性协议分析" class="headerlink" title="自研Distro分布式一致性协议分析"></a>自研Distro分布式一致性协议分析</h3><p>nacos基础原理+开发实战+核心功能+数据模型，重点要给大家讲解一下nacos的内核原理</p>
<p>服务注册这块，允许大量的服务实例来注册，在nacos集群里管理所有的服务实例数据，针对你的nacos里管理的服务实例数据服务发现，注册（写操作），存储（nacos集群存放服务实例数据），发现（读操作），针对临时服务实例数据的存储</p>
<p>灵魂拷问：服务注册找nacos集群里哪个节点来发起？服务实例数据是存储在哪个nacos节点里？发现的时候找的是nacos哪个节点？</p>
<p>nacos集群启动之后按如下原则运作：</p>
<p>1、nacos每个节点都可以处理写请求，收到请求后，路由，根据ip:port路由算法，计算所属节点，把请求转发到负责这个数据的节点去，负责节点解析请求在本机里进行内存存储，定期执行同步任务，把本机负责的数据同步到其他节点，所以每个节点都有全量数据的存储</p>
<p>distro分布式一致性协议里，设计了一个定时sync同步机制和任务</p>
<p>关键点，仅仅按照这套算法来运行，会导致数据分片，data partition，每个nacos节点仅仅负责和管理了一部分的服务实例数据</p>
<p>提出第一种服务发现读数据的时候，nacos节点上没有你要的服务实例的数据，写路由+数据分片+读路由的架构设计，可用性的问题，优点是数据是强一致的，CAP，C，牺牲掉A，可用性就没有了，并不是nacos采用的方案，CP</p>
<p>nacos默认提供的AP，保证可用性</p>
<p>通过各个节点 定时同步数据的机制，可以确保说什么，每个节点除了处理自己负责的那部分数据写入，自己也会不断的把自己的数据同步给别的节点，定时的不断的接收到别的节点同步过来的数据</p>
<p>对于你的每一个节点来说，他会发现你这个节点上，会有所有节点的数据都汇总到你这里来，你这里会源源不断的接收到集群里完整的服务实例数据，保证最终一致性的概念，最终每个节点都会有集群里最新的数据</p>
<p>时间差问题-&gt;最终一致性，牺牲掉了一致性，AP，CP</p>
<p>2、新加入的nacos节点会拉取全量数据，轮询所有nacos节点，发送请求拉取全量数据，所以其实每个nacos节点上都会有所有注册上来的临时服务实例的数据</p>
<p>3、nacos每个节点都会定期发送心跳给其他的节点，心跳请求会进行数据校验，主要是交换数据的校验值，如果发现要是其他机器上的数据跟自己不一致，就会全量拉取数据进行补齐</p>
<p>4、nacos每个节点都可以处理读请求，因为有全量数据</p>
<p>distro协议是兼顾CAP中的AP的，在这个协议之下，所有节点通过定期数据同步，还有心跳校验实现节点数据最终一致，让每个节点都有全量数据，这样的话，如果有节点宕机崩溃都是没关系的</p>
<p>另外网络分区的话，也是没事的，因为不同的网络分区里就是读写分区中的nacos节点就可以了，就是没办法互相同步数据了，数据会不一致（通过MD5来校验的），但是一旦分区问题恢复了，心跳校验机制运作起来，数据会自动补齐的</p>
<h3 id="基于Raft协议的弱CP机制"><a href="#基于Raft协议的弱CP机制" class="headerlink" title="基于Raft协议的弱CP机制"></a>基于Raft协议的弱CP机制</h3><p>我如果是基于路由转发的这种方式， 数据集中在一个服务器上，这样是不可行的，会把机器打垮。如果是全量复制，数据也是强一致的，但是这种同步全量复制机制是很重的，写入性能非常低。</p>
<p>Distro这种是异步复制，保障的是最终一致性，再加上心跳机制，各个节点最终是一致的，但是有时间差问题，牺牲了一致性。即使崩溃了，也有一个机器有几乎全量数据。</p>
<p>首先Nacos集群通过Raft协议来选举，选举成为leader的节点才能接受读请求，然后接受读请求这一段时间服务是不可用，因为有一个raft日志同步过程（半数节点以上），但是Nacos的Raft不是标准的两阶段提交（2.0之后是标准的Raft两阶段提交），所以Nacos是有是一个弱CP机制的。有一个问题，半数节点同步了，其他节点呢？Nacos是通过注册心跳来解决，Nacos主节点发送心跳（zip）的时候附带了主节点上一些服务信息，然后从节点如果发现自己少了这些，那么就主动call注解点来拉取。</p>
<h3 id="临时实例和持久实例"><a href="#临时实例和持久实例" class="headerlink" title="临时实例和持久实例"></a>临时实例和持久实例</h3><ul>
<li>临时实例：默认情况，注册在内存注册表中，不会持久化到磁盘文件，健康检查是client模式，client主动上报，5S一次，Server 检查心跳情况，15秒没上报就设置为不健康，30S没上报就删除实例</li>
<li>持久化实例：注册到内存注册表之后，还会写入到磁盘文件，心跳检测是Server主动去检测client心跳是拉模式，20S检查一次，检测失败会把实例标记为不健康，但不会清除，因为持久化了</li>
</ul>
<p>使用场景：临时实例是存在突发流量横向扩展服务，适用于互联网，持久实例是相对固定的实例。</p>
<h2 id="Naocs-源码分析"><a href="#Naocs-源码分析" class="headerlink" title="Naocs 源码分析"></a>Naocs 源码分析</h2><h3 id="Nacos-Client源码分析"><a href="#Nacos-Client源码分析" class="headerlink" title="Nacos Client源码分析"></a>Nacos Client源码分析</h3><h4 id="重要API"><a href="#重要API" class="headerlink" title="重要API"></a>重要API</h4><p>Instance类，代表一个服务实例，一些基础信息，一个实例隶属于一个服务，一个集群</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonInclude(Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Instance</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">742906310567291979L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * unique id of this instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String instanceId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * instance ip.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * instance port.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * instance weight.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">weight</span> <span class="operator">=</span> <span class="number">1.0D</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * instance health status.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">healthy</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If instance is enabled to accept request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If instance is ephemeral.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">ephemeral</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cluster information of instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String clusterName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service information of instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * user extended attributes.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; metadata = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServiceInfo类，包含一个Instance列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonInclude(Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceInfo</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">jsonFromServer</span> <span class="operator">=</span> EMPTY;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPLITER</span> <span class="operator">=</span> <span class="string">&quot;@@&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// 服务名</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String clusters; <span class="comment">// 一个服务可能有多个集群</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">cacheMillis</span> <span class="operator">=</span> <span class="number">1000L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Instance&gt; hosts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Instance&gt;(); <span class="comment">// 当前服务所有的服务实例列表</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastRefTime</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">checksum</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">allIPs</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NamingService 接口，它有一个实现类NacosNamingService，可以完成Client到Server的各种通信，注册&#x2F;取消注册，订阅取消等等</p>
<h4 id="Nacos启动流程"><a href="#Nacos启动流程" class="headerlink" title="Nacos启动流程"></a>Nacos启动流程</h4><p>Nacos启动是根据事件监听机制，监听到web服务器启动之后，就开始自动注册。自动注册之前的逻辑先跳过，直接来看到底是怎么注册的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Registration registration)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(registration.getServiceId())) &#123;</span><br><span class="line">			log.warn(<span class="string">&quot;No service to register for nacos client...&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">NamingService</span> <span class="variable">namingService</span> <span class="operator">=</span> namingService();</span><br><span class="line">		<span class="comment">// 微服务名称</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> registration.getServiceId();</span><br><span class="line">		<span class="comment">// 分组</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> nacosDiscoveryProperties.getGroup();</span><br><span class="line">		<span class="comment">// 生成instance </span></span><br><span class="line">		<span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> getNacosInstanceFromRegistration(registration);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 调用注册逻辑</span></span><br><span class="line">			namingService.registerInstance(serviceId, group, instance);</span><br><span class="line">			log.info(<span class="string">&quot;nacos registry, &#123;&#125; &#123;&#125; &#123;&#125;:&#123;&#125; register finished&quot;</span>, group, serviceId,</span><br><span class="line">					instance.getIp(), instance.getPort());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot;nacos registry, &#123;&#125; register failed...&#123;&#125;,&quot;</span>, serviceId,</span><br><span class="line">					registration.toString(), e);</span><br><span class="line">			<span class="comment">// rethrow a RuntimeException if the registration is failed.</span></span><br><span class="line">			<span class="comment">// issue : https://github.com/alibaba/spring-cloud-alibaba/issues/1132</span></span><br><span class="line">			rethrowRuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后进入的是NacosNamingService类的registerInstance方法，其实还是一个封装instance，然后注册的，进入到这个重载方法内部，有几步需要做的：</p>
<ol>
<li>验证instance是否合法</li>
<li>获取groupSerce名称 例如 my_default_group@@order_service</li>
<li>开始心跳  </li>
<li>发起注册</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerInstance</span><span class="params">(String serviceName, String groupName, Instance instance)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        NamingUtils.checkInstanceIsLegal(instance);</span><br><span class="line">        <span class="type">String</span> <span class="variable">groupedServiceName</span> <span class="operator">=</span> NamingUtils.getGroupedName(serviceName, groupName);</span><br><span class="line">        <span class="keyword">if</span> (instance.isEphemeral()) &#123;</span><br><span class="line">            <span class="comment">// 是否是临时实例 构建Beat信息</span></span><br><span class="line">            <span class="type">BeatInfo</span> <span class="variable">beatInfo</span> <span class="operator">=</span> beatReactor.buildBeatInfo(groupedServiceName, instance);</span><br><span class="line">            <span class="comment">// 开始心跳</span></span><br><span class="line">            beatReactor.addBeatInfo(groupedServiceName, beatInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册</span></span><br><span class="line">        serverProxy.registerService(groupedServiceName, groupName, instance);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看一下心跳信息有什么内容，其实就是当前实例的一些东西， 加上间隔时间。默认是5S发送一次心跳。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> BeatInfo <span class="title function_">buildBeatInfo</span><span class="params">(String groupedServiceName, Instance instance)</span> &#123;</span><br><span class="line">        <span class="type">BeatInfo</span> <span class="variable">beatInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeatInfo</span>();</span><br><span class="line">        beatInfo.setServiceName(groupedServiceName);</span><br><span class="line">        beatInfo.setIp(instance.getIp());</span><br><span class="line">        beatInfo.setPort(instance.getPort());</span><br><span class="line">        beatInfo.setCluster(instance.getClusterName());</span><br><span class="line">        beatInfo.setWeight(instance.getWeight());</span><br><span class="line">        beatInfo.setMetadata(instance.getMetadata());</span><br><span class="line">        beatInfo.setScheduled(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 心跳间隔 默认5秒</span></span><br><span class="line">        beatInfo.setPeriod(instance.getInstanceHeartBeatInterval());</span><br><span class="line">        <span class="keyword">return</span> beatInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码执行顺序可以看出，既然先执行发送心跳，但是此时还没注册上去，发送心跳必然找不到服务啊？其实这是一个延迟任务，点进发送心跳的源码看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add beat information.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName service name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beatInfo    beat information</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBeatInfo</span><span class="params">(String serviceName, BeatInfo beatInfo)</span> &#123;</span><br><span class="line">        NAMING_LOGGER.info(<span class="string">&quot;[BEAT] adding beat: &#123;&#125; to beat map.&quot;</span>, beatInfo);</span><br><span class="line">				<span class="comment">// key的格式为 groupId@@微服务名称##ip##port</span></span><br><span class="line">				<span class="comment">// 这个key是固定了主机了</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> buildKey(serviceName, beatInfo.getIp(), beatInfo.getPort());</span><br><span class="line">        <span class="type">BeatInfo</span> <span class="variable">existBeat</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//fix #1733 again</span></span><br><span class="line">				<span class="comment">// dom2Beat是一个缓存map，key是主机，value=主机发送的心跳信息beat</span></span><br><span class="line">				<span class="comment">// 前面的心跳停了才发送新的心跳</span></span><br><span class="line">        <span class="keyword">if</span> ((existBeat = dom2Beat.put(key, beatInfo)) != <span class="literal">null</span>) &#123;</span><br><span class="line">            existBeat.setStopped(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 开始定时任务 5S之后开始任务 在结束之前又开始一个新的任务</span></span><br><span class="line">        executorService.schedule(<span class="keyword">new</span> <span class="title class_">BeatTask</span>(beatInfo), beatInfo.getPeriod(), TimeUnit.MILLISECONDS);</span><br><span class="line">        MetricsMonitor.getDom2BeatSizeMonitor().set(dom2Beat.size());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>看一下BeatTask的run方法，其实就是使用httpClient发起调用，然后结束之前把任务再添加今天循环调用而已。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (beatInfo.isStopped()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">nextTime</span> <span class="operator">=</span> beatInfo.getPeriod();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 发送心跳 PUT 请求</span></span><br><span class="line">                <span class="type">JsonNode</span> <span class="variable">result</span> <span class="operator">=</span> serverProxy.sendBeat(beatInfo, BeatReactor.<span class="built_in">this</span>.lightBeatEnabled);</span><br><span class="line">                <span class="type">long</span> <span class="variable">interval</span> <span class="operator">=</span> result.get(<span class="string">&quot;clientBeatInterval&quot;</span>).asLong();</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">lightBeatEnabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (result.has(CommonParams.LIGHT_BEAT_ENABLED)) &#123;</span><br><span class="line">                    lightBeatEnabled = result.get(CommonParams.LIGHT_BEAT_ENABLED).asBoolean();</span><br><span class="line">                &#125;</span><br><span class="line">                BeatReactor.<span class="built_in">this</span>.lightBeatEnabled = lightBeatEnabled;</span><br><span class="line">                <span class="keyword">if</span> (interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    nextTime = interval;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> NamingResponseCode.OK;</span><br><span class="line">                <span class="keyword">if</span> (result.has(CommonParams.CODE)) &#123;</span><br><span class="line">                    code = result.get(CommonParams.CODE).asInt();</span><br><span class="line">                &#125;</span><br><span class="line">								<span class="comment">// 如果发现此实例在nacos server上面没有注册，那么就执行注册的逻辑</span></span><br><span class="line">                <span class="keyword">if</span> (code == NamingResponseCode.RESOURCE_NOT_FOUND) &#123;</span><br><span class="line">                    <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Instance</span>();</span><br><span class="line">                    instance.setPort(beatInfo.getPort());</span><br><span class="line">                    instance.setIp(beatInfo.getIp());</span><br><span class="line">                    instance.setWeight(beatInfo.getWeight());</span><br><span class="line">                    instance.setMetadata(beatInfo.getMetadata());</span><br><span class="line">                    instance.setClusterName(beatInfo.getCluster());</span><br><span class="line">                    instance.setServiceName(beatInfo.getServiceName());</span><br><span class="line">                    instance.setInstanceId(instance.getInstanceId());</span><br><span class="line">                    instance.setEphemeral(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">												</span><br><span class="line">                        serverProxy.registerService(beatInfo.getServiceName(),</span><br><span class="line">                                NamingUtils.getGroupName(beatInfo.getServiceName()), instance);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NacosException ex) &#123;</span><br><span class="line">                NAMING_LOGGER.warn(<span class="string">&quot;[CLIENT-BEAT] failed to send beat: &#123;&#125;, code: &#123;&#125;, msg: &#123;&#125;&quot;</span>,</span><br><span class="line">                        JacksonUtils.toJson(beatInfo), ex.getErrCode(), ex.getErrMsg());</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception unknownEx) &#123;</span><br><span class="line">                NAMING_LOGGER.error(<span class="string">&quot;[CLIENT-BEAT] failed to send beat: &#123;&#125;, unknown exception msg: &#123;&#125;&quot;</span>,</span><br><span class="line">                        JacksonUtils.toJson(beatInfo), unknownEx.getMessage(), unknownEx);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 再次嵌套调用</span></span><br><span class="line">                executorService.schedule(<span class="keyword">new</span> <span class="title class_">BeatTask</span>(beatInfo), nextTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>进入JsonNode result &#x3D; serverProxy.sendBeat(beatInfo, BeatReactor.this.lightBeatEnabled);把BeatInfo拆开放入map，发送过去，是一个PUT请求，请求url &#x3D; nacos&#x2F;v1&#x2F;ns&#x2F;instance</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> JsonNode <span class="title function_">sendBeat</span><span class="params">(BeatInfo beatInfo, <span class="type">boolean</span> lightBeatEnabled)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (NAMING_LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">            NAMING_LOGGER.debug(<span class="string">&quot;[BEAT] &#123;&#125; sending beat to server: &#123;&#125;&quot;</span>, namespaceId, beatInfo.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(<span class="number">8</span>);</span><br><span class="line">        Map&lt;String, String&gt; bodyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!lightBeatEnabled) &#123;</span><br><span class="line">            bodyMap.put(<span class="string">&quot;beat&quot;</span>, JacksonUtils.toJson(beatInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        params.put(CommonParams.NAMESPACE_ID, namespaceId);</span><br><span class="line">        params.put(CommonParams.SERVICE_NAME, beatInfo.getServiceName());</span><br><span class="line">        params.put(CommonParams.CLUSTER_NAME, beatInfo.getCluster());</span><br><span class="line">        params.put(<span class="string">&quot;ip&quot;</span>, beatInfo.getIp());</span><br><span class="line">        params.put(<span class="string">&quot;port&quot;</span>, String.valueOf(beatInfo.getPort()));</span><br><span class="line">        <span class="comment">// 发送Beat心跳</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> reqApi(UtilAndComs.nacosUrlBase + <span class="string">&quot;/instance/beat&quot;</span>, params, bodyMap, HttpMethod.PUT);</span><br><span class="line">        <span class="keyword">return</span> JacksonUtils.toObj(result);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>回到上文的注册逻辑，点进去看一下注册实例是怎么做的，其实就是两件事情</p>
<ol>
<li>把instace这个对象拆开，放入parmas</li>
<li>发起post请求，地址为 nacos&#x2F;v1&#x2F;ns&#x2F;instance</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerService</span><span class="params">(String serviceName, String groupName, Instance instance)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line"></span><br><span class="line">        NAMING_LOGGER.info(<span class="string">&quot;[REGISTER-SERVICE] &#123;&#125; registering service &#123;&#125; with instance: &#123;&#125;&quot;</span>, namespaceId, serviceName,</span><br><span class="line">                instance);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(<span class="number">16</span>);</span><br><span class="line">        params.put(CommonParams.NAMESPACE_ID, namespaceId);</span><br><span class="line">        params.put(CommonParams.SERVICE_NAME, serviceName);</span><br><span class="line">        params.put(CommonParams.GROUP_NAME, groupName);</span><br><span class="line">        params.put(CommonParams.CLUSTER_NAME, instance.getClusterName());</span><br><span class="line">        params.put(<span class="string">&quot;ip&quot;</span>, instance.getIp());</span><br><span class="line">        params.put(<span class="string">&quot;port&quot;</span>, String.valueOf(instance.getPort()));</span><br><span class="line">        <span class="comment">// 权重</span></span><br><span class="line">        params.put(<span class="string">&quot;weight&quot;</span>, String.valueOf(instance.getWeight()));</span><br><span class="line">        params.put(<span class="string">&quot;enable&quot;</span>, String.valueOf(instance.isEnabled()));</span><br><span class="line">        <span class="comment">// 健康度</span></span><br><span class="line">        params.put(<span class="string">&quot;healthy&quot;</span>, String.valueOf(instance.isHealthy()));</span><br><span class="line">        params.put(<span class="string">&quot;ephemeral&quot;</span>, String.valueOf(instance.isEphemeral()));</span><br><span class="line">        params.put(<span class="string">&quot;metadata&quot;</span>, JacksonUtils.toJson(instance.getMetadata()));</span><br><span class="line">        <span class="comment">// nacos/v1/ns/instance</span></span><br><span class="line">        reqApi(UtilAndComs.nacosUrlInstance, params, HttpMethod.POST);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>进入 reqApi(UtilAndComs.nacosUrlInstance, params, HttpMethod.POST);来看一些是怎么做的，一句话总结就是 如果有多个nacos节点，那么就轮训尝试注册，直到成功或是尝试次数达到了nacos服务数量。 如果是单节点，默认尝试次数为3。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">reqApi</span><span class="params">(String api, Map&lt;String, String&gt; params, Map&lt;String, String&gt; body, List&lt;String&gt; servers,</span></span><br><span class="line"><span class="params">                         String method)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line"></span><br><span class="line">        params.put(CommonParams.NAMESPACE_ID, getNamespaceId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(servers) &amp;&amp; StringUtils.isBlank(nacosDomain)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>(NacosException.INVALID_PARAM, <span class="string">&quot;no server available&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">NacosException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>();</span><br><span class="line">				<span class="comment">// domain不为空，先连接这个，默认尝试次数3</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(nacosDomain)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; maxRetry; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 调用服务注册</span></span><br><span class="line">                    <span class="keyword">return</span> callServer(api, params, body, nacosDomain, method);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">                    exception = e;</span><br><span class="line">                    <span class="keyword">if</span> (NAMING_LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">                        NAMING_LOGGER.debug(<span class="string">&quot;request &#123;&#125; failed.&quot;</span>, nacosDomain, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="comment">// 这里是一个重要的信息如果是多个nacos节点，其实是随机找个nacos节点来注册的</span></span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> random.nextInt(servers.size());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; servers.size(); i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> servers.get(index);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> callServer(api, params, body, server, method);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">                    exception = e;</span><br><span class="line">                    <span class="keyword">if</span> (NAMING_LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">                        NAMING_LOGGER.debug(<span class="string">&quot;request &#123;&#125; failed.&quot;</span>, server, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">								<span class="comment">// 该server连接失败 ，连接下一个</span></span><br><span class="line">                index = (index + <span class="number">1</span>) % servers.size();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NAMING_LOGGER.error(<span class="string">&quot;request: &#123;&#125; failed, servers: &#123;&#125;, code: &#123;&#125;, msg: &#123;&#125;&quot;</span>, api, servers, exception.getErrCode(),</span><br><span class="line">                exception.getErrMsg());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>(exception.getErrCode(),</span><br><span class="line">                <span class="string">&quot;failed to req API:&quot;</span> + api + <span class="string">&quot; after all servers(&quot;</span> + servers + <span class="string">&quot;) tried: &quot;</span> + exception.getMessage());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>后面发送HTTP POST请求的代码就不再细看了，是使用NameServerProxy来做，里面调用的是HttpClient发送的请求，请求的地址是<a target="_blank" rel="noopener" href="http://127.0.0.1:8848/nacos/v1/ns/instance%E3%80%82">http://127.0.0.1:8848/nacos/v1/ns/instance。</a></p>
<h4 id="Nacos获取所有服务"><a href="#Nacos获取所有服务" class="headerlink" title="Nacos获取所有服务"></a>Nacos获取所有服务</h4><p>直接说结论，是在NamingServiceProxy里面调用获取服务列表的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">queryList</span><span class="params">(String serviceName, String clusters, <span class="type">int</span> udpPort, <span class="type">boolean</span> healthyOnly)</span></span><br><span class="line">            <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(<span class="number">8</span>);</span><br><span class="line">        params.put(CommonParams.NAMESPACE_ID, namespaceId);</span><br><span class="line">        params.put(CommonParams.SERVICE_NAME, serviceName);</span><br><span class="line">        params.put(<span class="string">&quot;clusters&quot;</span>, clusters);</span><br><span class="line">        params.put(<span class="string">&quot;udpPort&quot;</span>, String.valueOf(udpPort));</span><br><span class="line">        params.put(<span class="string">&quot;clientIP&quot;</span>, NetUtils.localIP());</span><br><span class="line">        params.put(<span class="string">&quot;healthyOnly&quot;</span>, String.valueOf(healthyOnly));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// HTTP请求 调用服务列表</span></span><br><span class="line">        <span class="keyword">return</span> reqApi(UtilAndComs.nacosUrlBase + <span class="string">&quot;/instance/list&quot;</span>, params, HttpMethod.GET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Nacos定时更新本地服务"><a href="#Nacos定时更新本地服务" class="headerlink" title="Nacos定时更新本地服务"></a>Nacos定时更新本地服务</h4><p>容器在启动的时候创建了一个<code>NacosWatch</code> Bean，这个Bean就是和服务订阅有关的，看一下关键的方法    namingService.subscribe(properties.getService(), properties.getGroup(),这里就是订阅服务的地方了。我们看一些具体是怎么做的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.running.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">			<span class="type">EventListener</span> <span class="variable">eventListener</span> <span class="operator">=</span> listenerMap.computeIfAbsent(buildKey(),</span><br><span class="line">					event -&gt; <span class="keyword">new</span> <span class="title class_">EventListener</span>() &#123;</span><br><span class="line">						<span class="meta">@Override</span></span><br><span class="line">						<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">							<span class="keyword">if</span> (event <span class="keyword">instanceof</span> NamingEvent) &#123;</span><br><span class="line">								List&lt;Instance&gt; instances = ((NamingEvent) event)</span><br><span class="line">										.getInstances();</span><br><span class="line">								Optional&lt;Instance&gt; instanceOptional = selectCurrentInstance(</span><br><span class="line">										instances);</span><br><span class="line">								instanceOptional.ifPresent(currentInstance -&gt; &#123;</span><br><span class="line">									resetIfNeeded(currentInstance);</span><br><span class="line">								&#125;);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;);</span><br><span class="line"></span><br><span class="line">			<span class="type">NamingService</span> <span class="variable">namingService</span> <span class="operator">=</span> nacosServiceManager</span><br><span class="line">					.getNamingService(properties.getNacosProperties());</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				namingService.subscribe(properties.getService(), properties.getGroup(),</span><br><span class="line">						Arrays.asList(properties.getClusterName()), eventListener);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">&quot;namingService subscribe failed, properties:&#123;&#125;&quot;</span>, properties, e);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">this</span>.watchFuture = <span class="built_in">this</span>.taskScheduler.scheduleWithFixedDelay(</span><br><span class="line">					<span class="built_in">this</span>::nacosServicesWatch, <span class="built_in">this</span>.properties.getWatchDelay());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法调用层级很深，最后来到的是HostReactor下的subscribe方法，里面有一个关键的 getServiceInfo(serviceName, clusters);这里就是过去服务信息了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String serviceName, String clusters, EventListener eventListener)</span> &#123;</span><br><span class="line">        notifier.registerListener(serviceName, clusters, eventListener);</span><br><span class="line">        getServiceInfo(serviceName, clusters);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>进入这个方法内部，就是现在本地注册表中获取，如果没有这个服务那就先创建一个，然后向server发送get请求获取服务，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceInfo <span class="title function_">getServiceInfo</span><span class="params">(<span class="keyword">final</span> String serviceName, <span class="keyword">final</span> String clusters)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        NAMING_LOGGER.debug(<span class="string">&quot;failover-mode: &quot;</span> + failoverReactor.isFailoverSwitch());</span><br><span class="line">				<span class="comment">// 构建key 请求格式为 groupId@@微服务ID@@cluster名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> ServiceInfo.getKey(serviceName, clusters);</span><br><span class="line">        <span class="keyword">if</span> (failoverReactor.isFailoverSwitch()) &#123;</span><br><span class="line">            <span class="keyword">return</span> failoverReactor.getService(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从当前client本地注册表中获取当前服务 本地注册表是个map </span></span><br><span class="line">				<span class="comment">// key -&gt; groupId@@微服务ID@@cluster名称 value -&gt; serviceinfo</span></span><br><span class="line">        <span class="type">ServiceInfo</span> <span class="variable">serviceObj</span> <span class="operator">=</span> getServiceInfo0(serviceName, clusters);</span><br><span class="line">        <span class="comment">// 如果为空 （第一次启动肯定是空的）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == serviceObj) &#123;</span><br><span class="line">						<span class="comment">// 创建个空的服务 没有任何提供者实例</span></span><br><span class="line">            serviceObj = <span class="keyword">new</span> <span class="title class_">ServiceInfo</span>(serviceName, clusters);</span><br><span class="line">            <span class="comment">// 放入注册表</span></span><br><span class="line">            serviceInfoMap.put(serviceObj.getKey(), serviceObj);</span><br><span class="line">            <span class="comment">// 临时缓存 主要是使用这个缓存的key 不能重复 </span></span><br><span class="line">						<span class="comment">// 只要服务名称出现在这个缓存map中，就表示这个服务正在被更新</span></span><br><span class="line">            updatingMap.put(serviceName, <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">						<span class="comment">// 开始更新服务</span></span><br><span class="line">            updateServiceNow(serviceName, clusters);</span><br><span class="line">						<span class="comment">// 更新完了 删掉</span></span><br><span class="line">            updatingMap.remove(serviceName);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (updatingMap.containsKey(serviceName)) &#123;</span><br><span class="line">						<span class="comment">// 如果注册表中有了这个服务 而且临时缓存中有了这个服务</span></span><br><span class="line">            <span class="comment">// 那这个服务就是正在被更新 那就等一会儿</span></span><br><span class="line">            <span class="keyword">if</span> (UPDATE_HOLD_INTERVAL &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// hold a moment waiting for update finish</span></span><br><span class="line">                <span class="keyword">synchronized</span> (serviceObj) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        serviceObj.wait(UPDATE_HOLD_INTERVAL);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        NAMING_LOGGER</span><br><span class="line">                                .error(<span class="string">&quot;[getServiceInfo] serviceName:&quot;</span> + serviceName + <span class="string">&quot;, clusters:&quot;</span> + clusters, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 定时任务启动 定时更新本地注册表中的当前服务</span></span><br><span class="line">        scheduleUpdateIfAbsent(serviceName, clusters);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> serviceInfoMap.get(serviceObj.getKey());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们先来看 updateServiceNow(serviceName, clusters);这个方法就是调用了一个updateService方法，那直接来看updateService就好，里面就是获取本地注册表和远程注册表的服务，然后做一个合并操作，合并就是在processServiceJson(result);处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateService</span><span class="params">(String serviceName, String clusters)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">				<span class="comment">// 在本地注册表中获取当前服务 </span></span><br><span class="line">        <span class="type">ServiceInfo</span> <span class="variable">oldService</span> <span class="operator">=</span> getServiceInfo0(serviceName, clusters);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 向server发送get请求 获取服务</span></span><br><span class="line">            <span class="comment">// 返回的serviceinfo是以json串形式出现的</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> serverProxy.queryList(serviceName, clusters, pushReceiver.getUdpPort(), <span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(result)) &#123;</span><br><span class="line">								<span class="comment">// 将来自于server的serviceinfo更新到本地 </span></span><br><span class="line">                processServiceJson(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldService != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (oldService) &#123;</span><br><span class="line">                    oldService.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>分析processServiceJson(result);之前要达成一个共识，来自server的数据是一个最新的数据，其实就是合并新旧数据的过程，没什么特别的地方。至此，我们清楚了是如果请求server获取最新数据然后与本地合并了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceInfo <span class="title function_">processServiceJson</span><span class="params">(String json)</span> &#123;</span><br><span class="line">				<span class="comment">// 吧来自server的json处理为ServiceInfo</span></span><br><span class="line">        <span class="type">ServiceInfo</span> <span class="variable">serviceInfo</span> <span class="operator">=</span> JacksonUtils.toObj(json, ServiceInfo.class);</span><br><span class="line">				<span class="comment">// 本地注册表中的ServiceInfo</span></span><br><span class="line">        <span class="type">ServiceInfo</span> <span class="variable">oldService</span> <span class="operator">=</span> serviceInfoMap.get(serviceInfo.getKey());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pushEmptyProtection &amp;&amp; !serviceInfo.validate()) &#123;</span><br><span class="line">            <span class="comment">//empty or error push, just ignore</span></span><br><span class="line">            <span class="keyword">return</span> oldService;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 本地注册表中存在当前服务 </span></span><br><span class="line">        <span class="keyword">if</span> (oldService != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 为了安全起见，默认服务器的数据是最新的</span></span><br><span class="line">            <span class="keyword">if</span> (oldService.getLastRefTime() &gt; serviceInfo.getLastRefTime()) &#123;</span><br><span class="line">                NAMING_LOGGER.warn(<span class="string">&quot;out of date data received, old-t: &quot;</span> + oldService.getLastRefTime() + <span class="string">&quot;, new-t: &quot;</span></span><br><span class="line">                        + serviceInfo.getLastRefTime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 把来自service的serviceinfo替换掉本地注册表的</span></span><br><span class="line">            serviceInfoMap.put(serviceInfo.getKey(), serviceInfo);</span><br><span class="line">            </span><br><span class="line">						<span class="comment">// 遍历本地注册表服务中的所有实例</span></span><br><span class="line">            Map&lt;String, Instance&gt; oldHostMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Instance&gt;(oldService.getHosts().size());</span><br><span class="line">            <span class="keyword">for</span> (Instance host : oldService.getHosts()) &#123;</span><br><span class="line">									<span class="comment">// ip:port 作为key，instance作为value放进去</span></span><br><span class="line">                oldHostMap.put(host.toInetAddr(), host);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 遍历来自于server的服务的所有实例</span></span><br><span class="line">            Map&lt;String, Instance&gt; newHostMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Instance&gt;(serviceInfo.getHosts().size());</span><br><span class="line">            <span class="keyword">for</span> (Instance host : serviceInfo.getHosts()) &#123;</span><br><span class="line">								<span class="comment">// ip:port 作为key，instance作为value放进去</span></span><br><span class="line">                newHostMap.put(host.toInetAddr(), host);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 该set存的是两个map old 与 new 都有的client </span></span><br><span class="line">						<span class="comment">// 但他们的instance不同，会把来自server的instance写入</span></span><br><span class="line">            Set&lt;Instance&gt; modHosts = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Instance&gt;();</span><br><span class="line">						<span class="comment">// 只有newHostMap存在的intstance，也就是新增的</span></span><br><span class="line">            Set&lt;Instance&gt; newHosts = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Instance&gt;();</span><br><span class="line">						<span class="comment">// 只有oldHostMap有，也就是server端没有的instance</span></span><br><span class="line">            Set&lt;Instance&gt; remvHosts = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Instance&gt;();</span><br><span class="line">            <span class="comment">// 遍历来自server的</span></span><br><span class="line">            List&lt;Map.Entry&lt;String, Instance&gt;&gt; newServiceHosts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Map.Entry&lt;String, Instance&gt;&gt;(</span><br><span class="line">                    newHostMap.entrySet());</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Instance&gt; entry : newServiceHosts) &#123;</span><br><span class="line">                <span class="type">Instance</span> <span class="variable">host</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">								<span class="comment">// 本地注册表中也有这个 ip:port 但是两个instance不同，就放入modMap</span></span><br><span class="line">                <span class="keyword">if</span> (oldHostMap.containsKey(key) &amp;&amp; !StringUtils</span><br><span class="line">                        .equals(host.toString(), oldHostMap.get(key).toString())) &#123;</span><br><span class="line">                    modHosts.add(host);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 注册表中不存在这个ip:prot 那就写入到newMap 说明这个主机是新增的</span></span><br><span class="line">                <span class="keyword">if</span> (!oldHostMap.containsKey(key)) &#123;</span><br><span class="line">                    newHosts.add(host);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 遍历本地注册表中服务的instane</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Instance&gt; entry : oldHostMap.entrySet()) &#123;</span><br><span class="line">                <span class="type">Instance</span> <span class="variable">host</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (newHostMap.containsKey(key)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 注册表中存在  但是来自server的serviceInfo不存在</span></span><br><span class="line">                <span class="keyword">if</span> (!newHostMap.containsKey(key)) &#123;</span><br><span class="line">										<span class="comment">// 加入到remvMap</span></span><br><span class="line">                    remvHosts.add(host);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 新增了 log</span></span><br><span class="line">            <span class="keyword">if</span> (newHosts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                changed = <span class="literal">true</span>;</span><br><span class="line">                NAMING_LOGGER.info(<span class="string">&quot;new ips(&quot;</span> + newHosts.size() + <span class="string">&quot;) service: &quot;</span> + serviceInfo.getKey() + <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">                        + JacksonUtils.toJson(newHosts));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 删除了 log</span></span><br><span class="line">            <span class="keyword">if</span> (remvHosts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                changed = <span class="literal">true</span>;</span><br><span class="line">                NAMING_LOGGER.info(<span class="string">&quot;removed ips(&quot;</span> + remvHosts.size() + <span class="string">&quot;) service: &quot;</span> + serviceInfo.getKey() + <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">                        + JacksonUtils.toJson(remvHosts));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 发生变更了 </span></span><br><span class="line">            <span class="keyword">if</span> (modHosts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                changed = <span class="literal">true</span>;</span><br><span class="line">								<span class="comment">// 变更心跳 instance改了 心跳也要改才行</span></span><br><span class="line">                updateBeatInfo(modHosts);</span><br><span class="line">                NAMING_LOGGER.info(<span class="string">&quot;modified ips(&quot;</span> + modHosts.size() + <span class="string">&quot;) service: &quot;</span> + serviceInfo.getKey() + <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">                        + JacksonUtils.toJson(modHosts));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            serviceInfo.setJsonFromServer(json);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (newHosts.size() &gt; <span class="number">0</span> || remvHosts.size() &gt; <span class="number">0</span> || modHosts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">								<span class="comment">// 只要发生了变更，就把发生变更的serviceInfo记录到缓存队列中</span></span><br><span class="line">                NotifyCenter.publishEvent(<span class="keyword">new</span> <span class="title class_">InstancesChangeEvent</span>(serviceInfo.getName(), serviceInfo.getGroupName(),</span><br><span class="line">                        serviceInfo.getClusters(), serviceInfo.getHosts()));</span><br><span class="line">                DiskCache.write(serviceInfo, cacheDir);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果本地注册表中没有本服务直接写入</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            changed = <span class="literal">true</span>;</span><br><span class="line">            NAMING_LOGGER.info(<span class="string">&quot;init new ips(&quot;</span> + serviceInfo.ipCount() + <span class="string">&quot;) service: &quot;</span> + serviceInfo.getKey() + <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">                    + JacksonUtils.toJson(serviceInfo.getHosts()));</span><br><span class="line">						<span class="comment">// 将来自server的serviceInfo记录到注册表</span></span><br><span class="line">            serviceInfoMap.put(serviceInfo.getKey(), serviceInfo);</span><br><span class="line">            NotifyCenter.publishEvent(<span class="keyword">new</span> <span class="title class_">InstancesChangeEvent</span>(serviceInfo.getName(), serviceInfo.getGroupName(),</span><br><span class="line">                    serviceInfo.getClusters(), serviceInfo.getHosts()));</span><br><span class="line">	           </span><br><span class="line">					  serviceInfo.setJsonFromServer(json);</span><br><span class="line">            DiskCache.write(serviceInfo, cacheDir);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        MetricsMonitor.getServiceInfoMapSizeMonitor().set(serviceInfoMap.size());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            NAMING_LOGGER.info(<span class="string">&quot;current ips:(&quot;</span> + serviceInfo.ipCount() + <span class="string">&quot;) service: &quot;</span> + serviceInfo.getKey() + <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">                    + JacksonUtils.toJson(serviceInfo.getHosts()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> serviceInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们把视线回到上面的  scheduleUpdateIfAbsent(serviceName, clusters);这是一个定时更新本地数据的任务，我们进入方法内部，主要的工作就是创建一个异步对象放入map中，注意这里是DCL，然后启动任务。要想知道这个异步任务到底是做什么的，必须看一下UpdateTask这个类的run()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleUpdateIfAbsent</span><span class="params">(String serviceName, String clusters)</span> &#123;</span><br><span class="line">				<span class="comment">// 这是个缓存map key为groupid@@微服务名@@cluster</span></span><br><span class="line">				<span class="comment">// value 是个定时异步操作对象 </span></span><br><span class="line">				<span class="comment">// private final Map&lt;String, ScheduledFuture&lt;?&gt;&gt; futureMap = new HashMap&lt;String, ScheduledFuture&lt;?&gt;&gt;();</span></span><br><span class="line">				<span class="comment">// 如果有这个异步对象 就返回</span></span><br><span class="line">				<span class="comment">// 这种结构称为DCL 防止并发情况下重复写入</span></span><br><span class="line">        <span class="keyword">if</span> (futureMap.get(ServiceInfo.getKey(serviceName, clusters)) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (futureMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (futureMap.get(ServiceInfo.getKey(serviceName, clusters)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建一个定时异步对象</span></span><br><span class="line">            ScheduledFuture&lt;?&gt; future = addTask(<span class="keyword">new</span> <span class="title class_">UpdateTask</span>(serviceName, clusters));</span><br><span class="line">						<span class="comment">// 把这个定时异步任务放入缓存map</span></span><br><span class="line">            futureMap.put(ServiceInfo.getKey(serviceName, clusters), future);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>run方法的分析如下，就是更新注册表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">delayTime</span> <span class="operator">=</span> DEFAULT_DELAY;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// 在本地注册表获取当前服务</span></span><br><span class="line">                <span class="type">ServiceInfo</span> <span class="variable">serviceObj</span> <span class="operator">=</span> serviceInfoMap.get(ServiceInfo.getKey(serviceName, clusters));</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (serviceObj == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 本地不存在这个服务，从server拉取并更新到本地</span></span><br><span class="line">                    updateService(serviceName, clusters);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理本地注册表粗存在当前服务的情况</span></span><br><span class="line">				<span class="comment">// lastRefTime 当前instanc最后被访问的时间</span></span><br><span class="line">                <span class="comment">// serviceObj.getLastRefTime() 当前服务最后被访问的时间 来源于这个服务里面的所有</span></span><br><span class="line">                <span class="comment">// 实例中最晚被访问的时间</span></span><br><span class="line">                <span class="keyword">if</span> (serviceObj.getLastRefTime() &lt;= lastRefTime) &#123;</span><br><span class="line">                    <span class="comment">//  当前注册表需要更新了</span></span><br><span class="line">                    updateService(serviceName, clusters);</span><br><span class="line">                    serviceObj = serviceInfoMap.get(ServiceInfo.getKey(serviceName, clusters));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// if serviceName already updated by push, we should not override it</span></span><br><span class="line">                    <span class="comment">// since the push data may be different from pull through force push</span></span><br><span class="line">                    refreshOnly(serviceName, clusters);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将来自注册表的这个最后访问时间更新到当前client缓存中</span></span><br><span class="line">                lastRefTime = serviceObj.getLastRefTime();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!notifier.isSubscribed(serviceName, clusters) &amp;&amp; !futureMap</span><br><span class="line">                        .containsKey(ServiceInfo.getKey(serviceName, clusters))) &#123;</span><br><span class="line">                    <span class="comment">// abort the update task</span></span><br><span class="line">                    NAMING_LOGGER.info(<span class="string">&quot;update task is stopped, service:&quot;</span> + serviceName + <span class="string">&quot;, clusters:&quot;</span> + clusters);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isEmpty(serviceObj.getHosts())) &#123;</span><br><span class="line">                    incFailCount();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                delayTime = serviceObj.getCacheMillis();</span><br><span class="line">                resetFailCount();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                incFailCount();</span><br><span class="line">                NAMING_LOGGER.warn(<span class="string">&quot;[NA] failed to update serviceName: &quot;</span> + serviceName, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 开始下一次定时更新任务就好了 循环执行</span></span><br><span class="line">                executor.schedule(<span class="built_in">this</span>, Math.min(delayTime &lt;&lt; failCount, DEFAULT_DELAY * <span class="number">60</span>), TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Nacos定时更新本地服务的就是以上流程，我们可以用一张流程图来概括这整个步骤：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203210117403.png" alt="Nacos Client定时更新本地服务(1)"></p>
<h4 id="Nacos-Client获取要调用的服务的提供者列表"><a href="#Nacos-Client获取要调用的服务的提供者列表" class="headerlink" title="Nacos Client获取要调用的服务的提供者列表"></a>Nacos Client获取要调用的服务的提供者列表</h4><p>首先说结论，客户端是需要调用的时候才懒加载进来服务提供者信息。客户端是基于Ribbon负载均衡来做的，我们进入Ribbon的配置类，关键点就是这个ZoneAwareLoadBalancer类，这是在调用的时候才会创建的一个配置类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> ILoadBalancer <span class="title function_">ribbonLoadBalancer</span><span class="params">(IClientConfig config,</span></span><br><span class="line"><span class="params">			ServerList&lt;Server&gt; serverList, ServerListFilter&lt;Server&gt; serverListFilter,</span></span><br><span class="line"><span class="params">			IRule rule, IPing ping, ServerListUpdater serverListUpdater)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.propertiesFactory.isSet(ILoadBalancer.class, name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.propertiesFactory.get(ILoadBalancer.class, config, name);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 只有服务真正发生调用的时候才会创建这个类</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ZoneAwareLoadBalancer</span>&lt;&gt;(config, rule, ping, serverList,</span><br><span class="line">				serverListFilter, serverListUpdater);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>现在进入这个ZoneAwareLoadBalancer， 前面都是一些初始化赋值操作，后面的restOfInit(clientConfig)才是配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DynamicServerListLoadBalancer</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping,</span></span><br><span class="line"><span class="params">                                         ServerList&lt;T&gt; serverList, ServerListFilter&lt;T&gt; filter,</span></span><br><span class="line"><span class="params">                                         ServerListUpdater serverListUpdater)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(clientConfig, rule, ping);</span><br><span class="line">        <span class="built_in">this</span>.serverListImpl = serverList;</span><br><span class="line">        <span class="built_in">this</span>.filter = filter;</span><br><span class="line">        <span class="built_in">this</span>.serverListUpdater = serverListUpdater;</span><br><span class="line">        <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> AbstractServerListFilter) &#123;</span><br><span class="line">            ((AbstractServerListFilter) filter).setLoadBalancerStats(getLoadBalancerStats());</span><br><span class="line">        &#125;</span><br><span class="line">        restOfInit(clientConfig);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>进入 restOfInit(clientConfig)，过滤掉不重要东西，然后我们可以观察到 updateListOfServers(); 根据方法名字我们就可以推断出来，这就是一个获取服务提供者列表的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">restOfInit</span><span class="params">(IClientConfig clientConfig)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">primeConnection</span> <span class="operator">=</span> <span class="built_in">this</span>.isEnablePrimingConnections();</span><br><span class="line">    <span class="comment">// turn this off to avoid duplicated asynchronous priming done in BaseLoadBalancer.setServerList()</span></span><br><span class="line">    <span class="built_in">this</span>.setEnablePrimingConnections(<span class="literal">false</span>);</span><br><span class="line">    enableAndInitLearnNewServersFeature();</span><br><span class="line"></span><br><span class="line">    updateListOfServers();</span><br><span class="line">    <span class="keyword">if</span> (primeConnection &amp;&amp; <span class="built_in">this</span>.getPrimeConnections() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getPrimeConnections()</span><br><span class="line">                .primeConnections(getReachableServers());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.setEnablePrimingConnections(primeConnection);</span><br><span class="line">    LOGGER.info(<span class="string">&quot;DynamicServerListLoadBalancer for client &#123;&#125; initialized: &#123;&#125;&quot;</span>, clientConfig.getClientName(), <span class="built_in">this</span>.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进去，发现获取服务列表的是serverListImpl.getUpdatedListOfServers();这里。这其实是loadBlancer接口，里面定义了 获取服务的方法，我们如果要获取服务实例，都是要继承这个接口的，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateListOfServers</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;T&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;();</span><br><span class="line">    <span class="keyword">if</span> (serverListImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">        servers = serverListImpl.getUpdatedListOfServers();</span><br><span class="line">        LOGGER.debug(<span class="string">&quot;List of Servers for &#123;&#125; obtained from Discovery client: &#123;&#125;&quot;</span>,</span><br><span class="line">                getIdentifier(), servers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filter != <span class="literal">null</span>) &#123;</span><br><span class="line">            servers = filter.getFilteredListOfServers(servers);</span><br><span class="line">            LOGGER.debug(<span class="string">&quot;Filtered List of Servers for &#123;&#125; obtained from Discovery client: &#123;&#125;&quot;</span>,</span><br><span class="line">                    getIdentifier(), servers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    updateAllServerList(servers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看一下哪些类实现了这个接口，很明显Nacos也实现了这个方法，那么我们就直接进去看看nacos具体如何做的。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203211156633.png" alt="image-20220321115627566"></p>
<p>进入Nacos实现的这个方法内部，可以看到关键方法就是根据服务ID获取服务实例的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;NacosServer&gt; <span class="title function_">getServers</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> discoveryProperties.getGroup();</span><br><span class="line">            <span class="comment">// 根据服务ID获取服务实例</span></span><br><span class="line">			List&lt;Instance&gt; instances = discoveryProperties.namingServiceInstance()</span><br><span class="line">					.selectInstances(serviceId, group, <span class="literal">true</span>);</span><br><span class="line">			<span class="keyword">return</span> instancesToServerList(instances);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">					<span class="string">&quot;Can not get service instances from nacos, serviceId=&quot;</span> + serviceId,</span><br><span class="line">					e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后进入方法内部，做的事情就是获取订阅的服务，然后根据返回的instance过滤出来可用的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> List&lt;Instance&gt; <span class="title function_">selectInstances</span><span class="params">(String serviceName, String groupName, List&lt;String&gt; clusters, <span class="type">boolean</span> healthy,</span></span><br><span class="line"><span class="params">           <span class="type">boolean</span> subscribe)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">       </span><br><span class="line">       ServiceInfo serviceInfo;</span><br><span class="line">       <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">           <span class="comment">// 获取到要调用服务的serviceinfo</span></span><br><span class="line">           serviceInfo = hostReactor.getServiceInfo(NamingUtils.getGroupedName(serviceName, groupName),</span><br><span class="line">                   StringUtils.join(clusters, <span class="string">&quot;,&quot;</span>));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           serviceInfo = hostReactor</span><br><span class="line">                   .getServiceInfoDirectlyFromServer(NamingUtils.getGroupedName(serviceName, groupName),</span><br><span class="line">                           StringUtils.join(clusters, <span class="string">&quot;,&quot;</span>));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 从所有服务列表中过滤出来可用的</span></span><br><span class="line">       <span class="keyword">return</span> selectInstances(serviceInfo, healthy);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>然后进入具体的获取方法，我们之前已经解读过了，不再赘述。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceInfo <span class="title function_">getServiceInfo</span><span class="params">(<span class="keyword">final</span> String serviceName, <span class="keyword">final</span> String clusters)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        NAMING_LOGGER.debug(<span class="string">&quot;failover-mode: &quot;</span> + failoverReactor.isFailoverSwitch());</span><br><span class="line">				<span class="comment">// 构建key 请求格式为 groupId@@微服务ID@@cluster名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> ServiceInfo.getKey(serviceName, clusters);</span><br><span class="line">        <span class="keyword">if</span> (failoverReactor.isFailoverSwitch()) &#123;</span><br><span class="line">            <span class="keyword">return</span> failoverReactor.getService(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从当前client本地注册表中获取当前服务 本地注册表是个map </span></span><br><span class="line">				<span class="comment">// key -&gt; groupId@@微服务ID@@cluster名称 value -&gt; serviceinfo</span></span><br><span class="line">        <span class="type">ServiceInfo</span> <span class="variable">serviceObj</span> <span class="operator">=</span> getServiceInfo0(serviceName, clusters);</span><br><span class="line">        <span class="comment">// 如果为空 （第一次启动肯定是空的）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == serviceObj) &#123;</span><br><span class="line">						<span class="comment">// 创建个空的服务 没有任何提供者实例</span></span><br><span class="line">            serviceObj = <span class="keyword">new</span> <span class="title class_">ServiceInfo</span>(serviceName, clusters);</span><br><span class="line">            <span class="comment">// 放入注册表</span></span><br><span class="line">            serviceInfoMap.put(serviceObj.getKey(), serviceObj);</span><br><span class="line">            <span class="comment">// 临时缓存 主要是使用这个缓存的key 不能重复 </span></span><br><span class="line">						<span class="comment">// 只要服务名称出现在这个缓存map中，就表示这个服务正在被更新</span></span><br><span class="line">            updatingMap.put(serviceName, <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">						<span class="comment">// 开始更新服务</span></span><br><span class="line">            updateServiceNow(serviceName, clusters);</span><br><span class="line">						<span class="comment">// 更新完了 删掉</span></span><br><span class="line">            updatingMap.remove(serviceName);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (updatingMap.containsKey(serviceName)) &#123;</span><br><span class="line">						<span class="comment">// 如果注册表中有了这个服务 而且临时缓存中有了这个服务</span></span><br><span class="line">            <span class="comment">// 那这个服务就是正在被更新 那就等一会儿</span></span><br><span class="line">            <span class="keyword">if</span> (UPDATE_HOLD_INTERVAL &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// hold a moment waiting for update finish</span></span><br><span class="line">                <span class="keyword">synchronized</span> (serviceObj) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        serviceObj.wait(UPDATE_HOLD_INTERVAL);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        NAMING_LOGGER</span><br><span class="line">                                .error(<span class="string">&quot;[getServiceInfo] serviceName:&quot;</span> + serviceName + <span class="string">&quot;, clusters:&quot;</span> + clusters, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 定时任务启动 定时更新本地注册表中的当前服务</span></span><br><span class="line">        scheduleUpdateIfAbsent(serviceName, clusters);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> serviceInfoMap.get(serviceObj.getKey());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>现在我们看一下过来出来可用服务是如何做的，一句话就是过滤不健康的不可用的权重小于0的服务，返回正常的服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Instance&gt; <span class="title function_">selectInstances</span><span class="params">(ServiceInfo serviceInfo, <span class="type">boolean</span> healthy)</span> &#123;</span><br><span class="line">    List&lt;Instance&gt; list;</span><br><span class="line">    <span class="keyword">if</span> (serviceInfo == <span class="literal">null</span> || CollectionUtils.isEmpty(list = serviceInfo.getHosts())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Instance&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 迭代这个服务的所有instance</span></span><br><span class="line">    Iterator&lt;Instance&gt; iterator = list.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="comment">// 服务非健康的 非可用 权重&lt;=0，从列表中去除</span></span><br><span class="line">        <span class="keyword">if</span> (healthy != instance.isHealthy() || !instance.isEnabled() || instance.getWeight() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            iterator.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回可用instance列表</span></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Nacos-Server源码分析"><a href="#Nacos-Server源码分析" class="headerlink" title="Nacos Server源码分析"></a>Nacos Server源码分析</h3><h4 id="重要API介绍"><a href="#重要API介绍" class="headerlink" title="重要API介绍"></a>重要API介绍</h4><ol>
<li><p>InstanceController 处理客户端请求例如订阅 心跳</p>
</li>
<li><p>Service 代表了一个服务 （Service of Nacos server side） 引入了一个Service Cluster Instance模型，也就是一个实例集合，类似客户端的ServiceInfo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3470985546826874460L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * service name.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * protect threshold.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 保护阈值 默认是0.8</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">protectThreshold</span> <span class="operator">=</span> <span class="number">0.0F</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * application name of this service.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String appName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group to classify services into different sets.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; metadata = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>RecordListener 数据监听接口 实现了这个接口Service就是一个监听器 范型指定正在监听的数据类型 Record instance也是继承了这个，所以 RecordListener 监听的各个实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RecordListener</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Record</span>&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the listener was registered with this key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key candidate key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the listener was registered with this key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 判断监听器是否监听了这个key</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">interests</span><span class="params">(String key)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the listener is to be removed by matching the &#x27;key&#x27;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key to match</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if match success</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 判断监听器是否已经移除了这个key</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">matchUnlistenKey</span><span class="params">(String key)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Action to do if data of target key has changed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   target key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value data of the key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// key变化触发这个方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(String key, T value)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Action to do if data of target key has been removed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key target key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 指定key的数据被删除 触发这个方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDelete</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Record Nacos集群中传递的记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Record</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get the checksum of this record, usually for record comparison.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> checksum of record</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getChecksum</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>ServiceManager 是RecordListener<Intance>的实现类 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceManager</span> <span class="keyword">implements</span> <span class="title class_">RecordListener</span>&lt;Service&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Map(namespace, Map(group::serviceName, Service)).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 就是注册表了 外层是namespace 内层map key-&gt;serviceId value-&gt;service对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, Service&gt;&gt; serviceMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">	<span class="comment">// 来自于其他nacos变更数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingDeque&lt;ServiceKey&gt; toBeUpdatedServicesQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">	<span class="comment">// 同步器 service状态同步器 nacos集群同步用的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Synchronizer</span> <span class="variable">synchronizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceStatusSynchronizer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">	<span class="comment">// 一致性服务 基于raft数据同步的</span></span><br><span class="line">    <span class="meta">@Resource(name = &quot;consistencyDelegate&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ConsistencyService consistencyService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SwitchDomain switchDomain;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistroMapper distroMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerMemberManager memberManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PushService pushService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RaftPeerSet raftPeerSet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxFinalizeCount</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">putServiceLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;nacos.naming.empty-service.auto-clean:false&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> emptyServiceAutoClean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;nacos.naming.empty-service.clean.initial-delay-ms:60000&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> cleanEmptyServiceDelay;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;nacos.naming.empty-service.clean.period-time-ms:20000&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> cleanEmptyServicePeriod;</span><br><span class="line">    	&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>Cluster 集群的实现，里面有两个集合为临时实例集合和持久实例集合，然后它属于一个Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cluster</span> <span class="keyword">extends</span> <span class="title class_">com</span>.alibaba.nacos.api.naming.pojo.Cluster <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLUSTER_NAME_SYNTAX</span> <span class="operator">=</span> <span class="string">&quot;[0-9a-zA-Z-]+&quot;</span>;</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8940123791150907510L</span>;</span><br><span class="line">   </span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * a addition for same site routing, can group multiple sites into a region, like Hangzhou, Shanghai, etc.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">private</span> <span class="type">String</span> <span class="variable">sitegroup</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">private</span> <span class="type">int</span> <span class="variable">defCkport</span> <span class="operator">=</span> <span class="number">80</span>;</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">private</span> <span class="type">int</span> <span class="variable">defIpPort</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">   </span><br><span class="line">      <span class="meta">@JsonIgnore</span></span><br><span class="line">      <span class="keyword">private</span> HealthCheckTask checkTask;</span><br><span class="line"><span class="comment">// 持久实例集合</span></span><br><span class="line">      <span class="meta">@JsonIgnore</span></span><br><span class="line">      <span class="keyword">private</span> Set&lt;Instance&gt; persistentInstances = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// 临时实例集合</span></span><br><span class="line">      <span class="meta">@JsonIgnore</span></span><br><span class="line">      <span class="keyword">private</span> Set&lt;Instance&gt; ephemeralInstances = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">      <span class="meta">@JsonIgnore</span></span><br><span class="line">      <span class="keyword">private</span> Service service;</span><br><span class="line">   </span><br><span class="line">      <span class="meta">@JsonIgnore</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">inited</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">private</span> Map&lt;String, String&gt; metadata = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>Instance</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Instance</span> <span class="keyword">extends</span> <span class="title class_">com</span>.alibaba.nacos.api.naming.pojo.Instance <span class="keyword">implements</span> <span class="title class_">Comparable</span> &#123;</span><br><span class="line">    </span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">MAX_WEIGHT_VALUE</span> <span class="operator">=</span> <span class="number">10000.0D</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">MIN_POSITIVE_WEIGHT_VALUE</span> <span class="operator">=</span> <span class="number">0.01D</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">MIN_WEIGHT_VALUE</span> <span class="operator">=</span> <span class="number">0.00D</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6527721638428975306L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">lastBeat</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@JsonIgnore</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">mockValid</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="comment">// 不健康状态的标记 为true的时候就表示实例为不健康 当前实例被标记</span></span><br><span class="line">    	<span class="comment">// 对于临时实例，永久为false 即该属性对临时实例没有意义</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">marked</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String tenant;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String app;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">ONLY_DIGIT_AND_DOT</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(\\d|\\.)+&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPLITER</span> <span class="operator">=</span> <span class="string">&quot;_&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Server-处理client注册请求"><a href="#Server-处理client注册请求" class="headerlink" title="Server 处理client注册请求"></a>Server 处理client注册请求</h4><p>InstanceController就是处理和实例相关的信息，我们定位到这个类直接根据方法名找到对应方法就可以阅读源码了。直接定为到register方法，这里就是处理client注册请求的地方。具体做的事情：</p>
<ol>
<li>解析参数</li>
<li>通过请求参数组装instance</li>
<li>把instance写入注册表</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@CanDistro</span></span><br><span class="line"> <span class="meta">@PostMapping</span></span><br><span class="line"> <span class="meta">@Secured(parser = NamingResourceParser.class, action = ActionTypes.WRITE)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">final</span> <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> WebUtils</span><br><span class="line">             .optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">     <span class="comment">// 请求中不包含servicname 报错</span></span><br><span class="line">     <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line"><span class="comment">// 合法检验</span></span><br><span class="line">     NamingUtils.checkServiceNameFormat(serviceName);</span><br><span class="line">     <span class="comment">// 通过请求参数组装instance</span></span><br><span class="line">     <span class="keyword">final</span> <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> parseInstance(request);</span><br><span class="line">     <span class="comment">// 把instance写入注册表</span></span><br><span class="line">     serviceManager.registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们先来看如何通过请求参数组装一个instance，其实还是在加工上层方法传递过来的请求属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Instance <span class="title function_">parseInstance</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">        <span class="type">String</span> <span class="variable">app</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;app&quot;</span>, <span class="string">&quot;DEFAULT&quot;</span>);</span><br><span class="line">    	<span class="comment">// 通过请求中的各种属性值构建一个instance</span></span><br><span class="line">        <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> getIpAddress(request);</span><br><span class="line">        instance.setApp(app);</span><br><span class="line">        instance.setServiceName(serviceName);</span><br><span class="line">        <span class="comment">// Generate simple instance id first. This value would be updated according to</span></span><br><span class="line">        <span class="comment">// INSTANCE_ID_GENERATOR.</span></span><br><span class="line">        instance.setInstanceId(instance.generateInstanceId());</span><br><span class="line">        instance.setLastBeat(System.currentTimeMillis());</span><br><span class="line">        <span class="type">String</span> <span class="variable">metadata</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;metadata&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(metadata)) &#123;</span><br><span class="line">            instance.setMetadata(UtilsAndCommons.parseMetadata(metadata));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// instance验证合法检验 具体就是IP是否合法 权重是否为有效范围内</span></span><br><span class="line">        instance.validate();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再来看到底是怎么把instance注册到注册表中，这里是ServiceManager来管理的，上面提到这个类就是专门来管理服务注册之类的事情，进入registerInstance方法中，看它是怎么做的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerInstance</span><span class="params">(String namespaceId, String serviceName, Instance instance)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        <span class="comment">// 如果没有service 就创建一个service 然后配置一些信息放入注册表 </span></span><br><span class="line">        createEmptyService(namespaceId, serviceName, instance.isEphemeral());</span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>(NacosException.INVALID_PARAM,</span><br><span class="line">                    <span class="string">&quot;service not found, namespace: &quot;</span> + namespaceId + <span class="string">&quot;, service: &quot;</span> + serviceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把instance写入到service</span></span><br><span class="line">        addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>首先看 createEmptyService(namespaceId, serviceName, instance.isEphemeral())，他最终调用的是createServiceIfAbsent方法，进入这个方法内部看看，其实就是如果在注册表中获取不到service，就创建一个，然后进行赋值，前面的其实都很清楚，关键是要看看 putServiceAndInit(service);是做了什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createServiceIfAbsent</span><span class="params">(String namespaceId, String serviceName, <span class="type">boolean</span> local, Cluster cluster)</span></span><br><span class="line">            <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        <span class="comment">// 拿到一个service 如果没有就new 一个</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            Loggers.SRV_LOG.info(<span class="string">&quot;creating empty service &#123;&#125;:&#123;&#125;&quot;</span>, namespaceId, serviceName);</span><br><span class="line">            service = <span class="keyword">new</span> <span class="title class_">Service</span>();</span><br><span class="line">            <span class="comment">// 属性赋值</span></span><br><span class="line">            service.setName(serviceName);</span><br><span class="line">            service.setNamespaceId(namespaceId);</span><br><span class="line">            service.setGroupName(NamingUtils.getGroupName(serviceName));</span><br><span class="line">            <span class="comment">// now validate the service. if failed, exception will be thrown</span></span><br><span class="line">            service.setLastModifiedMillis(System.currentTimeMillis());</span><br><span class="line">            <span class="comment">// 重新计算校验和</span></span><br><span class="line">            service.recalculateChecksum();</span><br><span class="line">            <span class="keyword">if</span> (cluster != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 和cluster建立联系</span></span><br><span class="line">                cluster.setService(service);</span><br><span class="line">                service.getClusterMap().put(cluster.getName(), cluster);</span><br><span class="line">            &#125;</span><br><span class="line">            service.validate();</span><br><span class="line">            <span class="comment">// 做了一些初始化</span></span><br><span class="line">            putServiceAndInit(service);</span><br><span class="line">            <span class="keyword">if</span> (!local) &#123;</span><br><span class="line">                <span class="comment">// 对持久化服务加一个同步任务</span></span><br><span class="line">                addOrReplaceService(service);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>来到 putServiceAndInit(service);方法内部，做的事情就是写入注册表，开始心跳检测。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">putServiceAndInit</span><span class="params">(Service service)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">       <span class="comment">// 把service写入注册表 DCL写法 </span></span><br><span class="line">       putService(service);</span><br><span class="line">       service = getService(service.getNamespaceId(), service.getName());</span><br><span class="line">       <span class="comment">// 内部健康检测任务 定期清除过期instance 当前service所有的cluster所有的健康检查任务开启</span></span><br><span class="line">       service.init();</span><br><span class="line">    	<span class="comment">// 给nacos的持久实例 临时实例添加监听</span></span><br><span class="line">       consistencyService</span><br><span class="line">               .listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="literal">true</span>), service);</span><br><span class="line">       consistencyService</span><br><span class="line">               .listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="literal">false</span>), service);</span><br><span class="line">       Loggers.SRV_LOG.info(<span class="string">&quot;[NEW-SERVICE] &#123;&#125;&quot;</span>, service.toJson());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>至此，createEmptyService(namespaceId, serviceName, instance.isEphemeral());方法说完了，然后开始第二步把instance写入到service，也就是addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);方法。进入这个方法内部，做的事情就是修改service的instance列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInstance</span><span class="params">(String namespaceId, String serviceName, <span class="type">boolean</span> ephemeral, Instance... ips)</span></span><br><span class="line">            <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        <span class="comment">// ephemeral 默认是true 是否为临时实例 -&gt; 实例是否持久化 -&gt; AP or CP</span></span><br><span class="line">        <span class="comment">//com.alibaba.nacos.naming.ephemeral.namespaceId##serviceName</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> KeyBuilder.buildInstanceListKey(namespaceId, serviceName, ephemeral);</span><br><span class="line">        <span class="comment">// 从注册表获取service</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line">		<span class="comment">// 将要注册的instance写入到service中 也就是写入到注册表	</span></span><br><span class="line">        <span class="keyword">synchronized</span> (service) &#123;</span><br><span class="line">            <span class="comment">// 修改当前service的instance列表，这个修改是两者，一是添加二是删除</span></span><br><span class="line">            List&lt;Instance&gt; instanceList = addIpAddresses(service, ephemeral, ips);</span><br><span class="line">            <span class="type">Instances</span> <span class="variable">instances</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Instances</span>();</span><br><span class="line">            instances.setInstanceList(instanceList);</span><br><span class="line">            consistencyService.put(key, instances);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>进入addIpAddresses(service, ephemeral, ips)方法，看看更新service的instance列表是怎么做的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Instance&gt; <span class="title function_">updateIpAddresses</span><span class="params">(Service service, String action, <span class="type">boolean</span> ephemeral, Instance... ips)</span></span><br><span class="line">            <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">		<span class="comment">// 从其他nacos获取当前服务数据 临时实例</span></span><br><span class="line">        <span class="type">Datum</span> <span class="variable">datum</span> <span class="operator">=</span> consistencyService</span><br><span class="line">                .get(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), ephemeral));</span><br><span class="line">		<span class="comment">// 获取本地注册表中当前服务的所有临时实例</span></span><br><span class="line">        List&lt;Instance&gt; currentIPs = service.allIPs(ephemeral);</span><br><span class="line">        Map&lt;String, Instance&gt; currentInstances = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(currentIPs.size());</span><br><span class="line">        Set&lt;String&gt; currentInstanceIds = Sets.newHashSet();</span><br><span class="line">		<span class="comment">// 遍历注册表中所有实例 </span></span><br><span class="line">        <span class="keyword">for</span> (Instance instance : currentIPs) &#123;</span><br><span class="line">            <span class="comment">// ip:port -&gt; instance 写入到map中</span></span><br><span class="line">            currentInstances.put(instance.toIpAddr(), instance);</span><br><span class="line">            <span class="comment">// 把实例id写入到set中</span></span><br><span class="line">            currentInstanceIds.add(instance.getInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Instance&gt; instanceMap;</span><br><span class="line">    	<span class="comment">// 外来的数据不为空</span></span><br><span class="line">        <span class="keyword">if</span> (datum != <span class="literal">null</span> &amp;&amp; <span class="literal">null</span> != datum.value) &#123;</span><br><span class="line">            <span class="comment">// 参数为外来的instances 和 本地currentInstances map</span></span><br><span class="line">            <span class="comment">// 做的事情大概就是把本地map的instance数据替换掉外来数据中相同主机（ip+port）的instance数据</span></span><br><span class="line">            instanceMap = setValid(((Instances) datum.value).getInstanceList(), currentInstances);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            instanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(ips.length);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 遍历注册的实例</span></span><br><span class="line">        <span class="keyword">for</span> (Instance instance : ips) &#123;</span><br><span class="line">            <span class="comment">// 如果当前service不包含这个instance的cluster那就创建一个</span></span><br><span class="line">            <span class="keyword">if</span> (!service.getClusterMap().containsKey(instance.getClusterName())) &#123;</span><br><span class="line">                <span class="type">Cluster</span> <span class="variable">cluster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cluster</span>(instance.getClusterName(), service);</span><br><span class="line">                <span class="comment">// cluster初始化的健康检测任务</span></span><br><span class="line">                cluster.init();</span><br><span class="line">                service.getClusterMap().put(instance.getClusterName(), cluster);</span><br><span class="line">                Loggers.SRV_LOG</span><br><span class="line">                        .warn(<span class="string">&quot;cluster: &#123;&#125; not found, ip: &#123;&#125;, will create new cluster with default configuration.&quot;</span>,</span><br><span class="line">                                instance.getClusterName(), instance.toJson());</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 是删除操作吗？</span></span><br><span class="line">            <span class="keyword">if</span> (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) &#123;</span><br><span class="line">                instanceMap.remove(instance.getDatumKey());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 添加操作 </span></span><br><span class="line">                <span class="comment">// 把当前instance添加到外来的和本地数据综合之后的map中 也就是最新数据</span></span><br><span class="line">                <span class="type">Instance</span> <span class="variable">oldInstance</span> <span class="operator">=</span> instanceMap.get(instance.getDatumKey());</span><br><span class="line">                <span class="keyword">if</span> (oldInstance != <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance.setInstanceId(oldInstance.getInstanceId());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));</span><br><span class="line">                &#125;</span><br><span class="line">                instanceMap.put(instance.getDatumKey(), instance);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instanceMap.size() &lt;= <span class="number">0</span> &amp;&amp; UtilsAndCommons.UPDATE_INSTANCE_ACTION_ADD.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                    <span class="string">&quot;ip list can not be empty, service: &quot;</span> + service.getName() + <span class="string">&quot;, ip list: &quot;</span> + JacksonUtils</span><br><span class="line">                            .toJson(instanceMap.values()));</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 返回 最新数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;(instanceMap.values());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>回到addInstance()方法，然后看最后两步，经过上面操作，我们获得了含有本地service信息，其他nacos服务传递过来的service信息合并后的最新的instance，再加上我们注册的instance的一个List</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInstance</span><span class="params">(String namespaceId, String serviceName, <span class="type">boolean</span> ephemeral, Instance... ips)</span></span><br><span class="line">            <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        <span class="comment">// ephemeral 默认是true 是否为临时实例 -&gt; 实例是否持久化 -&gt; AP or CP</span></span><br><span class="line">        <span class="comment">//com.alibaba.nacos.naming.ephemeral.namespaceId##serviceName</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> KeyBuilder.buildInstanceListKey(namespaceId, serviceName, ephemeral);</span><br><span class="line">        <span class="comment">// 从注册表获取service</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line">		<span class="comment">// 将要注册的instance写入到service中 也就是写入到注册表	</span></span><br><span class="line">        <span class="keyword">synchronized</span> (service) &#123;</span><br><span class="line">            <span class="comment">// 修改当前service的instance列表，这个修改是两者，一是添加二是删除</span></span><br><span class="line">            List&lt;Instance&gt; instanceList = addIpAddresses(service, ephemeral, ips);</span><br><span class="line">            <span class="type">Instances</span> <span class="variable">instances</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Instances</span>();</span><br><span class="line">            <span class="comment">// 获取到最新的数据</span></span><br><span class="line">            instances.setInstanceList(instanceList);</span><br><span class="line">            <span class="comment">// 同步服务，同步这个数据到其他nacos服务器</span></span><br><span class="line">            consistencyService.put(key, instances);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="开启Service健康检测定时任务"><a href="#开启Service健康检测定时任务" class="headerlink" title="开启Service健康检测定时任务"></a>开启Service健康检测定时任务</h4><p>来到 putServiceAndInit(service);方法内部，上面已经分析如何写入到注册表，现在开始看如何心跳检测。进入putServiceAndInit(service)内部的service.init()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 开始定时清除过期instance</span></span><br><span class="line">    HealthCheckReactor.scheduleCheck(clientBeatCheckTask);</span><br><span class="line">    <span class="comment">// 遍历service的cluster</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Cluster&gt; entry : clusterMap.entrySet()) &#123;</span><br><span class="line">        entry.getValue().setService(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// 开启每个cluster的健康检测</span></span><br><span class="line">        entry.getValue().init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>看一下心跳检测是怎么做的，一句话就是5S检测一次，15S没发送心跳就把实例状态改为不健康，30S没收到就摘除这个实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">scheduleCheck</span><span class="params">(ClientBeatCheckTask task)</span> &#123;</span><br><span class="line">       futureMap.computeIfAbsent(task.taskKey(),</span><br><span class="line">               <span class="comment">// 也就是5S检测一次</span></span><br><span class="line">               k -&gt; GlobalExecutor.scheduleNamingHealth(task, <span class="number">5000</span>, <span class="number">5000</span>, TimeUnit.MILLISECONDS));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 心跳检测的run方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 集群心跳任务检测，根据服务名取模到一个区间 就是一个服务 多个实例只有一个机器执行心跳检测</span></span><br><span class="line">           <span class="keyword">if</span> (!getDistroMapper().responsible(service.getName())) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">		<span class="comment">// 没开启健康检测就退出</span></span><br><span class="line">           <span class="keyword">if</span> (!getSwitchDomain().isHealthCheckEnabled()) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 这个服务所有临时实例</span></span><br><span class="line">           List&lt;Instance&gt; instances = service.allIPs(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// first set health status of instances:</span></span><br><span class="line">           <span class="comment">// 超过15S就过期</span></span><br><span class="line">           <span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">               <span class="comment">// 当前时间 - 实例上次心跳 &gt; 15秒</span></span><br><span class="line">               <span class="keyword">if</span> (System.currentTimeMillis() - instance.getLastBeat() &gt; instance.getInstanceHeartBeatTimeOut()) &#123;</span><br><span class="line">                  	<span class="comment">// mark标记是持久实例 如果instance是临时实例</span></span><br><span class="line">                   <span class="keyword">if</span> (!instance.isMarked()) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (instance.isHealthy()) &#123;</span><br><span class="line">                           <span class="comment">// 实例健康状态 -&gt; false</span></span><br><span class="line">                           instance.setHealthy(<span class="literal">false</span>);</span><br><span class="line">                           Loggers.EVT_LOG</span><br><span class="line">                                   .info(<span class="string">&quot;&#123;POS&#125; &#123;IP-DISABLED&#125; valid: &#123;&#125;:&#123;&#125;@&#123;&#125;@&#123;&#125;, region: &#123;&#125;, msg: client timeout after &#123;&#125;, last beat: &#123;&#125;&quot;</span>,</span><br><span class="line">                                           instance.getIp(), instance.getPort(), instance.getClusterName(),</span><br><span class="line">                                           service.getName(), UtilsAndCommons.LOCALHOST_SITE,</span><br><span class="line">                                           instance.getInstanceHeartBeatTimeOut(), instance.getLastBeat());</span><br><span class="line">                           <span class="comment">// 发布状态变更事件</span></span><br><span class="line">                           getPushService().serviceChanged(service);</span><br><span class="line">                           ApplicationUtils.publishEvent(<span class="keyword">new</span> <span class="title class_">InstanceHeartbeatTimeoutEvent</span>(<span class="built_in">this</span>, instance));</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!getGlobalConfig().isExpireInstance()) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// then remove obsolete instances:</span></span><br><span class="line">           <span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">			<span class="comment">// 临时实例</span></span><br><span class="line">               <span class="keyword">if</span> (instance.isMarked()) &#123;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 如果超过30S了 直接吧这个机器删掉</span></span><br><span class="line">               <span class="keyword">if</span> (System.currentTimeMillis() - instance.getLastBeat() &gt; instance.getIpDeleteTimeout()) &#123;</span><br><span class="line">                   <span class="comment">// delete instance</span></span><br><span class="line">                   Loggers.SRV_LOG.info(<span class="string">&quot;[AUTO-DELETE-IP] service: &#123;&#125;, ip: &#123;&#125;&quot;</span>, service.getName(),</span><br><span class="line">                           JacksonUtils.toJson(instance));</span><br><span class="line">                   <span class="comment">// 删除实例 这是不是删除的server的注册表</span></span><br><span class="line">                   deleteIp(instance);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           Loggers.SRV_LOG.warn(<span class="string">&quot;Exception while processing client beat time out.&quot;</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里的deleteIp(instance)是个异步，通过向nacos server发送一个请求，然后再做的删除，请求的就是InstanceController。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteIp</span><span class="params">(Instance instance)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            NamingProxy.<span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> NamingProxy.Request.newRequest();</span><br><span class="line">            request.appendParam(<span class="string">&quot;ip&quot;</span>, instance.getIp()).appendParam(<span class="string">&quot;port&quot;</span>, String.valueOf(instance.getPort()))</span><br><span class="line">                    .appendParam(<span class="string">&quot;ephemeral&quot;</span>, <span class="string">&quot;true&quot;</span>).appendParam(<span class="string">&quot;clusterName&quot;</span>, instance.getClusterName())</span><br><span class="line">                    .appendParam(<span class="string">&quot;serviceName&quot;</span>, service.getName()).appendParam(<span class="string">&quot;namespaceId&quot;</span>, service.getNamespaceId());</span><br><span class="line">            <span class="comment">// 自己请求自己，发送Delete请求，删除实例</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span> + IPUtil.localHostIP() + IPUtil.IP_PORT_SPLITER + EnvUtil.getPort() + EnvUtil.getContextPath()</span><br><span class="line">                    + UtilsAndCommons.NACOS_NAMING_CONTEXT + <span class="string">&quot;/instance?&quot;</span> + request.toUrl();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// delete instance asynchronously:</span></span><br><span class="line">            HttpClient.asyncHttpDelete(url, <span class="literal">null</span>, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(RestResult&lt;String&gt; result)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!result.ok()) &#123;</span><br><span class="line">                        Loggers.SRV_LOG</span><br><span class="line">                                .error(<span class="string">&quot;[IP-DEAD] failed to delete ip automatically, ip: &#123;&#125;, caused &#123;&#125;, resp code: &#123;&#125;&quot;</span>,</span><br><span class="line">                                        instance.toJson(), result.getMessage(), result.getCode());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                    Loggers.SRV_LOG</span><br><span class="line">                            .error(<span class="string">&quot;[IP-DEAD] failed to delete ip automatically, ip: &#123;&#125;, error: &#123;&#125;&quot;</span>, instance.toJson(),</span><br><span class="line">                                    throwable);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCancel</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Loggers.SRV_LOG</span><br><span class="line">                    .error(<span class="string">&quot;[IP-DEAD] failed to delete ip automatically, ip: &#123;&#125;, error: &#123;&#125;&quot;</span>, instance.toJson(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="开启Cluster的健康检测定时任务"><a href="#开启Cluster的健康检测定时任务" class="headerlink" title="开启Cluster的健康检测定时任务"></a>开启Cluster的健康检测定时任务</h4><p>service的健康检测我们已经了解了，现在开始看cluster的健康检测，直接进入cluster.init()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Init cluster.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 如果已经初始化过了 直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (inited) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建一个健康检查任务</span></span><br><span class="line">    checkTask = <span class="keyword">new</span> <span class="title class_">HealthCheckTask</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// 开启定时任务</span></span><br><span class="line">    HealthCheckReactor.scheduleCheck(checkTask);</span><br><span class="line">    inited = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后看一下HealthCheckTask的run()方法，还是一样的套路，在结束之前再重新开启一个任务。具体的任务是在healthCheckProcessor.process(this);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (distroMapper.responsible(cluster.getService().getName()) &amp;&amp; switchDomain</span><br><span class="line">                .isHealthCheckEnabled(cluster.getService().getName())) &#123;</span><br><span class="line">            <span class="comment">// 健康检查处理器处理</span></span><br><span class="line">            healthCheckProcessor.process(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (Loggers.EVT_LOG.isDebugEnabled()) &#123;</span><br><span class="line">                Loggers.EVT_LOG</span><br><span class="line">                        .debug(<span class="string">&quot;[HEALTH-CHECK] schedule health check task: &#123;&#125;&quot;</span>, cluster.getService().getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        Loggers.SRV_LOG</span><br><span class="line">                .error(<span class="string">&quot;[HEALTH-CHECK] error while process health check for &#123;&#125;:&#123;&#125;&quot;</span>, cluster.getService().getName(),</span><br><span class="line">                        cluster.getName(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!cancelled) &#123;</span><br><span class="line">            <span class="comment">// 重复执行</span></span><br><span class="line">            HealthCheckReactor.scheduleCheck(<span class="built_in">this</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// worst == 0 means never checked</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.getCheckRtWorst() &gt; <span class="number">0</span> &amp;&amp; switchDomain.isHealthCheckEnabled(cluster.getService().getName())</span><br><span class="line">                    &amp;&amp; distroMapper.responsible(cluster.getService().getName())) &#123;</span><br><span class="line">                <span class="comment">// TLog doesn&#x27;t support float so we must convert it into long</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">diff</span> <span class="operator">=</span></span><br><span class="line">                        ((<span class="built_in">this</span>.getCheckRtLast() - <span class="built_in">this</span>.getCheckRtLastLast()) * <span class="number">10000</span>) / <span class="built_in">this</span>.getCheckRtLastLast();</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">this</span>.setCheckRtLastLast(<span class="built_in">this</span>.getCheckRtLast());</span><br><span class="line">                </span><br><span class="line">                <span class="type">Cluster</span> <span class="variable">cluster</span> <span class="operator">=</span> <span class="built_in">this</span>.getCluster();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (Loggers.CHECK_RT.isDebugEnabled()) &#123;</span><br><span class="line">                    Loggers.CHECK_RT.debug(<span class="string">&quot;&#123;&#125;:&#123;&#125;@&#123;&#125;-&gt;normalized: &#123;&#125;, worst: &#123;&#125;, best: &#123;&#125;, last: &#123;&#125;, diff: &#123;&#125;&quot;</span>,</span><br><span class="line">                            cluster.getService().getName(), cluster.getName(), cluster.getHealthChecker().getType(),</span><br><span class="line">                            <span class="built_in">this</span>.getCheckRtNormalized(), <span class="built_in">this</span>.getCheckRtWorst(), <span class="built_in">this</span>.getCheckRtBest(),</span><br><span class="line">                            <span class="built_in">this</span>.getCheckRtLast(), diff);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>healthCheckProcessor.process(this)，这是一个接口的实现类里面的处理方法，这个接口有很多实现类。我们这里用到的是最后一个，所以来看这个方法是什么样的。就是拿出来所有的持久而且是健康的实例，然后遍历，根据他们的IP port构建心跳，然后放入队列中，后面会有线程处理队列。这里其实就是对持久实例的健康检测，Server给Client发心跳。那么必须有一个对队列操作的对象。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203221208632.png" alt="image-20220322120835506"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(HealthCheckTask task)</span> &#123;</span><br><span class="line">       <span class="comment">// 获取所有持久实例</span></span><br><span class="line">       List&lt;Instance&gt; ips = task.getCluster().allIPs(<span class="literal">false</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (CollectionUtils.isEmpty(ips)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span> (Instance ip : ips) &#123;</span><br><span class="line">           <span class="comment">// 过期的就不管</span></span><br><span class="line">           <span class="keyword">if</span> (ip.isMarked()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (SRV_LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   SRV_LOG.debug(<span class="string">&quot;tcp check, ip is marked as to skip health check, ip:&quot;</span> + ip.getIp());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">if</span> (!ip.markChecking()) &#123;</span><br><span class="line">               SRV_LOG.warn(<span class="string">&quot;tcp check started before last one finished, service: &quot;</span> + task.getCluster().getService()</span><br><span class="line">                       .getName() + <span class="string">&quot;:&quot;</span> + task.getCluster().getName() + <span class="string">&quot;:&quot;</span> + ip.getIp() + <span class="string">&quot;:&quot;</span> + ip.getPort());</span><br><span class="line">               </span><br><span class="line">               healthCheckCommon</span><br><span class="line">                       .reEvaluateCheckRT(task.getCheckRtNormalized() * <span class="number">2</span>, task, switchDomain.getTcpHealthParams());</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 生成一个心跳</span></span><br><span class="line">           <span class="type">Beat</span> <span class="variable">beat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Beat</span>(ip, task);</span><br><span class="line">           <span class="comment">// 放入队列中</span></span><br><span class="line">           taskQueue.add(beat);</span><br><span class="line">           MetricsMonitor.getTcpHealthCheckMonitor().incrementAndGet();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>然后看一下拿到队列了的这个beat是怎么处理的，拿到这个beat然后封装到list里，然后放到线程池里面执行，也就是给客户端发送请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processTask</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Collection&lt;Callable&lt;Void&gt;&gt; tasks = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">Beat</span> <span class="variable">beat</span> <span class="operator">=</span> taskQueue.poll(CONNECT_TIMEOUT_MS / <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">if</span> (beat == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        tasks.add(<span class="keyword">new</span> <span class="title class_">TaskProcessor</span>(beat));</span><br><span class="line">    &#125; <span class="keyword">while</span> (taskQueue.size() &gt; <span class="number">0</span> &amp;&amp; tasks.size() &lt; NIO_THREAD_COUNT * <span class="number">64</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (Future&lt;?&gt; f : GlobalExecutor.invokeAllTcpSuperSenseTask(tasks)) &#123;</span><br><span class="line">        f.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Nacos-Server处理注销请求"><a href="#Nacos-Server处理注销请求" class="headerlink" title="Nacos Server处理注销请求"></a>Nacos Server处理注销请求</h4><p>上面提到Service健康检查的时候如果发现实例已经30S没发送心跳，那么我们就会删除这个实例，具体的删除就是向InstanceController发送@Delete请求，那么我们现在就来分析Nacos Server在删除实例的时候具体是怎么做的，首先来到这个Controller的方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@Secured(parser = NamingResourceParser.class, action = ActionTypes.WRITE)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">deregister</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 前面是根据请求参数构建对象</span></span><br><span class="line">        <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> getIpAddress(request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> WebUtils.optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">        NamingUtils.checkServiceNameFormat(serviceName);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> serviceManager.getService(namespaceId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">            Loggers.SRV_LOG.warn(<span class="string">&quot;remove instance from non-exist service: &#123;&#125;&quot;</span>, serviceName);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除实例</span></span><br><span class="line">        serviceManager.removeInstance(namespaceId, serviceName, instance.isEphemeral(), instance);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>关键信息是在 serviceManager.removeInstance(namespaceId, serviceName, instance.isEphemeral(), instance)，具体来看这个方法是在干嘛，也很简单就是拿到service，对其加锁然后修改。具体还是要看内部的removeInstance方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeInstance</span><span class="params">(String namespaceId, String serviceName, <span class="type">boolean</span> ephemeral, Instance... ips)</span></span><br><span class="line">            <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">    	<span class="comment">// 从注册表获取当前service</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (service) &#123;</span><br><span class="line">            <span class="comment">// 删除Instance实例</span></span><br><span class="line">            removeInstance(namespaceId, serviceName, ephemeral, service, ips);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再来到removeInstance方法内部，和之前分析的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeInstance</span><span class="params">(String namespaceId, String serviceName, <span class="type">boolean</span> ephemeral, Service service,</span></span><br><span class="line"><span class="params">                               Instance... ips)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">	</span><br><span class="line">    	</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> KeyBuilder.buildInstanceListKey(namespaceId, serviceName, ephemeral);</span><br><span class="line">	<span class="comment">// 从注册表中删除实例 这里是调用的还是 com.alibaba.nacos.naming.core.ServiceManager#updateIpAddresses</span></span><br><span class="line">       List&lt;Instance&gt; instanceList = substractIpAddresses(service, ephemeral, ips);</span><br><span class="line"></span><br><span class="line">       <span class="type">Instances</span> <span class="variable">instances</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Instances</span>();</span><br><span class="line">       instances.setInstanceList(instanceList);</span><br><span class="line">	<span class="comment">// 发生了变更 把本次变更同步给其他nacos节点</span></span><br><span class="line">       consistencyService.put(key, instances);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server处理心跳请求"><a href="#Server处理心跳请求" class="headerlink" title="Server处理心跳请求"></a>Server处理心跳请求</h4><p>同样的Server处理心跳请求也是在InstanceController，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line">   <span class="meta">@PutMapping(&quot;/beat&quot;)</span></span><br><span class="line">   <span class="meta">@Secured(parser = NamingResourceParser.class, action = ActionTypes.WRITE)</span></span><br><span class="line">   <span class="keyword">public</span> ObjectNode <span class="title function_">beat</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// 创建一个Node，返回值就是这个 后面就是围绕这个node的操作</span></span><br><span class="line">       <span class="type">ObjectNode</span> <span class="variable">result</span> <span class="operator">=</span> JacksonUtils.createEmptyJsonNode();</span><br><span class="line">       result.put(SwitchEntry.CLIENT_BEAT_INTERVAL, switchDomain.getClientBeatInterval());</span><br><span class="line">       </span><br><span class="line">       <span class="type">String</span> <span class="variable">beat</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;beat&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">       <span class="type">RsInfo</span> <span class="variable">clientBeat</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (StringUtils.isNotBlank(beat)) &#123;</span><br><span class="line">           clientBeat = JacksonUtils.toObj(beat, RsInfo.class);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">String</span> <span class="variable">clusterName</span> <span class="operator">=</span> WebUtils</span><br><span class="line">               .optional(request, CommonParams.CLUSTER_NAME, UtilsAndCommons.DEFAULT_CLUSTER_NAME);</span><br><span class="line">       <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;ip&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">       <span class="comment">// 获取到客户端传递来的client端口 将来用来UDP通信</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(WebUtils.optional(request, <span class="string">&quot;port&quot;</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">       <span class="keyword">if</span> (clientBeat != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (StringUtils.isNotBlank(clientBeat.getCluster())) &#123;</span><br><span class="line">               clusterName = clientBeat.getCluster();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// fix #2533</span></span><br><span class="line">               clientBeat.setCluster(clusterName);</span><br><span class="line">           &#125;</span><br><span class="line">           ip = clientBeat.getIp();</span><br><span class="line">           port = clientBeat.getPort();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> WebUtils.optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">       <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">       NamingUtils.checkServiceNameFormat(serviceName);</span><br><span class="line">       Loggers.SRV_LOG.debug(<span class="string">&quot;[CLIENT-BEAT] full arguments: beat: &#123;&#125;, serviceName: &#123;&#125;&quot;</span>, clientBeat, serviceName);</span><br><span class="line">       <span class="comment">// 获取当前注册表中的发送请求对应的client对应的Instance</span></span><br><span class="line">       <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> serviceManager.getInstance(namespaceId, serviceName, clusterName, ip, port);</span><br><span class="line">       <span class="comment">// 处理注册表中不存在该client的instance的情况</span></span><br><span class="line">       <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (clientBeat == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="comment">// 如果请求中获取到的Beat，即client端的BeatInfo为空 请求中未携带心跳数据</span></span><br><span class="line">               result.put(CommonParams.CODE, NamingResponseCode.RESOURCE_NOT_FOUND);</span><br><span class="line">               <span class="keyword">return</span> result;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           Loggers.SRV_LOG.warn(<span class="string">&quot;[CLIENT-BEAT] The instance has been removed for health mechanism, &quot;</span></span><br><span class="line">                   + <span class="string">&quot;perform data compensation operations, beat: &#123;&#125;, serviceName: &#123;&#125;&quot;</span>, clientBeat, serviceName);</span><br><span class="line">           <span class="comment">// 注册表中没有这个instance 但是发送的请求中是有心跳信息的</span></span><br><span class="line">           <span class="comment">// 利用心跳信息创建一个</span></span><br><span class="line">           <span class="comment">// 注册请求还没到 心跳先到了 就是这种情况</span></span><br><span class="line">           instance = <span class="keyword">new</span> <span class="title class_">Instance</span>();</span><br><span class="line">           instance.setPort(clientBeat.getPort());</span><br><span class="line">           instance.setIp(clientBeat.getIp());</span><br><span class="line">           instance.setWeight(clientBeat.getWeight());</span><br><span class="line">           instance.setMetadata(clientBeat.getMetadata());</span><br><span class="line">           instance.setClusterName(clusterName);</span><br><span class="line">           instance.setServiceName(serviceName);</span><br><span class="line">           instance.setInstanceId(instance.getInstanceId());</span><br><span class="line">           instance.setEphemeral(clientBeat.isEphemeral());</span><br><span class="line">           <span class="comment">// 注册到注册表中</span></span><br><span class="line">           serviceManager.registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> serviceManager.getService(namespaceId, serviceName);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NacosException</span>(NacosException.SERVER_ERROR,</span><br><span class="line">                   <span class="string">&quot;service not found: &quot;</span> + serviceName + <span class="string">&quot;@&quot;</span> + namespaceId);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (clientBeat == <span class="literal">null</span>) &#123;</span><br><span class="line">           clientBeat = <span class="keyword">new</span> <span class="title class_">RsInfo</span>();</span><br><span class="line">           clientBeat.setIp(ip);</span><br><span class="line">           clientBeat.setPort(port);</span><br><span class="line">           clientBeat.setCluster(clusterName);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 真正处理心跳</span></span><br><span class="line">       service.processClientBeat(clientBeat);</span><br><span class="line">       </span><br><span class="line">       result.put(CommonParams.CODE, NamingResponseCode.OK);</span><br><span class="line">       <span class="keyword">if</span> (instance.containsMetadata(PreservedMetadataKeys.HEART_BEAT_INTERVAL)) &#123;</span><br><span class="line">           result.put(SwitchEntry.CLIENT_BEAT_INTERVAL, instance.getInstanceHeartBeatInterval());</span><br><span class="line">       &#125;</span><br><span class="line">       result.put(SwitchEntry.LIGHT_BEAT_ENABLED, switchDomain.isLightBeatEnabled());</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>进入真正处理心跳的方法内部，我们可以看到就是根据service和心跳消息构建一个处理任务，处理任务就是找到对应的的instance更新其最后心跳事件 如果这个实例之前已经是不健康的了，现在心跳来了，那么就更新为健康的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processClientBeat</span><span class="params">(<span class="keyword">final</span> RsInfo rsInfo)</span> &#123;</span><br><span class="line">      <span class="comment">// 这个处理器实现了run方法</span></span><br><span class="line">      <span class="type">ClientBeatProcessor</span> <span class="variable">clientBeatProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientBeatProcessor</span>();</span><br><span class="line">      clientBeatProcessor.setService(<span class="built_in">this</span>);</span><br><span class="line">      clientBeatProcessor.setRsInfo(rsInfo);</span><br><span class="line">      <span class="comment">// 开启一个立即执行的任务 执行任务的run</span></span><br><span class="line">      HealthCheckReactor.scheduleNow(clientBeatProcessor);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// 获取到注册表的service</span></span><br><span class="line">      <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="built_in">this</span>.service;</span><br><span class="line">      <span class="keyword">if</span> (Loggers.EVT_LOG.isDebugEnabled()) &#123;</span><br><span class="line">          Loggers.EVT_LOG.debug(<span class="string">&quot;[CLIENT-BEAT] processing beat: &#123;&#125;&quot;</span>, rsInfo.toString());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 从心跳信息中获取一些信息</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> rsInfo.getIp();</span><br><span class="line">      <span class="type">String</span> <span class="variable">clusterName</span> <span class="operator">=</span> rsInfo.getCluster();</span><br><span class="line">      <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> rsInfo.getPort();</span><br><span class="line">      <span class="comment">// 获取这个service对应的cluster</span></span><br><span class="line">      <span class="type">Cluster</span> <span class="variable">cluster</span> <span class="operator">=</span> service.getClusterMap().get(clusterName);</span><br><span class="line">      <span class="comment">// 获取临时实例 因为是客户端发送心跳到server</span></span><br><span class="line">      List&lt;Instance&gt; instances = cluster.allIPs(<span class="literal">true</span>);</span><br><span class="line">      <span class="comment">// 遍历临时实例</span></span><br><span class="line">      <span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">          <span class="comment">// 如果这个实例的IP port和当前心跳的instance的相同</span></span><br><span class="line">          <span class="keyword">if</span> (instance.getIp().equals(ip) &amp;&amp; instance.getPort() == port) &#123;</span><br><span class="line">              <span class="keyword">if</span> (Loggers.EVT_LOG.isDebugEnabled()) &#123;</span><br><span class="line">                  Loggers.EVT_LOG.debug(<span class="string">&quot;[CLIENT-BEAT] refresh beat: &#123;&#125;&quot;</span>, rsInfo.toString());</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// 更新这个实例最新的心跳事件</span></span><br><span class="line">              instance.setLastBeat(System.currentTimeMillis());</span><br><span class="line">              <span class="keyword">if</span> (!instance.isMarked() &amp;&amp; !instance.isHealthy()) &#123;</span><br><span class="line">                  <span class="comment">// 如果不是临时节点 而且之前标记为不健康</span></span><br><span class="line">                  <span class="comment">// 既然心跳都来了，那么就更新为健康的</span></span><br><span class="line">                  instance.setHealthy(<span class="literal">true</span>);</span><br><span class="line">                  Loggers.EVT_LOG</span><br><span class="line">                          .info(<span class="string">&quot;service: &#123;&#125; &#123;POS&#125; &#123;IP-ENABLED&#125; valid: &#123;&#125;:&#123;&#125;@&#123;&#125;, region: &#123;&#125;, msg: client beat ok&quot;</span>,</span><br><span class="line">                                  cluster.getService().getName(), ip, port, cluster.getName(),</span><br><span class="line">                                  UtilsAndCommons.LOCALHOST_SITE);</span><br><span class="line">                  <span class="comment">// 发布变更事件 后面分析UDP通知客户端</span></span><br><span class="line">                  getPushService().serviceChanged(service);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server处理客户端订阅"><a href="#Server处理客户端订阅" class="headerlink" title="Server处理客户端订阅"></a>Server处理客户端订阅</h4><p>客户端订阅服务，服务端的实例变更后，会UDP通知客户端，我们先来到服务订阅接口，获取参数，获取udp端口，然后处理请求，在doSrvIpxt处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">  <span class="meta">@Secured(parser = NamingResourceParser.class, action = ActionTypes.READ)</span></span><br><span class="line">  <span class="keyword">public</span> ObjectNode <span class="title function_">list</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> WebUtils.optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">      <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">      NamingUtils.checkServiceNameFormat(serviceName);</span><br><span class="line">      <span class="comment">// 用于指定客户端类型 </span></span><br><span class="line">      <span class="type">String</span> <span class="variable">agent</span> <span class="operator">=</span> WebUtils.getUserAgent(request);</span><br><span class="line">      <span class="type">String</span> <span class="variable">clusters</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;clusters&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">      <span class="type">String</span> <span class="variable">clientIP</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;clientIP&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">      <span class="comment">// UDP端口，用于变更通知 </span></span><br><span class="line">      <span class="type">int</span> <span class="variable">udpPort</span> <span class="operator">=</span> Integer.parseInt(WebUtils.optional(request, <span class="string">&quot;udpPort&quot;</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">      <span class="type">String</span> <span class="variable">env</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;env&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">isCheck</span> <span class="operator">=</span> Boolean.parseBoolean(WebUtils.optional(request, <span class="string">&quot;isCheck&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">      </span><br><span class="line">      <span class="type">String</span> <span class="variable">app</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;app&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">      </span><br><span class="line">      <span class="type">String</span> <span class="variable">tenant</span> <span class="operator">=</span> WebUtils.optional(request, <span class="string">&quot;tid&quot;</span>, StringUtils.EMPTY);</span><br><span class="line">      </span><br><span class="line">      <span class="type">boolean</span> <span class="variable">healthyOnly</span> <span class="operator">=</span> Boolean.parseBoolean(WebUtils.optional(request, <span class="string">&quot;healthyOnly&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> doSrvIpxt(namespaceId, serviceName, agent, clusters, clientIP, udpPort, env, isCheck, app, tenant,</span><br><span class="line">              healthyOnly);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>进入具体的处理方法，先是创建根据agent创建一个UDP Client然后放入map中，后面会根据这个map中client发送UDP请求，然后从注册表中获取所有可用的instance并封装称为json。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get service full information with instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> namespaceId namespace id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName service name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> agent       agent infor string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clusters    cluster names</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientIP    client ip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> udpPort     push udp port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> env         env</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isCheck     is check request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> app         app name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid         tenant</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> healthyOnly whether only for healthy check</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> service full information with instances</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception any error during handle</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ObjectNode <span class="title function_">doSrvIpxt</span><span class="params">(String namespaceId, String serviceName, String agent, String clusters, String clientIP,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> udpPort, String env, <span class="type">boolean</span> isCheck, String app, String tid, <span class="type">boolean</span> healthyOnly)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 根据不同的agent生成不同的ClientInfo 比如java agent生成一个java的ClientInfo</span></span><br><span class="line">        <span class="type">ClientInfo</span> <span class="variable">clientInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientInfo</span>(agent);</span><br><span class="line">        <span class="comment">// 这个就是返回的结果 后续代码就是对这个node各种操作</span></span><br><span class="line">        <span class="type">ObjectNode</span> <span class="variable">result</span> <span class="operator">=</span> JacksonUtils.createEmptyJsonNode();</span><br><span class="line">        <span class="comment">// 获取注册表的当前服务</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> serviceManager.getService(namespaceId, serviceName);</span><br><span class="line">        <span class="type">long</span> <span class="variable">cacheMillis</span> <span class="operator">=</span> switchDomain.getDefaultCacheMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="comment">// now try to enable the push</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (udpPort &gt; <span class="number">0</span> &amp;&amp; pushService.canEnablePush(agent)) &#123;</span><br><span class="line">                <span class="comment">// 创建当前发出订阅请求的Nacos client的UDP Client并放入缓存map中</span></span><br><span class="line">                <span class="comment">// 在UDP通信当中 Nacos Client充当是UDP Server</span></span><br><span class="line">                pushService</span><br><span class="line">                        .addClient(namespaceId, serviceName, clusters, agent, <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(clientIP, udpPort),</span><br><span class="line">                                pushDataSource, tid, app);</span><br><span class="line">                cacheMillis = switchDomain.getPushCacheMillis(serviceName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Loggers.SRV_LOG</span><br><span class="line">                    .error(<span class="string">&quot;[NACOS-API] failed to added push client &#123;&#125;, &#123;&#125;:&#123;&#125;&quot;</span>, clientInfo, clientIP, udpPort, e);</span><br><span class="line">            cacheMillis = switchDomain.getDefaultCacheMillis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果注册表中没有这个服务，则直接结束</span></span><br><span class="line">        <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Loggers.SRV_LOG.isDebugEnabled()) &#123;</span><br><span class="line">                Loggers.SRV_LOG.debug(<span class="string">&quot;no instance to serve for service: &#123;&#125;&quot;</span>, serviceName);</span><br><span class="line">            &#125;</span><br><span class="line">            result.put(<span class="string">&quot;name&quot;</span>, serviceName);</span><br><span class="line">            result.put(<span class="string">&quot;clusters&quot;</span>, clusters);</span><br><span class="line">            result.put(<span class="string">&quot;cacheMillis&quot;</span>, cacheMillis);</span><br><span class="line">            result.replace(<span class="string">&quot;hosts&quot;</span>, JacksonUtils.createEmptyArrayNode());</span><br><span class="line">            <span class="keyword">return</span> result; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 检查是否可用 如果不可用直接跑出异常</span></span><br><span class="line">        checkIfDisabled(service);</span><br><span class="line">        </span><br><span class="line">        List&lt;Instance&gt; srvedIPs;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 所有可用实例</span></span><br><span class="line">        srvedIPs = service.srvIPs(Arrays.asList(StringUtils.split(clusters, <span class="string">&quot;,&quot;</span>)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// filter ips using selector:</span></span><br><span class="line">        <span class="comment">// 选择器根据选择算法</span></span><br><span class="line">        <span class="comment">// 如果选择器不空 则根据选择算法选择可用的instance</span></span><br><span class="line">        <span class="keyword">if</span> (service.getSelector() != <span class="literal">null</span> &amp;&amp; StringUtils.isNotBlank(clientIP)) &#123;</span><br><span class="line">            srvedIPs = service.getSelector().select(clientIP, srvedIPs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有可用的instance 返回的Hosts还是为空的 直接结束</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(srvedIPs)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (Loggers.SRV_LOG.isDebugEnabled()) &#123;</span><br><span class="line">                Loggers.SRV_LOG.debug(<span class="string">&quot;no instance to serve for service: &#123;&#125;&quot;</span>, serviceName);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (clientInfo.type == ClientInfo.ClientType.JAVA</span><br><span class="line">                    &amp;&amp; clientInfo.version.compareTo(VersionUtil.parseVersion(<span class="string">&quot;1.0.0&quot;</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                result.put(<span class="string">&quot;dom&quot;</span>, serviceName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.put(<span class="string">&quot;dom&quot;</span>, NamingUtils.getServiceName(serviceName));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            result.put(<span class="string">&quot;name&quot;</span>, serviceName);</span><br><span class="line">            result.put(<span class="string">&quot;cacheMillis&quot;</span>, cacheMillis);</span><br><span class="line">            result.put(<span class="string">&quot;lastRefTime&quot;</span>, System.currentTimeMillis());</span><br><span class="line">            result.put(<span class="string">&quot;checksum&quot;</span>, service.getChecksum());</span><br><span class="line">            result.put(<span class="string">&quot;useSpecifiedURL&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            result.put(<span class="string">&quot;clusters&quot;</span>, clusters);</span><br><span class="line">            result.put(<span class="string">&quot;env&quot;</span>, env);</span><br><span class="line">            result.set(<span class="string">&quot;hosts&quot;</span>, JacksonUtils.createEmptyArrayNode());</span><br><span class="line">            result.set(<span class="string">&quot;metadata&quot;</span>, JacksonUtils.transferToJsonNode(service.getMetadata()));</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 走到这里 说明是有可用的instance</span></span><br><span class="line">        Map&lt;Boolean, List&lt;Instance&gt;&gt; ipMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 放入健康的instance</span></span><br><span class="line">        ipMap.put(Boolean.TRUE, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 放入不健康的instance</span></span><br><span class="line">        ipMap.put(Boolean.FALSE, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 把健康和不健康的实例分开放置在map中</span></span><br><span class="line">        <span class="keyword">for</span> (Instance ip : srvedIPs) &#123;</span><br><span class="line">            ipMap.get(ip.isHealthy()).add(ip);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 是否需要检测instance的保护阈值 </span></span><br><span class="line">        <span class="keyword">if</span> (isCheck) &#123;</span><br><span class="line">            result.put(<span class="string">&quot;reachProtectThreshold&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取服务的保护阈值</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">threshold</span> <span class="operator">=</span> service.getProtectThreshold();</span><br><span class="line">        <span class="comment">// 如果健康实例的数量/所有的instance数量 &lt;= 保护阈值 说明要启动保护机制 </span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">float</span>) ipMap.get(Boolean.TRUE).size() / srvedIPs.size() &lt;= threshold) &#123;</span><br><span class="line">            </span><br><span class="line">            Loggers.SRV_LOG.warn(<span class="string">&quot;protect threshold reached, return all ips, service: &#123;&#125;&quot;</span>, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (isCheck) &#123;</span><br><span class="line">                result.put(<span class="string">&quot;reachProtectThreshold&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 启动了保护阈值 那么消费者要调用所有的实例，这也可能导致调用到不可用的实例</span></span><br><span class="line">            <span class="comment">// 这样牺牲了调用者，但是不会吧所有请求都发给可用的实例，防止宕机</span></span><br><span class="line">            ipMap.get(Boolean.TRUE).addAll(ipMap.get(Boolean.FALSE));</span><br><span class="line">            ipMap.get(Boolean.FALSE).clear();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isCheck) &#123;</span><br><span class="line">            result.put(<span class="string">&quot;protectThreshold&quot;</span>, service.getProtectThreshold());</span><br><span class="line">            result.put(<span class="string">&quot;reachLocalSiteCallThreshold&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> JacksonUtils.createEmptyJsonNode();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ArrayNode</span> <span class="variable">hosts</span> <span class="operator">=</span> JacksonUtils.createEmptyArrayNode();</span><br><span class="line">        <span class="comment">// 这个ipMap放的是所有健康和不健康的实例</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Boolean, List&lt;Instance&gt;&gt; entry : ipMap.entrySet()) &#123;</span><br><span class="line">            List&lt;Instance&gt; ips = entry.getValue();</span><br><span class="line">            <span class="comment">// 如果客户端只有健康的instance且当前遍历的map key为false 则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (healthyOnly &amp;&amp; !entry.getKey()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 遍历的ips 可能是所有不健康的实例列表</span></span><br><span class="line">            <span class="comment">// 可能是所有健康的</span></span><br><span class="line">            <span class="comment">// 也可能是所有的instance列表</span></span><br><span class="line">            <span class="keyword">for</span> (Instance instance : ips) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// remove disabled instance:</span></span><br><span class="line">                <span class="comment">// 跳过禁用的instance</span></span><br><span class="line">                <span class="keyword">if</span> (!instance.isEnabled()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将当前遍历的instance 转换为json</span></span><br><span class="line">                <span class="type">ObjectNode</span> <span class="variable">ipObj</span> <span class="operator">=</span> JacksonUtils.createEmptyJsonNode();</span><br><span class="line">                </span><br><span class="line">                ipObj.put(<span class="string">&quot;ip&quot;</span>, instance.getIp());</span><br><span class="line">                ipObj.put(<span class="string">&quot;port&quot;</span>, instance.getPort());</span><br><span class="line">                <span class="comment">// deprecated since nacos 1.0.0:</span></span><br><span class="line">                ipObj.put(<span class="string">&quot;valid&quot;</span>, entry.getKey());</span><br><span class="line">                ipObj.put(<span class="string">&quot;healthy&quot;</span>, entry.getKey());</span><br><span class="line">                ipObj.put(<span class="string">&quot;marked&quot;</span>, instance.isMarked());</span><br><span class="line">                ipObj.put(<span class="string">&quot;instanceId&quot;</span>, instance.getInstanceId());</span><br><span class="line">                ipObj.set(<span class="string">&quot;metadata&quot;</span>, JacksonUtils.transferToJsonNode(instance.getMetadata()));</span><br><span class="line">                ipObj.put(<span class="string">&quot;enabled&quot;</span>, instance.isEnabled());</span><br><span class="line">                ipObj.put(<span class="string">&quot;weight&quot;</span>, instance.getWeight());</span><br><span class="line">                ipObj.put(<span class="string">&quot;clusterName&quot;</span>, instance.getClusterName());</span><br><span class="line">                <span class="keyword">if</span> (clientInfo.type == ClientInfo.ClientType.JAVA</span><br><span class="line">                        &amp;&amp; clientInfo.version.compareTo(VersionUtil.parseVersion(<span class="string">&quot;1.0.0&quot;</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    ipObj.put(<span class="string">&quot;serviceName&quot;</span>, instance.getServiceName());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ipObj.put(<span class="string">&quot;serviceName&quot;</span>, NamingUtils.getServiceName(instance.getServiceName()));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                ipObj.put(<span class="string">&quot;ephemeral&quot;</span>, instance.isEphemeral());</span><br><span class="line">                <span class="comment">// 添加到hosts中</span></span><br><span class="line">                hosts.add(ipObj);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        result.replace(<span class="string">&quot;hosts&quot;</span>, hosts);</span><br><span class="line">        <span class="keyword">if</span> (clientInfo.type == ClientInfo.ClientType.JAVA</span><br><span class="line">                &amp;&amp; clientInfo.version.compareTo(VersionUtil.parseVersion(<span class="string">&quot;1.0.0&quot;</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            result.put(<span class="string">&quot;dom&quot;</span>, serviceName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.put(<span class="string">&quot;dom&quot;</span>, NamingUtils.getServiceName(serviceName));</span><br><span class="line">        &#125;</span><br><span class="line">        result.put(<span class="string">&quot;name&quot;</span>, serviceName);</span><br><span class="line">        result.put(<span class="string">&quot;cacheMillis&quot;</span>, cacheMillis);</span><br><span class="line">        result.put(<span class="string">&quot;lastRefTime&quot;</span>, System.currentTimeMillis());</span><br><span class="line">        result.put(<span class="string">&quot;checksum&quot;</span>, service.getChecksum());</span><br><span class="line">        result.put(<span class="string">&quot;useSpecifiedURL&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        result.put(<span class="string">&quot;clusters&quot;</span>, clusters);</span><br><span class="line">        result.put(<span class="string">&quot;env&quot;</span>, env);</span><br><span class="line">        result.replace(<span class="string">&quot;metadata&quot;</span>, JacksonUtils.transferToJsonNode(service.getMetadata()));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<h4 id="Server和Client之间的UDP通信"><a href="#Server和Client之间的UDP通信" class="headerlink" title="Server和Client之间的UDP通信"></a>Server和Client之间的UDP通信</h4><h5 id="服务端发送UDP推送"><a href="#服务端发送UDP推送" class="headerlink" title="服务端发送UDP推送"></a>服务端发送UDP推送</h5><p>我们在心跳请求哪里发现，如果实例的健康状况发生了变化，那么我们要把这个状态的变更通知到订阅者，这是居于Spring事件机制做的，发布这个事件之后会有一个处理器来处理，具体就是封装成UDP报文发送给client，client再发送一个ack。我们先来到修改实例健康状态的代码。进入serviceChanged方法，看看具体是怎么做的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新这个实例最新的心跳事件</span></span><br><span class="line">instance.setLastBeat(System.currentTimeMillis());</span><br><span class="line"><span class="keyword">if</span> (!instance.isMarked() &amp;&amp; !instance.isHealthy()) &#123;</span><br><span class="line">    <span class="comment">// 如果不是临时节点 而且之前标记为不健康</span></span><br><span class="line">    <span class="comment">// 既然心跳都来了，那么就更新为健康的</span></span><br><span class="line">    instance.setHealthy(<span class="literal">true</span>);</span><br><span class="line">    Loggers.EVT_LOG</span><br><span class="line">        .info(<span class="string">&quot;service: &#123;&#125; &#123;POS&#125; &#123;IP-ENABLED&#125; valid: &#123;&#125;:&#123;&#125;@&#123;&#125;, region: &#123;&#125;, msg: client beat ok&quot;</span>,</span><br><span class="line">              cluster.getService().getName(), ip, port, cluster.getName(),</span><br><span class="line">              UtilsAndCommons.LOCALHOST_SITE);</span><br><span class="line">    <span class="comment">// 发布变更事件 后面分析UDP通知客户端</span></span><br><span class="line">    getPushService().serviceChanged(service);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service changed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> service service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serviceChanged</span><span class="params">(Service service)</span> &#123;</span><br><span class="line">        <span class="comment">// merge some change events to reduce the push frequency:</span></span><br><span class="line">        <span class="keyword">if</span> (futureMap</span><br><span class="line">                .containsKey(UtilsAndCommons.assembleFullServiceName(service.getNamespaceId(), service.getName()))) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发布事件</span></span><br><span class="line">        <span class="built_in">this</span>.applicationContext.publishEvent(<span class="keyword">new</span> <span class="title class_">ServiceChangeEvent</span>(<span class="built_in">this</span>, service));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>一旦这个事件发生了，触发了com.alibaba.nacos.naming.push.PushService#onApplicationEvent方法，那就要分析这个方法做的是什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ServiceChangeEvent event)</span> &#123;</span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> event.getService();</span><br><span class="line">    <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> service.getName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> service.getNamespaceId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动一个定时操作 异步执行相关内容 变化一次只执行一次</span></span><br><span class="line">    <span class="type">Future</span> <span class="variable">future</span> <span class="operator">=</span> GlobalExecutor.scheduleUdpSender(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Loggers.PUSH.info(serviceName + <span class="string">&quot; is changed, add it to push queue.&quot;</span>);</span><br><span class="line">            <span class="comment">// 从缓存map中获取 udp client client订阅服务的时候已经放进去了</span></span><br><span class="line">            ConcurrentMap&lt;String, PushClient&gt; clients = clientMap</span><br><span class="line">                .get(UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName));</span><br><span class="line">            <span class="comment">// 没有UDP客户端，直接结束了</span></span><br><span class="line">            <span class="keyword">if</span> (MapUtils.isEmpty(clients)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			</span><br><span class="line">            Map&lt;String, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">            <span class="comment">// 更新最后引用事件</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">lastRefTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="comment">// 遍历所有 UDPclient 进行UDP推送</span></span><br><span class="line">            <span class="keyword">for</span> (PushClient client : clients.values()) &#123;</span><br><span class="line">                <span class="comment">// 如果这个UDPclient是一个僵尸client 就移除他</span></span><br><span class="line">                <span class="keyword">if</span> (client.zombie()) &#123;</span><br><span class="line">                    Loggers.PUSH.debug(<span class="string">&quot;client is zombie: &quot;</span> + client.toString());</span><br><span class="line">                    clients.remove(client.toString());</span><br><span class="line">                    Loggers.PUSH.debug(<span class="string">&quot;client is zombie: &quot;</span> + client.toString());</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Receiver.AckEntry ackEntry;</span><br><span class="line">                Loggers.PUSH.debug(<span class="string">&quot;push serviceName: &#123;&#125; to client: &#123;&#125;&quot;</span>, serviceName, client.toString());</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> getPushCacheKey(serviceName, client.getIp(), client.getAgent());</span><br><span class="line">                <span class="type">byte</span>[] compressData = <span class="literal">null</span>;</span><br><span class="line">                Map&lt;String, Object&gt; data = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (switchDomain.getDefaultPushCacheMillis() &gt;= <span class="number">20000</span> &amp;&amp; cache.containsKey(key)) &#123;</span><br><span class="line">                    org.javatuples.<span class="type">Pair</span> <span class="variable">pair</span> <span class="operator">=</span> (org.javatuples.Pair) cache.get(key);</span><br><span class="line">                    compressData = (<span class="type">byte</span>[]) (pair.getValue0());</span><br><span class="line">                    data = (Map&lt;String, Object&gt;) pair.getValue1();</span><br><span class="line"></span><br><span class="line">                    Loggers.PUSH.debug(<span class="string">&quot;[PUSH-CACHE] cache hit: &#123;&#125;:&#123;&#125;&quot;</span>, serviceName, client.getAddrStr());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (compressData != <span class="literal">null</span>) &#123;</span><br><span class="line">                    ackEntry = prepareAckEntry(client, compressData, data, lastRefTime);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ackEntry = prepareAckEntry(client, prepareHostsData(client), lastRefTime);</span><br><span class="line">                    <span class="keyword">if</span> (ackEntry != <span class="literal">null</span>) &#123;</span><br><span class="line">                        cache.put(key, <span class="keyword">new</span> <span class="title class_">org</span>.javatuples.Pair&lt;&gt;(ackEntry.origin.getData(), ackEntry.data));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Loggers.PUSH.info(<span class="string">&quot;serviceName: &#123;&#125; changed, schedule push for: &#123;&#125;, agent: &#123;&#125;, key: &#123;&#125;&quot;</span>,</span><br><span class="line">                                  client.getServiceName(), client.getAddrStr(), client.getAgent(),</span><br><span class="line">                                  (ackEntry == <span class="literal">null</span> ? <span class="literal">null</span> : ackEntry.key));</span><br><span class="line">                <span class="comment">// UDP Push给客户端</span></span><br><span class="line">                udpPush(ackEntry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Loggers.PUSH.error(<span class="string">&quot;[NACOS-PUSH] failed to push serviceName: &#123;&#125; to client, error: &#123;&#125;&quot;</span>, serviceName, e);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            futureMap.remove(UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    futureMap.put(UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName), future);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看一下具体的UDP推送方法也就是 udpPush(ackEntry)  其实就是调用JDK的方法发送UDP报文，然后失败重试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Receiver.AckEntry <span class="title function_">udpPush</span><span class="params">(Receiver.AckEntry ackEntry)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (ackEntry == <span class="literal">null</span>) &#123;</span><br><span class="line">           Loggers.PUSH.error(<span class="string">&quot;[NACOS-PUSH] ackEntry is null.&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 超过重试次数 返回</span></span><br><span class="line">       <span class="keyword">if</span> (ackEntry.getRetryTimes() &gt; MAX_RETRY_TIMES) &#123;</span><br><span class="line">           Loggers.PUSH.warn(<span class="string">&quot;max re-push times reached, retry times &#123;&#125;, key: &#123;&#125;&quot;</span>, ackEntry.retryTimes, ackEntry.key);</span><br><span class="line">           ackMap.remove(ackEntry.key);</span><br><span class="line">           udpSendTimeMap.remove(ackEntry.key);</span><br><span class="line">           failedPush += <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">return</span> ackEntry;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!ackMap.containsKey(ackEntry.key)) &#123;</span><br><span class="line">               totalPush++;</span><br><span class="line">           &#125;</span><br><span class="line">           ackMap.put(ackEntry.key, ackEntry);</span><br><span class="line">           udpSendTimeMap.put(ackEntry.key, System.currentTimeMillis());</span><br><span class="line">           </span><br><span class="line">           Loggers.PUSH.info(<span class="string">&quot;send udp packet: &quot;</span> + ackEntry.key);</span><br><span class="line">           <span class="comment">// 发送UDP报文 JDK层面的东西</span></span><br><span class="line">           udpSocket.send(ackEntry.origin);</span><br><span class="line">           </span><br><span class="line">           ackEntry.increaseRetryTime();</span><br><span class="line">           <span class="comment">// 推送失败后，重试发送UDP报文</span></span><br><span class="line">           GlobalExecutor.scheduleRetransmitter(<span class="keyword">new</span> <span class="title class_">Retransmitter</span>(ackEntry),</span><br><span class="line">                   TimeUnit.NANOSECONDS.toMillis(ACK_TIMEOUT_NANOS), TimeUnit.MILLISECONDS);</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">return</span> ackEntry;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           Loggers.PUSH.error(<span class="string">&quot;[NACOS-PUSH] failed to push data: &#123;&#125; to client: &#123;&#125;, error: &#123;&#125;&quot;</span>, ackEntry.data,</span><br><span class="line">                   ackEntry.origin.getAddress().getHostAddress(), e);</span><br><span class="line">           ackMap.remove(ackEntry.key);</span><br><span class="line">           udpSendTimeMap.remove(ackEntry.key);</span><br><span class="line">           failedPush += <span class="number">1</span>;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="客户端收到UDP报文的处理"><a href="#客户端收到UDP报文的处理" class="headerlink" title="客户端收到UDP报文的处理"></a>客户端收到UDP报文的处理</h5><p>只要服务变更，Server发送消息是遍历订阅这个服务的所有client，那么客户端一定有相应的处理，接下来就分析客户端是怎么处理UDP报文的。实际是client是有一个线程轮训处理的。其实在客户端启动的时候会调用这个方法org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration#onApplicationEvent，他做的事情就是在tomcat容器启动的时候就执行对应的方法，类似事件监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(WebServerInitializedEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// webserver初始化结束事件</span></span><br><span class="line">		bind(event);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(WebServerInitializedEvent event)</span> &#123;</span><br><span class="line">		<span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> event.getApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (context <span class="keyword">instanceof</span> ConfigurableWebServerApplicationContext) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">&quot;management&quot;</span>.equals(((ConfigurableWebServerApplicationContext) context)</span><br><span class="line">					.getServerNamespace())) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.port.compareAndSet(<span class="number">0</span>, event.getWebServer().getPort());</span><br><span class="line">		<span class="built_in">this</span>.start();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中最重要的就是最后那个注册启动的方法，接着我们来看看，过滤掉一些不重要的信息，可以看到在这里是执行了一个注册方法，所以我们还要来到注册方法内部。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Discovery Lifecycle disabled. Not starting&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// only initialize if nonSecurePort is greater than 0 and it isn&#x27;t already running</span></span><br><span class="line">		<span class="comment">// because of containerPortInitializer below</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.running.get()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.context.publishEvent(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">InstancePreRegisteredEvent</span>(<span class="built_in">this</span>, getRegistration()));</span><br><span class="line">			register();</span><br><span class="line">			<span class="keyword">if</span> (shouldRegisterManagement()) &#123;</span><br><span class="line">				registerManagement();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.context.publishEvent(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">InstanceRegisteredEvent</span>&lt;&gt;(<span class="built_in">this</span>, getConfiguration()));</span><br><span class="line">			<span class="built_in">this</span>.running.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>来到register()方法内部，最终调用的是com.alibaba.cloud.nacos.registry.NacosServiceRegistry#register，然后定位到最终调用注册的方法，大概就是从配置文件中获取服务信息，发送post请求，同时启动一个心跳定时任务，其实这些东西前面已经分析过了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Registration registration)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(registration.getServiceId())) &#123;</span><br><span class="line">			log.warn(<span class="string">&quot;No service to register for nacos client...&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">NamingService</span> <span class="variable">namingService</span> <span class="operator">=</span> namingService();</span><br><span class="line">		<span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> registration.getServiceId();</span><br><span class="line">		<span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> nacosDiscoveryProperties.getGroup();</span><br><span class="line"></span><br><span class="line">		<span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> getNacosInstanceFromRegistration(registration);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			namingService.registerInstance(serviceId, group, instance);</span><br><span class="line">			log.info(<span class="string">&quot;nacos registry, &#123;&#125; &#123;&#125; &#123;&#125;:&#123;&#125; register finished&quot;</span>, group, serviceId,</span><br><span class="line">					instance.getIp(), instance.getPort());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot;nacos registry, &#123;&#125; register failed...&#123;&#125;,&quot;</span>, serviceId,</span><br><span class="line">					registration.toString(), e);</span><br><span class="line">			<span class="comment">// rethrow a RuntimeException if the registration is failed.</span></span><br><span class="line">			<span class="comment">// issue : https://github.com/alibaba/spring-cloud-alibaba/issues/1132</span></span><br><span class="line">			rethrowRuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 重要是namingService.registerInstance(serviceId, group, instance);</span></span><br><span class="line">	    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerInstance</span><span class="params">(String serviceName, String groupName, Instance instance)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        NamingUtils.checkInstanceIsLegal(instance);</span><br><span class="line">        <span class="type">String</span> <span class="variable">groupedServiceName</span> <span class="operator">=</span> NamingUtils.getGroupedName(serviceName, groupName);</span><br><span class="line">        <span class="keyword">if</span> (instance.isEphemeral()) &#123;</span><br><span class="line">            <span class="type">BeatInfo</span> <span class="variable">beatInfo</span> <span class="operator">=</span> beatReactor.buildBeatInfo(groupedServiceName, instance);</span><br><span class="line">            beatReactor.addBeatInfo(groupedServiceName, beatInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        serverProxy.registerService(groupedServiceName, groupName, instance);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以注意到上面有一个创建的方法即 NamingService namingService &#x3D; namingService()，其实内部是使用了NacosServiceManager通过反射调用了NamingService的构造方法来执行的，那我们直接定位到NamingService的构造方法，这里一定是执行了NamingService的初始化操作。在最后看到了有一个处理host的线程池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="title function_">NacosNamingService</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">        init(properties);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">    ValidatorUtils.checkInitParam(properties);</span><br><span class="line">    <span class="built_in">this</span>.namespace = InitUtils.initNamespaceForNaming(properties);</span><br><span class="line">    InitUtils.initSerialization();</span><br><span class="line">    initServerAddr(properties);</span><br><span class="line">    InitUtils.initWebRootContext(properties);</span><br><span class="line">    initCacheDir();</span><br><span class="line">    initLogName(properties);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">this</span>.serverProxy = <span class="keyword">new</span> <span class="title class_">NamingProxy</span>(<span class="built_in">this</span>.namespace, <span class="built_in">this</span>.endpoint, <span class="built_in">this</span>.serverList, properties);</span><br><span class="line">    <span class="built_in">this</span>.beatReactor = <span class="keyword">new</span> <span class="title class_">BeatReactor</span>(<span class="built_in">this</span>.serverProxy, initClientBeatThreadCount(properties));</span><br><span class="line">    <span class="comment">// 这里就是创建一个线程池来处理</span></span><br><span class="line">    <span class="built_in">this</span>.hostReactor = <span class="keyword">new</span> <span class="title class_">HostReactor</span>(<span class="built_in">this</span>.serverProxy, beatReactor, <span class="built_in">this</span>.cacheDir, isLoadCacheAtStart(properties),</span><br><span class="line">            isPushEmptyProtect(properties), initPollingThreadCount(properties));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入这个线程池的初始化代码内部，看到有一个关键信息就是创建一个PushReceiver来处理UDP推送信息。最后就来看看这个pushReceiver是怎么处理的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HostReactor</span><span class="params">(NamingProxy serverProxy, BeatReactor beatReactor, String cacheDir, <span class="type">boolean</span> loadCacheAtStart,</span></span><br><span class="line"><span class="params">           <span class="type">boolean</span> pushEmptyProtection, <span class="type">int</span> pollingThreadCount)</span> &#123;</span><br><span class="line">       <span class="comment">// init executorService</span></span><br><span class="line">       <span class="built_in">this</span>.executor = <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(pollingThreadCount, <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">               <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">               thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">               thread.setName(<span class="string">&quot;com.alibaba.nacos.client.naming.updater&quot;</span>);</span><br><span class="line">               <span class="keyword">return</span> thread;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       </span><br><span class="line">       <span class="built_in">this</span>.beatReactor = beatReactor;</span><br><span class="line">       <span class="built_in">this</span>.serverProxy = serverProxy;</span><br><span class="line">       <span class="built_in">this</span>.cacheDir = cacheDir;</span><br><span class="line">       <span class="keyword">if</span> (loadCacheAtStart) &#123;</span><br><span class="line">           <span class="built_in">this</span>.serviceInfoMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, ServiceInfo&gt;(DiskCache.read(<span class="built_in">this</span>.cacheDir));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.serviceInfoMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, ServiceInfo&gt;(<span class="number">16</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">this</span>.pushEmptyProtection = pushEmptyProtection;</span><br><span class="line">       <span class="built_in">this</span>.updatingMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Object&gt;();</span><br><span class="line">       <span class="built_in">this</span>.failoverReactor = <span class="keyword">new</span> <span class="title class_">FailoverReactor</span>(<span class="built_in">this</span>, cacheDir);</span><br><span class="line">    	<span class="comment">// 处理server 的UDP推送</span></span><br><span class="line">       <span class="built_in">this</span>.pushReceiver = <span class="keyword">new</span> <span class="title class_">PushReceiver</span>(<span class="built_in">this</span>);</span><br><span class="line">       <span class="built_in">this</span>.notifier = <span class="keyword">new</span> <span class="title class_">InstancesChangeNotifier</span>();</span><br><span class="line">       </span><br><span class="line">       NotifyCenter.registerToPublisher(InstancesChangeEvent.class, <span class="number">16384</span>);</span><br><span class="line">       NotifyCenter.registerSubscriber(notifier);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>进入pushReceiver，他是一个线程直接看run方法，可以看到它就是一个线程，然后做的事情就是获取UDP包，解析称为JSON然后把Nacos Server上面变更的service写入到本地，然后发送给服务器一个ack。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PushReceiver</span><span class="params">(HostReactor hostReactor)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.hostReactor = hostReactor;</span><br><span class="line">           <span class="built_in">this</span>.udpSocket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">           <span class="comment">// 创建一个线程池</span></span><br><span class="line">           <span class="built_in">this</span>.executorService = <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                   <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">                   thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">                   thread.setName(<span class="string">&quot;com.alibaba.nacos.naming.push.receiver&quot;</span>);</span><br><span class="line">                   <span class="keyword">return</span> thread;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">           <span class="comment">// 异步执行当前PushReceiver任务</span></span><br><span class="line">           <span class="built_in">this</span>.executorService.execute(<span class="built_in">this</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           NAMING_LOGGER.error(<span class="string">&quot;[NA] init udp socket failed&quot;</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">while</span> (!closed) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// byte[] is initialized with 0 full filled by default</span></span><br><span class="line">               <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[UDP_MSS];</span><br><span class="line">               <span class="type">DatagramPacket</span> <span class="variable">packet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(buffer, buffer.length);</span><br><span class="line">               <span class="comment">// 接受来自server的UDP包 并封装</span></span><br><span class="line">               udpSocket.receive(packet);</span><br><span class="line">               <span class="comment">// 将数据解码称为JSON</span></span><br><span class="line">               <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(IoUtils.tryDecompress(packet.getData()), UTF_8).trim();</span><br><span class="line">               NAMING_LOGGER.info(<span class="string">&quot;received push data: &quot;</span> + json + <span class="string">&quot; from &quot;</span> + packet.getAddress().toString());</span><br><span class="line">               </span><br><span class="line">               <span class="type">PushPacket</span> <span class="variable">pushPacket</span> <span class="operator">=</span> JacksonUtils.toObj(json, PushPacket.class);</span><br><span class="line">               String ack;</span><br><span class="line">               <span class="comment">// 根据不同的数据类型，返回到server不同的ack</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="string">&quot;dom&quot;</span>.equals(pushPacket.type) || <span class="string">&quot;service&quot;</span>.equals(pushPacket.type)) &#123;</span><br><span class="line">                   <span class="comment">// 将来自server的发生变更的service更新到当前Naocs Client本地注册表中</span></span><br><span class="line">                   hostReactor.processServiceJson(pushPacket.data);</span><br><span class="line">                   </span><br><span class="line">                   <span class="comment">// send ack to server</span></span><br><span class="line">                   ack = <span class="string">&quot;&#123;\&quot;type\&quot;: \&quot;push-ack\&quot;&quot;</span> + <span class="string">&quot;, \&quot;lastRefTime\&quot;:\&quot;&quot;</span> + pushPacket.lastRefTime + <span class="string">&quot;\&quot;, \&quot;data\&quot;:&quot;</span></span><br><span class="line">                           + <span class="string">&quot;\&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;dump&quot;</span>.equals(pushPacket.type)) &#123;</span><br><span class="line">                   <span class="comment">// dump data to server</span></span><br><span class="line">                   ack = <span class="string">&quot;&#123;\&quot;type\&quot;: \&quot;dump-ack\&quot;&quot;</span> + <span class="string">&quot;, \&quot;lastRefTime\&quot;: \&quot;&quot;</span> + pushPacket.lastRefTime + <span class="string">&quot;\&quot;, \&quot;data\&quot;:&quot;</span></span><br><span class="line">                           + <span class="string">&quot;\&quot;&quot;</span> + StringUtils.escapeJavaScript(JacksonUtils.toJson(hostReactor.getServiceInfoMap()))</span><br><span class="line">                           + <span class="string">&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// do nothing send ack only</span></span><br><span class="line">                   ack = <span class="string">&quot;&#123;\&quot;type\&quot;: \&quot;unknown-ack\&quot;&quot;</span> + <span class="string">&quot;, \&quot;lastRefTime\&quot;:\&quot;&quot;</span> + pushPacket.lastRefTime</span><br><span class="line">                           + <span class="string">&quot;\&quot;, \&quot;data\&quot;:&quot;</span> + <span class="string">&quot;\&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 返回ack到server</span></span><br><span class="line">               udpSocket.send(<span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(ack.getBytes(UTF_8), ack.getBytes(UTF_8).length,</span><br><span class="line">                       packet.getSocketAddress()));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               NAMING_LOGGER.error(<span class="string">&quot;[NA] error while receiving push data&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server间通信"><a href="#Server间通信" class="headerlink" title="Server间通信"></a>Server间通信</h4><p>Nacos在启动的时候会进行3项重要操作</p>
<ol>
<li>启动一个定时任务，每60S当前Server会向其他Nacos Server发送一次本地注册表</li>
<li>会从其他Nacos Server获取的注册表中的所有instance的状态，并更新到本地</li>
<li>启动一个定时任务，60S之后执行，每20S清理一次注册表中的空Service</li>
</ol>
<p>结论就是，ServerManager在创建的时候通过后置处理器初始化了这三个任务，我们直接来看源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Init service maneger.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostConstruct</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 第一项任务，上报本地注册表 本季注册表是以校验和方式发送</span></span><br><span class="line">       GlobalExecutor.scheduleServiceReporter(<span class="keyword">new</span> <span class="title class_">ServiceReporter</span>(), <span class="number">60000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">	<span class="comment">// 从其他nacos实例获取最新状态</span></span><br><span class="line">       GlobalExecutor.submitServiceUpdateManager(<span class="keyword">new</span> <span class="title class_">UpdatedServiceProcessor</span>());</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (emptyServiceAutoClean) &#123;</span><br><span class="line"></span><br><span class="line">           Loggers.SRV_LOG.info(<span class="string">&quot;open empty service auto clean job, initialDelay : &#123;&#125; ms, period : &#123;&#125; ms&quot;</span>,</span><br><span class="line">                   cleanEmptyServiceDelay, cleanEmptyServicePeriod);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// delay 60s, period 20s;</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// This task is not recommended to be performed frequently in order to avoid</span></span><br><span class="line">           <span class="comment">// the possibility that the service cache information may just be deleted</span></span><br><span class="line">           <span class="comment">// and then created due to the heartbeat mechanism</span></span><br><span class="line">		<span class="comment">// 清除注册表中的空service</span></span><br><span class="line">           <span class="comment">// 会操作这个集群</span></span><br><span class="line">           GlobalExecutor.scheduleServiceAutoClean(<span class="keyword">new</span> <span class="title class_">EmptyServiceAutoClean</span>(), cleanEmptyServiceDelay,</span><br><span class="line">                   cleanEmptyServicePeriod);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Loggers.SRV_LOG.info(<span class="string">&quot;listen for service meta change&quot;</span>);</span><br><span class="line">           consistencyService.listen(KeyBuilder.SERVICE_META_KEY_PREFIX, <span class="built_in">this</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">           Loggers.SRV_LOG.error(<span class="string">&quot;listen for service meta change failed!&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="上报本地注册表任务"><a href="#上报本地注册表任务" class="headerlink" title="上报本地注册表任务"></a>上报本地注册表任务</h5><p>上报注册表任务一看就知道是一个定时任务，我们来看一下这个任务具体的run方法。就是遍历所有的名称空间下的所有的服务，然后针对这些服务生成校验和，然后获取Nacos服务列表，发送出去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// key=namespaceId value是一个集合，集合中是当前namespace中的所有的service的名称</span></span><br><span class="line">        Map&lt;String, Set&lt;String&gt;&gt; allServiceNames = getAllServiceNames();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allServiceNames.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//ignore</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">for</span> (String namespaceId : allServiceNames.keySet()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">ServiceChecksum</span> <span class="variable">checksum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceChecksum</span>(namespaceId);</span><br><span class="line">			<span class="comment">// namespaceId -&gt; 所有的服务名称</span></span><br><span class="line">            <span class="comment">// 遍历所有的namespace </span></span><br><span class="line">            <span class="keyword">for</span> (String serviceName : allServiceNames.get(namespaceId)) &#123;</span><br><span class="line">                <span class="comment">// 若当前服务不归当前server负责就跳过</span></span><br><span class="line">                <span class="keyword">if</span> (!distroMapper.responsible(serviceName)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// 从注册表中获取当前遍历的服务</span></span><br><span class="line">                <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (service == <span class="literal">null</span> || service.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// 计算校验和</span></span><br><span class="line">                service.recalculateChecksum();</span><br><span class="line">				<span class="comment">// 将计算好的校验和放入map</span></span><br><span class="line">                checksum.addItem(serviceName, service.getChecksum());</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 发给其他服务器的时候 发送是这个</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">			<span class="comment">// 将当前namespace所有服务的校验和封装进去</span></span><br><span class="line">            msg.setData(JacksonUtils.toJson(checksum));</span><br><span class="line">			<span class="comment">// 获取到所有的nacos</span></span><br><span class="line">            Collection&lt;Member&gt; sameSiteServers = memberManager.allMembers();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sameSiteServers == <span class="literal">null</span> || sameSiteServers.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 遍历发送</span></span><br><span class="line">            <span class="keyword">for</span> (Member server : sameSiteServers) &#123;</span><br><span class="line">                <span class="comment">// 跳过当前server</span></span><br><span class="line">                <span class="keyword">if</span> (server.getAddress().equals(NetUtils.localServer())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 同步器发送</span></span><br><span class="line">                synchronizer.send(server.getAddress(), msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Loggers.SRV_LOG.error(<span class="string">&quot;[DOMAIN-STATUS] Exception while sending service status&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        GlobalExecutor.scheduleServiceReporter(<span class="built_in">this</span>, switchDomain.getServiceStatusSynchronizationPeriodMillis(),</span><br><span class="line">                                               TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后继续分析一下发送状态同步是怎么做的，这就要研究 synchronizer.send(server.getAddress(), msg)这个方法了，进入方法内部</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> String serverIP, Message msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (serverIP == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(<span class="number">10</span>);</span><br><span class="line">       </span><br><span class="line">       params.put(<span class="string">&quot;statuses&quot;</span>, msg.getData());</span><br><span class="line">       params.put(<span class="string">&quot;clientIP&quot;</span>, NetUtils.localServer());</span><br><span class="line">       </span><br><span class="line">       <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span> + serverIP + <span class="string">&quot;:&quot;</span> + EnvUtil.getPort() + EnvUtil.getContextPath()</span><br><span class="line">               + UtilsAndCommons.NACOS_NAMING_CONTEXT + <span class="string">&quot;/service/status&quot;</span>;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (IPUtil.containsPort(serverIP)) &#123;</span><br><span class="line">           url = <span class="string">&quot;http://&quot;</span> + serverIP + EnvUtil.getContextPath() + UtilsAndCommons.NACOS_NAMING_CONTEXT</span><br><span class="line">                   + <span class="string">&quot;/service/status&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 发送Post请求</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           HttpClient.asyncHttpPostLarge(url, <span class="literal">null</span>, JacksonUtils.toJson(params), <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;String&gt;() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(RestResult&lt;String&gt; result)</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!result.ok()) &#123;</span><br><span class="line">                       Loggers.SRV_LOG.warn(<span class="string">&quot;[STATUS-SYNCHRONIZE] failed to request serviceStatus, remote server: &#123;&#125;&quot;</span>,</span><br><span class="line">                               serverIP);</span><br><span class="line">       </span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">   </span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                   Loggers.SRV_LOG.warn(<span class="string">&quot;[STATUS-SYNCHRONIZE] failed to request serviceStatus, remote server: &quot;</span> + serverIP, throwable);</span><br><span class="line">               &#125;</span><br><span class="line">   </span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCancel</span><span class="params">()</span> &#123;</span><br><span class="line">       </span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           Loggers.SRV_LOG.warn(<span class="string">&quot;[STATUS-SYNCHRONIZE] failed to request serviceStatus, remote server: &quot;</span> + serverIP, e);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="从其他Nacos获取最新注册表并更新到本地"><a href="#从其他Nacos获取最新注册表并更新到本地" class="headerlink" title="从其他Nacos获取最新注册表并更新到本地"></a>从其他Nacos获取最新注册表并更新到本地</h5><p>开始分析第二个任务，这个任务不是定时任务而是一个无限循环，从队列里面取出来一个发生了状态变更的service，然后启动一个线程来处理更新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UpdatedServiceProcessor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get changed service from other server asynchronously</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ServiceKey</span> <span class="variable">serviceKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 其他服务发生了变更，全都放在这个队列中</span></span><br><span class="line">                    <span class="comment">// 从这个队列里面取出来一个状态发生了变更的服务</span></span><br><span class="line">                    serviceKey = toBeUpdatedServicesQueue.take();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Loggers.EVT_LOG.error(<span class="string">&quot;[UPDATE-DOMAIN] Exception while taking item from LinkedBlockingDeque.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (serviceKey == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 另外启动一个线程来完成一个ServiceUpdate任务，</span></span><br><span class="line">                GlobalExecutor.submitServiceUpdate(<span class="keyword">new</span> <span class="title class_">ServiceUpdater</span>(serviceKey));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Loggers.EVT_LOG.error(<span class="string">&quot;[UPDATE-DOMAIN] Exception while update service: &#123;&#125;&quot;</span>, serviceKey, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>进入ServiceUpdater这个类，这个类是一个线程类，重点就是看一下run方法，内部调用的是updatedHealthStatus(namespaceId, serviceName, serverIP)，所以还要点进去看看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ServiceUpdater</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        String namespaceId;</span><br><span class="line"></span><br><span class="line">        String serviceName;</span><br><span class="line"></span><br><span class="line">        String serverIP;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ServiceUpdater</span><span class="params">(ServiceKey serviceKey)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.namespaceId = serviceKey.getNamespaceId();</span><br><span class="line">            <span class="built_in">this</span>.serviceName = serviceKey.getServiceName();</span><br><span class="line">            <span class="built_in">this</span>.serverIP = serviceKey.getServerIP();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                updatedHealthStatus(namespaceId, serviceName, serverIP);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Loggers.SRV_LOG</span><br><span class="line">                        .warn(<span class="string">&quot;[DOMAIN-UPDATER] Exception while update service: &#123;&#125; from &#123;&#125;, error: &#123;&#125;&quot;</span>, serviceName,</span><br><span class="line">                                serverIP, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体的更新方法</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Update health status of instance in service.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> namespaceId namespace</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName service name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serverIP    source server Ip</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updatedHealthStatus</span><span class="params">(String namespaceId, String serviceName, String serverIP)</span> &#123;</span><br><span class="line">   	<span class="comment">// 同步器从其他server获取指定服务的数据</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> synchronizer.get(serverIP, UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName));</span><br><span class="line">    <span class="type">JsonNode</span> <span class="variable">serviceJson</span> <span class="operator">=</span> JacksonUtils.toObj(msg.getData());</span><br><span class="line">	<span class="comment">// 过去这个服务所有的实例</span></span><br><span class="line">    <span class="type">ArrayNode</span> <span class="variable">ipList</span> <span class="operator">=</span> (ArrayNode) serviceJson.get(<span class="string">&quot;ips&quot;</span>);</span><br><span class="line">    <span class="comment">// 这个map是存的是所有的instance的健康状态</span></span><br><span class="line">    <span class="comment">// key -&gt; ip+port value = healthy </span></span><br><span class="line">    Map&lt;String, String&gt; ipsMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(ipList.size());</span><br><span class="line">    <span class="comment">// 遍历实例</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ipList.size(); i++) &#123;</span><br><span class="line">		<span class="comment">// 格式是 ip:prot_healthy</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> ipList.get(i).asText();</span><br><span class="line">        String[] strings = ip.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">        <span class="comment">// 将遍历的instance的地址和健康状态放入map</span></span><br><span class="line">        ipsMap.put(strings[<span class="number">0</span>], strings[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 从注册表中获取当前服务的</span></span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="comment">// 当前注册表中该服务所有instance</span></span><br><span class="line">    List&lt;Instance&gt; instances = service.allIPs();</span><br><span class="line">    <span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">		<span class="comment">//获取来自于其他nacos该服务的所有instance</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">valid</span> <span class="operator">=</span> Boolean.parseBoolean(ipsMap.get(instance.toIpAddr()));</span><br><span class="line">        <span class="comment">// 如果当前注册表中的instance的状态和外来的不一致</span></span><br><span class="line">        <span class="keyword">if</span> (valid != instance.isHealthy()) &#123;</span><br><span class="line">            <span class="comment">// 发生变更 以外来的为准</span></span><br><span class="line">            changed = <span class="literal">true</span>;</span><br><span class="line">            instance.setHealthy(valid);</span><br><span class="line">            Loggers.EVT_LOG.info(<span class="string">&quot;&#123;&#125; &#123;SYNC&#125; IP-&#123;&#125; : &#123;&#125;:&#123;&#125;@&#123;&#125;&quot;</span>, serviceName,</span><br><span class="line">                                 (instance.isHealthy() ? <span class="string">&quot;ENABLED&quot;</span> : <span class="string">&quot;DISABLED&quot;</span>), instance.getIp(), instance.getPort(),</span><br><span class="line">                                 instance.getClusterName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 只要有一个发生变更了 </span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        <span class="comment">// 向client发送推送 详见服务端发送UDP推送</span></span><br><span class="line">        pushService.serviceChanged(service);</span><br><span class="line">        <span class="keyword">if</span> (Loggers.EVT_LOG.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            List&lt;Instance&gt; allIps = service.allIPs();</span><br><span class="line">            <span class="keyword">for</span> (Instance instance : allIps) &#123;</span><br><span class="line">                stringBuilder.append(instance.toIpAddr()).append(<span class="string">&quot;_&quot;</span>).append(instance.isHealthy()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Loggers.EVT_LOG</span><br><span class="line">                .debug(<span class="string">&quot;[HEALTH-STATUS-UPDATED] namespace: &#123;&#125;, service: &#123;&#125;, ips: &#123;&#125;&quot;</span>, service.getNamespaceId(),</span><br><span class="line">                       service.getName(), stringBuilder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="定时清理空Service"><a href="#定时清理空Service" class="headerlink" title="定时清理空Service"></a>定时清理空Service</h5><p>第三个任务是一个典型的定时任务，开启后60S后执行，每20S执行一次，来看看具体是怎么做空Service清除的。主要做事情有几步：</p>
<ol>
<li>遍历所有的service取出来当前服务负责的</li>
<li>如果某个服务是空的，那么不要直接删除而是看它被判定为空的次数是不是大于阈值3</li>
<li>删除服务并且通过同步服务通知到其他Nacos Server</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 空Service即为没有instance的Service</span></span><br><span class="line">GlobalExecutor.scheduleServiceAutoClean(<span class="keyword">new</span> <span class="title class_">EmptyServiceAutoClean</span>(), cleanEmptyServiceDelay,</span><br><span class="line">        cleanEmptyServicePeriod);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parallel flow opening threshold</span></span><br><span class="line">	<span class="comment">// 这是一个并行流的阈值，一个namespace下的service数量超过100的时候，会将注册表创建为一个并行流</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">parallelSize</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">	<span class="comment">// serviceMap就是注册表内层map</span></span><br><span class="line">    serviceMap.forEach((namespace, stringServiceMap) -&gt; &#123;</span><br><span class="line">        Stream&lt;Map.Entry&lt;String, Service&gt;&gt; stream = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 如果当前遍历的这个元素（namespace），包含的服务的数量超出了并行流阈值</span></span><br><span class="line">        <span class="comment">// 生产一个并行流</span></span><br><span class="line">        <span class="keyword">if</span> (stringServiceMap.size() &gt; parallelSize) &#123;</span><br><span class="line">            stream = stringServiceMap.entrySet().parallelStream();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stream = stringServiceMap.entrySet().stream();</span><br><span class="line">        &#125;</span><br><span class="line">        stream.filter(entry -&gt; &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="comment">// 当前遍历的服务是需要当前server负责的，通过过滤</span></span><br><span class="line">            <span class="keyword">return</span> distroMapper.responsible(serviceName);</span><br><span class="line">            <span class="comment">// 这里处理的server一定就是当前server负责的</span></span><br><span class="line">            <span class="comment">// 元素不空则进行操作 -&gt; </span></span><br><span class="line">        &#125;).forEach(entry -&gt; stringServiceMap.computeIfPresent(entry.getKey(), (serviceName, service) -&gt; &#123;</span><br><span class="line">           <span class="comment">// 这个服务是空的</span></span><br><span class="line">            <span class="keyword">if</span> (service.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// To avoid violent Service removal, the number of times the Service</span></span><br><span class="line">                <span class="comment">// experiences Empty is determined by finalizeCnt, and if the specified</span></span><br><span class="line">                <span class="comment">// value is reached, it is removed</span></span><br><span class="line">				<span class="comment">// service.getFinalizeCount() -&gt; 记录的是这个service被判断为空的次数 3次 </span></span><br><span class="line">                <span class="comment">// 为空的次数超过了最大允许值，就删除这个服务</span></span><br><span class="line">                <span class="keyword">if</span> (service.getFinalizeCount() &gt; maxFinalizeCount) &#123;</span><br><span class="line">                    Loggers.SRV_LOG.warn(<span class="string">&quot;namespace : &#123;&#125;, [&#123;&#125;] services are automatically cleaned&quot;</span>, namespace,</span><br><span class="line">                                         serviceName);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 通过同步服务remove</span></span><br><span class="line">                        easyRemoveService(namespace, serviceName);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Loggers.SRV_LOG.error(<span class="string">&quot;namespace : &#123;&#125;, [&#123;&#125;] services are automatically clean has &quot;</span></span><br><span class="line">                                              + <span class="string">&quot;error : &#123;&#125;&quot;</span>, namespace, serviceName, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// 计数器+1</span></span><br><span class="line">                service.setFinalizeCount(service.getFinalizeCount() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                Loggers.SRV_LOG</span><br><span class="line">                    .debug(<span class="string">&quot;namespace : &#123;&#125;, [&#123;&#125;] The number of times the current service experiences &quot;</span></span><br><span class="line">                           + <span class="string">&quot;an empty instance is : &#123;&#125;&quot;</span>, namespace, serviceName,</span><br><span class="line">                           service.getFinalizeCount());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 不为空的话就把判定为空的次数设置为0</span></span><br><span class="line">                service.setFinalizeCount(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> service;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个步骤在这个方法中已经体现了，现在还有一点不情况的是如何通过同步服务通知到其他Nacos Server，就是用的同步服务的remove方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">easyRemoveService</span><span class="params">(String namespaceId, String serviceName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;specified service not exist, serviceName : &quot;</span> + serviceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        consistencyService.remove(KeyBuilder.buildServiceMetaKey(namespaceId, serviceName));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="header cap theme"><span>接下来阅读</span></section><section class="body fs14"><div class="line"></div><a id="prev" href="/2022/03/23/SpringCloud-GateWay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">SpringCloud GateWay源码分析<span class="note">较新</span></a></section></div>






  <div class='related-wrap md reveal' id="comments">
    <div class='cmt-title cap theme'>
      快来参与讨论吧
    </div>
    <div class='cmt-body beaudar'>
      

<svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="beaudar" repo="eurekawm/blog-comments" issue-term="pathname" theme="preferred-color-scheme" input-position="top" comment-order="desc" loading="false" branch="main"></div>

    </div>
  </div>



      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
<p>本站由 <a href="http://example.com/">@sean</a> 创建，使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.6.1" title="v1.6.1">Stellar</a> 作为主题。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.6.1';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js',
    sitesjs: '/js/plugins/sites.js',
    friendsjs: '/js/plugins/friends.js',
  };

  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@6/swiper-bundle.min.css","js":"https://unpkg.com/swiper@6/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://cdn.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function loadBeaudar() {
    const els = document.querySelectorAll("#comments #beaudar");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.log(error);
      }
      var script = document.createElement('script');
      script.src = 'https://beaudar.lipk.org/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
      loadBeaudar();
  });
</script>




<!-- inject -->


  </div>
</body>
</html>
