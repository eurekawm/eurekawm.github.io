<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.1.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://cdn.jsdelivr.net'>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  <title>SpringCloud OpenFeign源码分析 - 灰色と青</title>

  
    <meta name="description" content="SpringCloud OpenFeign源码分析概述OpenFeign简介官网说明Declarative REST Client: Feign creates a dynamic implementation of an interface decorated with JAX-RS or Spring MVC annotations 声明式 REST 客户端：Feign 通过 JAX-RS 或">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud OpenFeign源码分析">
<meta property="og:url" content="http://example.com/2022/03/24/SpringCloud-OpenFeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="灰色と青">
<meta property="og:description" content="SpringCloud OpenFeign源码分析概述OpenFeign简介官网说明Declarative REST Client: Feign creates a dynamic implementation of an interface decorated with JAX-RS or Spring MVC annotations 声明式 REST 客户端：Feign 通过 JAX-RS 或">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203241951955.png">
<meta property="og:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203242022931.png">
<meta property="og:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203250029330.png">
<meta property="article:published_time" content="2022-03-24T03:56:36.000Z">
<meta property="article:modified_time" content="2022-03-24T16:46:14.355Z">
<meta property="article:author" content="sean">
<meta property="article:tag" content="RPC">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="分布式系统">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203241951955.png">
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="灰色と青" type="application/atom+xml">
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  
</head>

<body>
  


  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    


<header class="header">

<div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://cdn.jsdelivr.net/gh/cdn-x/placeholder@1.0.2/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/images/header.jpg" onerror="javascript:this.classList.add('error');this.src='https://cdn.jsdelivr.net/gh/cdn-x/placeholder@1.0.1/image/2659360.svg';"></a><a class="title" href="/"><div class="main">灰色と青</div><div class="sub cap">Eurekawm's Blog</div></a></div>
<nav class="menu dis-select"><a class="nav-item active" href="/">文章</a><a class="nav-item" href="/wiki/">项目</a><a class="nav-item" href="/notes/">笔记</a><a class="nav-item" href="/more/">更多</a></nav></header>

<div class="widgets">

<div class="widget-wrap single" id="toc"><div class="widget-header cap dis-select"><span class="name">本文目录</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign%E7%AE%80%E4%BB%8B"><span class="toc-text">OpenFeign简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%98%E7%BD%91%E8%AF%B4%E6%98%8E"><span class="toc-text">官网说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E8%AF%B4%E6%98%8E"><span class="toc-text">综合说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ribbon%E5%92%8COpenFeign"><span class="toc-text">Ribbon和OpenFeign</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%B3%A8%E8%A7%A3%E8%A7%A3%E6%9E%90"><span class="toc-text">重要注解解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EnableFeignClients"><span class="toc-text">@EnableFeignClients</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FeignClient"><span class="toc-text">@FeignClient</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81API%E8%A7%A3%E6%9E%90"><span class="toc-text">重要API解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FeignClientSpecification%E7%B1%BB"><span class="toc-text">FeignClientSpecification类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanDefination%E6%8E%A5%E5%8F%A3"><span class="toc-text">BeanDefination接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanDefinationRegistry%E6%8E%A5%E5%8F%A3"><span class="toc-text">BeanDefinationRegistry接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FeignContext"><span class="toc-text">FeignContext</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FeignClient%E5%88%9B%E5%BB%BA"><span class="toc-text">FeignClient创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FeignClient%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="toc-text">FeignClient自动注册</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RegisterDefaultConfiguration%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-text">RegisterDefaultConfiguration方法分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RegisterFeignClients%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-text">RegisterFeignClients方法分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FeignClient%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">FeignClient自动配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FeignClient%E5%88%9B%E5%BB%BA-1"><span class="toc-text">FeignClient创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FeignClient%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-text">FeignClient发送请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">Ribbon负载均衡</span></a></li></ol></li></ol></div></div></div>


</div>


    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Java/">Java</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/Java/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></div><div id="post-meta">发布于&nbsp;<time datetime="2022-03-24T03:56:36.000Z">2022-03-24</time></div></div>

<article class='content md post'>
<h1 class="article-title"><span>SpringCloud OpenFeign源码分析</span></h1>
<h1 id="SpringCloud-OpenFeign源码分析"><a href="#SpringCloud-OpenFeign源码分析" class="headerlink" title="SpringCloud OpenFeign源码分析"></a>SpringCloud OpenFeign源码分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="OpenFeign简介"><a href="#OpenFeign简介" class="headerlink" title="OpenFeign简介"></a>OpenFeign简介</h3><h4 id="官网说明"><a href="#官网说明" class="headerlink" title="官网说明"></a>官网说明</h4><p>Declarative REST Client: Feign creates a dynamic implementation of an interface decorated with JAX-RS or Spring MVC annotations</p>
<p>声明式 REST 客户端：Feign 通过 JAX-RS 或 Spring MVC 注解装饰的方式，生成接口的动态实现</p>
<h4 id="综合说明"><a href="#综合说明" class="headerlink" title="综合说明"></a>综合说明</h4><p>官网这段话什么意思？OpenFeign可以将提供者的Restful服务伪装成为接口进行消费，消费者只需要使用 feign接口+注解即可调用提供者的服务，无需RestTemplate。</p>
<p>注意： OpenFeign只和消费者有关，和提供者没有任何关系。</p>
<h4 id="Ribbon和OpenFeign"><a href="#Ribbon和OpenFeign" class="headerlink" title="Ribbon和OpenFeign"></a>Ribbon和OpenFeign</h4><p>OpenFeign默认集成了Ribbon作为负载均衡组件，OpenFeign是工作在客户端的使用，在发起RPC使用的就是Ribbon的负载均衡功能。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="重要注解解析"><a href="#重要注解解析" class="headerlink" title="重要注解解析"></a>重要注解解析</h3><h4 id="EnableFeignClients"><a href="#EnableFeignClients" class="headerlink" title="@EnableFeignClients"></a>@EnableFeignClients</h4><p>在SpringBoot中存在大量的@EnableXxx这种注解。它们的作用是，开启某项功能。其实它们本质上是为了导入某个类来完成某项功能。所以这个注解一般会组合一个@Import注解用于导入类。导入的类一般有三种：</p>
<ol>
<li>配置类：一般以Configuration结尾，完成自动配置</li>
<li>选择器：一般以Selector结尾，完成自动选择</li>
<li>注册器：一般以Registrar结尾，完成自动注册</li>
</ol>
<p>这里的@EnableFeignClients就是扫描那些申明为@FeignClient的接口，然后import一个自动注册Bean，把@FeignClient的类注册到容器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scans for interfaces that declare they are feign clients (via</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.cloud.openfeign.FeignClient&#125; &lt;code&gt;<span class="doctag">@FeignClient</span>&lt;/code&gt;).</span></span><br><span class="line"><span class="comment"> * Configures component scanning directives for use with</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.context.annotation.Configuration&#125;</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;<span class="doctag">@Configuration</span>&lt;/code&gt; classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="comment">// 导入一个类</span></span><br><span class="line"><span class="meta">@Import(FeignClientsRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableFeignClients &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation</span></span><br><span class="line"><span class="comment">	 * declarations e.g.: &#123;<span class="doctag">@code</span> <span class="doctag">@ComponentScan</span>(&quot;org.my.pkg&quot;)&#125; instead of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> <span class="doctag">@ComponentScan</span>(basePackages=&quot;org.my.pkg&quot;)&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the array of &#x27;basePackages&#x27;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Base packages to scan for annotated components.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> #value()&#125; is an alias for (and mutually exclusive with) this attribute.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Use &#123;<span class="doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based</span></span><br><span class="line"><span class="comment">	 * package names.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the array of &#x27;basePackages&#x27;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 扫描的基本包</span></span><br><span class="line">	String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Type-safe alternative to &#123;<span class="doctag">@link</span> #basePackages()&#125; for specifying the packages to</span></span><br><span class="line"><span class="comment">	 * scan for annotated components. The package of each class specified will be scanned.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Consider creating a special no-op marker class or interface in each package that</span></span><br><span class="line"><span class="comment">	 * serves no purpose other than being referenced by this attribute.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the array of &#x27;basePackageClasses&#x27;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 扫描某个Bean所在包下所有的FeignClients</span></span><br><span class="line">	Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * A custom &lt;code&gt;<span class="doctag">@Configuration</span>&lt;/code&gt; for all feign clients. Can contain override</span></span><br><span class="line"><span class="comment">	 * &lt;code&gt;<span class="doctag">@Bean</span>&lt;/code&gt; definition for the pieces that make up the client, for instance</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> feign.codec.Decoder&#125;, &#123;<span class="doctag">@link</span> feign.codec.Encoder&#125;, &#123;<span class="doctag">@link</span> feign.Contract&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> FeignClientsConfiguration for the defaults</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> list of default configurations</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 导入一些自定义的 Feign需要的配置类</span></span><br><span class="line">	Class&lt;?&gt;[] defaultConfiguration() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * List of classes annotated with <span class="doctag">@FeignClient</span>. If not empty, disables classpath</span></span><br><span class="line"><span class="comment">	 * scanning.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> list of FeignClient classes</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 指定有@FeignClient注解的接口，可以是多个，启用后不再包扫描</span></span><br><span class="line">	Class&lt;?&gt;[] clients() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FeignClient"><a href="#FeignClient" class="headerlink" title="@FeignClient"></a>@FeignClient</h4><p>详细见注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FeignClient &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The name of the service with optional protocol prefix. Synonym for &#123;<span class="doctag">@link</span> #name()</span></span><br><span class="line"><span class="comment">	 * name&#125;. A name must be specified for all clients, whether or not a url is provided.</span></span><br><span class="line"><span class="comment">	 * Can be specified as property key, eg: $&#123;propertyKey&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the name of the service with optional protocol prefix</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// value 就是要消费的微服务提供者的名称 默认是HTTP 必须指定</span></span><br><span class="line">	<span class="meta">@AliasFor(&quot;name&quot;)</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The service id with optional protocol prefix. Synonym for &#123;<span class="doctag">@link</span> #value() value&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@deprecated</span> use &#123;<span class="doctag">@link</span> #name() name&#125; instead</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the service id with optional protocol prefix</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	String <span class="title function_">serviceId</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * This will be used as the bean name instead of name if present, but will not be used</span></span><br><span class="line"><span class="comment">	 * as a service id.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> bean name instead of name if present</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//  优先级高于 name value serviceId 其实也是指定服务名称</span></span><br><span class="line">	String <span class="title function_">contextId</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The service id with optional protocol prefix. Synonym for &#123;<span class="doctag">@link</span> #value()</span></span><br><span class="line"><span class="comment">	 * value&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">	String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the &lt;code&gt;<span class="doctag">@Qualifier</span>&lt;/code&gt; value for the feign client.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 给FeignClient指定一个名字 避免多个FeignClient存在的时候因为同名 注入失败</span></span><br><span class="line">	String <span class="title function_">qualifier</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> an absolute URL or resolvable hostname (the protocol is optional).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 要访问的服务的Host，这里就是直连而不是负载均衡了</span></span><br><span class="line">	String <span class="title function_">url</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> whether 404s should be decoded instead of throwing FeignExceptions</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">decode404</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * A custom configuration class for the feign client. Can contain override</span></span><br><span class="line"><span class="comment">	 * &lt;code&gt;<span class="doctag">@Bean</span>&lt;/code&gt; definition for the pieces that make up the client, for instance</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> feign.codec.Decoder&#125;, &#123;<span class="doctag">@link</span> feign.codec.Encoder&#125;, &#123;<span class="doctag">@link</span> feign.Contract&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> FeignClientsConfiguration for the defaults</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> list of configurations for feign client</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] configuration() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Fallback class for the specified Feign client interface. The fallback class must</span></span><br><span class="line"><span class="comment">	 * implement the interface annotated by this annotation and be a valid spring bean.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> fallback class for the specified Feign client interface</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// fallback类</span></span><br><span class="line">	Class&lt;?&gt; fallback() <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Define a fallback factory for the specified Feign client interface. The fallback</span></span><br><span class="line"><span class="comment">	 * factory must produce instances of fallback classes that implement the interface</span></span><br><span class="line"><span class="comment">	 * annotated by &#123;<span class="doctag">@link</span> FeignClient&#125;. The fallback factory must be a valid spring bean.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> feign.hystrix.FallbackFactory for details.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> fallback factory for the specified Feign client interface</span></span><br><span class="line"><span class="comment">	 */</span> </span><br><span class="line">	Class&lt;?&gt; fallbackFactory() <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> path prefix to be used by all method-level mappings. Can be used with or</span></span><br><span class="line"><span class="comment">	 * without &lt;code&gt;<span class="doctag">@RibbonClient</span>&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 用path就不用@RequestMapping 方法级别的mapping</span></span><br><span class="line">	String <span class="title function_">path</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> whether to mark the feign proxy as a primary bean. Defaults to true.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// 如果一个FeignClient有多个实现类，用这个来标记就会优先注入</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">primary</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重要API解析"><a href="#重要API解析" class="headerlink" title="重要API解析"></a>重要API解析</h3><h4 id="FeignClientSpecification类"><a href="#FeignClientSpecification类" class="headerlink" title="FeignClientSpecification类"></a>FeignClientSpecification类</h4><p>FeignClientSpecification是一个FeignClient生成规范，他是NamedContextFactory.Specification的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specification with name and configuration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// SpringCloud的规范</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Specification</span> &#123;</span><br><span class="line"></span><br><span class="line">	String <span class="title function_">getName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt;[] getConfiguration();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="BeanDefination接口"><a href="#BeanDefination接口" class="headerlink" title="BeanDefination接口"></a>BeanDefination接口</h4><p>是一个Bean定义器，是一个Bean的定义，描述了一个Bean的各种属性，可以根据它生成一个Bean。</p>
<h4 id="BeanDefinationRegistry接口"><a href="#BeanDefinationRegistry接口" class="headerlink" title="BeanDefinationRegistry接口"></a>BeanDefinationRegistry接口</h4><p>BeanDefinationRegistry是BeanDefination的注册器，把BeanDefination注册到map，通过名称获取BeanDefination。</p>
<h4 id="FeignContext"><a href="#FeignContext" class="headerlink" title="FeignContext"></a>FeignContext</h4><p>一个典型的上下文，是一个子容器，每个FeignClient有一个子容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignContext</span> <span class="keyword">extends</span> <span class="title class_">NamedContextFactory</span>&lt;FeignClientSpecification&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">FeignContext</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(FeignClientsConfiguration.class, <span class="string">&quot;feign&quot;</span>, <span class="string">&quot;feign.client.name&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getInstanceWithoutAncestors</span><span class="params">(String name, Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> BeanFactoryUtils.beanOfType(getContext(name), type);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; Map&lt;String, T&gt; <span class="title function_">getInstancesWithoutAncestors</span><span class="params">(String name, Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getContext(name).getBeansOfType(type);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父类</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> add javadoc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">NamedContextFactory</span>&lt;C <span class="keyword">extends</span> <span class="title class_">NamedContextFactory</span>.Specification&gt;</span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">DisposableBean</span>, ApplicationContextAware &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String propertySourceName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String propertyName;</span><br><span class="line">	<span class="comment">// 该map的key我FeignClient名称 其所要调用的微服务名</span></span><br><span class="line">    <span class="comment">// value为组装这个FeignClient所必须的组件所在的Spring子容器</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, AnnotationConfigApplicationContext&gt; contexts = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">	<span class="comment">// 这个map是存放@EnableFeignClients和@FeignClient两个注解中的Configuration属性值</span></span><br><span class="line">    <span class="comment">// 这个属性值只有两类 第一类只有一个其key为字符串 default+当前启动类全限定类名</span></span><br><span class="line">    <span class="comment">// 例如default.com.abc.Comsumer8080 value为@EnableFeignClients的default Configuration属性值</span></span><br><span class="line">    <span class="comment">// 第二类有多个key = 当前@FeignClient名称，value为这个client的注解的configuration属性值</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, C&gt; configurations = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ApplicationContext parent;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; defaultConfigType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FeignClient创建"><a href="#FeignClient创建" class="headerlink" title="FeignClient创建"></a>FeignClient创建</h3><h4 id="FeignClient自动注册"><a href="#FeignClient自动注册" class="headerlink" title="FeignClient自动注册"></a>FeignClient自动注册</h4><p>在@EnableFeignClients里面有一个@Import(FeignClientsRegistrar.class)，导入了这个注册类，他是ImportBeanDefinitionRegistrar接口实现类，里面有一个registerBeanDefinations方法，也就是把FeignClient注册到Spring的map中，交给容器来管理。我们看一下怎么做的</p>
<ol>
<li>将@EnableFeignClients直接中的defaultConfiguration注册到一个缓存map</li>
<li>完成了3项工作<ol>
<li>扫描所有的带了@FeignClient的接口</li>
<li>将每个@FeignClient注解的defaultConfiguration注册到一个map</li>
<li>根据@FeignClient注解元数据生成一个FeignClientFactoryBean的BeanDefination 并将这个BeanDefination放入一个map</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata,</span></span><br><span class="line"><span class="params">		BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">       </span><br><span class="line">	registerDefaultConfiguration(metadata, registry);</span><br><span class="line">	registerFeignClients(metadata, registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RegisterDefaultConfiguration方法分析"><a href="#RegisterDefaultConfiguration方法分析" class="headerlink" title="RegisterDefaultConfiguration方法分析"></a>RegisterDefaultConfiguration方法分析</h5><p> 进入这个方法内部先分析参数metadata和registry</p>
<ul>
<li>metadata 包含了@EnableFeignClients和@SpringBootApplication两个注解的元数据</li>
<li>registry  BeanDefination注册器</li>
</ul>
<p>经过registerDefaultConfiguration方法，FeignClientSpecification的BeanDefination就被注册到了map中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerDefaultConfiguration</span><span class="params">(AnnotationMetadata metadata,</span></span><br><span class="line"><span class="params">		BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">       <span class="comment">// 获取到EnableFeignClients注解的属性值 </span></span><br><span class="line">	Map&lt;String, Object&gt; defaultAttrs = metadata</span><br><span class="line">           <span class="comment">// 第二个属性把class类变为了string属性</span></span><br><span class="line">			.getAnnotationAttributes(EnableFeignClients.class.getName(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (defaultAttrs != <span class="literal">null</span> &amp;&amp; defaultAttrs.containsKey(<span class="string">&quot;defaultConfiguration&quot;</span>)) &#123;</span><br><span class="line">		String name;</span><br><span class="line">           <span class="comment">// 如果当前注解所标注的类为闭合类</span></span><br><span class="line">		<span class="keyword">if</span> (metadata.hasEnclosingClass()) &#123;</span><br><span class="line">			name = <span class="string">&quot;default.&quot;</span> + metadata.getEnclosingClassName();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			name = <span class="string">&quot;default.&quot;</span> + metadata.getClassName();</span><br><span class="line">		&#125;</span><br><span class="line">           <span class="comment">// 注册这个defaultConfiguration的属性</span></span><br><span class="line">		registerClientConfiguration(registry, name,</span><br><span class="line">				defaultAttrs.get(<span class="string">&quot;defaultConfiguration&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 具体如何注册</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerClientConfiguration</span><span class="params">(BeanDefinitionRegistry registry, Object name,</span></span><br><span class="line"><span class="params">		Object configuration)</span> &#123;</span><br><span class="line">       <span class="comment">// 先生成一个Builder 然后利用这个Builder生成一个FeignClientSpecification 的BeanDefination</span></span><br><span class="line">       <span class="comment">// 也就是一个FeignClient的生成规范 为将来的FeignClient生成提供规范</span></span><br><span class="line">	<span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder</span><br><span class="line">			.genericBeanDefinition(FeignClientSpecification.class);</span><br><span class="line">	builder.addConstructorArgValue(name);</span><br><span class="line">	builder.addConstructorArgValue(configuration);</span><br><span class="line">       <span class="comment">// 把这个BeanDefination注册到Map中去 </span></span><br><span class="line">	registry.registerBeanDefinition(</span><br><span class="line">			name + <span class="string">&quot;.&quot;</span> + FeignClientSpecification.class.getSimpleName(),</span><br><span class="line">			builder.getBeanDefinition());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RegisterFeignClients方法分析"><a href="#RegisterFeignClients方法分析" class="headerlink" title="RegisterFeignClients方法分析"></a>RegisterFeignClients方法分析</h5><p>第一步注册了FeignClient的定义信息，接下来就开始分析注册FeignClient。 就是扫描标记了@FeignClient的接口放入候选组件集合中，如果@EnableFeignClients注解里面有clients属性，就把这些接口添加进去，不进行包扫描了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerFeignClients</span><span class="params">(AnnotationMetadata metadata,</span></span><br><span class="line"><span class="params">			BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    	<span class="comment">// 初始化一个扫描器</span></span><br><span class="line">		<span class="type">ClassPathScanningCandidateComponentProvider</span> <span class="variable">scanner</span> <span class="operator">=</span> getScanner();</span><br><span class="line">		scanner.setResourceLoader(<span class="built_in">this</span>.resourceLoader);</span><br><span class="line"></span><br><span class="line">		Set&lt;String&gt; basePackages;</span><br><span class="line">		<span class="comment">// 获取到@EnableFeignClient的属性</span></span><br><span class="line">		Map&lt;String, Object&gt; attrs = metadata</span><br><span class="line">				.getAnnotationAttributes(EnableFeignClients.class.getName());</span><br><span class="line">    	<span class="comment">// 为扫描器添加一个扫描@FeignClient的过滤器</span></span><br><span class="line">		<span class="type">AnnotationTypeFilter</span> <span class="variable">annotationTypeFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationTypeFilter</span>(</span><br><span class="line">				FeignClient.class);</span><br><span class="line">   		<span class="comment">// 获取里面的clients属性 如果不为空就禁用类路径扫描</span></span><br><span class="line">		<span class="keyword">final</span> Class&lt;?&gt;[] clients = attrs == <span class="literal">null</span> ? <span class="literal">null</span></span><br><span class="line">				: (Class&lt;?&gt;[]) attrs.get(<span class="string">&quot;clients&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (clients == <span class="literal">null</span> || clients.length == <span class="number">0</span>) &#123;</span><br><span class="line">			scanner.addIncludeFilter(annotationTypeFilter);</span><br><span class="line">            <span class="comment">// 获取@EnableFeignClients直接指定的基本包 就是那几个指定FeignClient所在包的属性 （value basePackages）</span></span><br><span class="line">            <span class="comment">// 获取的结果就是注解中指定的FeignClient所在包的path，并用Set装起来</span></span><br><span class="line">            <span class="comment">// 如果都没有的话 则添加当前注解标注的类所在的包添加进去</span></span><br><span class="line">			basePackages = getBasePackages(metadata);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 指定了clients属性 不进行包扫描 直接放入</span></span><br><span class="line">			<span class="keyword">final</span> Set&lt;String&gt; clientClasses = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">			basePackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">			<span class="keyword">for</span> (Class&lt;?&gt; clazz : clients) &#123;</span><br><span class="line">				basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">				clientClasses.add(clazz.getCanonicalName());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="type">AbstractClassTestingTypeFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AbstractClassTestingTypeFilter</span>() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">match</span><span class="params">(ClassMetadata metadata)</span> &#123;</span><br><span class="line">					<span class="type">String</span> <span class="variable">cleaned</span> <span class="operator">=</span> metadata.getClassName().replaceAll(<span class="string">&quot;\\$&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> clientClasses.contains(cleaned);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">			scanner.addIncludeFilter(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">AllTypeFilter</span>(Arrays.asList(filter, annotationTypeFilter)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 遍历这些基本包 将其中的@FeignClient标记的接口找到 放入候选组件里面</span></span><br><span class="line">		<span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">			Set&lt;BeanDefinition&gt; candidateComponents = scanner</span><br><span class="line">					.findCandidateComponents(basePackage);</span><br><span class="line">            <span class="comment">// 遍历这些候选组件 放入map中</span></span><br><span class="line">			<span class="keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) &#123;</span><br><span class="line">                <span class="comment">// 只处理由@FeignClient标注的</span></span><br><span class="line">				<span class="keyword">if</span> (candidateComponent <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">					<span class="comment">// verify annotated class is an interface</span></span><br><span class="line">					<span class="type">AnnotatedBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> (AnnotatedBeanDefinition) candidateComponent;</span><br><span class="line">                    <span class="comment">// 获取注解元数据</span></span><br><span class="line">					<span class="type">AnnotationMetadata</span> <span class="variable">annotationMetadata</span> <span class="operator">=</span> beanDefinition.getMetadata();</span><br><span class="line">                    <span class="comment">// 断言是一个接口 </span></span><br><span class="line">					Assert.isTrue(annotationMetadata.isInterface(),</span><br><span class="line">							<span class="string">&quot;@FeignClient can only be specified on an interface&quot;</span>);</span><br><span class="line">					<span class="comment">// 获取注解属性</span></span><br><span class="line">					Map&lt;String, Object&gt; attributes = annotationMetadata</span><br><span class="line">							.getAnnotationAttributes(</span><br><span class="line">									FeignClient.class.getCanonicalName());</span><br><span class="line">					<span class="comment">// 获取client name 比如微服务名</span></span><br><span class="line">					<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getClientName(attributes);</span><br><span class="line">                    <span class="comment">//  注册接口的configuration属性对应的配置类到map</span></span><br><span class="line">					registerClientConfiguration(registry, name,</span><br><span class="line">							attributes.get(<span class="string">&quot;configuration&quot;</span>));</span><br><span class="line">					<span class="comment">// 将FeignClientFactoryBean的BeanDefination注册到map</span></span><br><span class="line">					registerFeignClient(registry, annotationMetadata, attributes);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FeignClient自动配置"><a href="#FeignClient自动配置" class="headerlink" title="FeignClient自动配置"></a>FeignClient自动配置</h4><p>前面自动注册的代码我们是从注解下手，接下来我们要从spring.factories下手，因为OpenFeign作为一个SpringBoot程序，一定是有自动配置类的，我们通过这个自动配置类就可以研究出来OpenFeign是怎么完成自动配置的。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203241951955.png" alt="image-20220324195148905"></p>
<p>我们先看FeignAutoConfiguration自动配置类，首先是创建Feign的上下文， 里面有一个容器，容器里面是两个Map，第一个是存放Feign需要的组件，用的是子容器，另一个是放配置类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先是创建Feign的上下文</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FeignContext <span class="title function_">feignContext</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">FeignContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeignContext</span>();</span><br><span class="line">	context.setConfigurations(<span class="built_in">this</span>.configurations);</span><br><span class="line">	<span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这两个就是要用的的容器</span></span><br><span class="line"><span class="comment">// key -&gt; FeignClient名字 value -&gt; 子容器</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, AnnotationConfigApplicationContext&gt; contexts = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"> <span class="comment">// 这个map是存放@EnableFeignClients和@FeignClient两个注解中的Configuration属性值</span></span><br><span class="line">   <span class="comment">// 这个属性值只有两类 第一类只有一个其key为字符串 default+当前启动类全限定类名</span></span><br><span class="line">   <span class="comment">// 例如default.com.abc.Comsumer8080 value为@EnableFeignClients的default Configuration属性值</span></span><br><span class="line">   <span class="comment">// 第二类有多个key = 当前@FeignClient名称，value为这个client的注解的configuration属性值</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, C&gt; configurations = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>我们启动之后，创建好context之后，configurations就会有两个配置。name为default+启动类的全限定类名和name为微服务名称的。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203242022931.png" alt="image-20220324202236900"></p>
<h4 id="FeignClient创建-1"><a href="#FeignClient创建-1" class="headerlink" title="FeignClient创建"></a>FeignClient创建</h4><p>我们之前把FeignClientFactoryBean的DefinationBean注册到了map中，所以这个工厂Bean就可以为我们生产FeignClient了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the target type of the Feign client</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Feign&#125; client created with the specified data and the context</span></span><br><span class="line"><span class="comment"> * information</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">   <span class="comment">// org.springframework.cloud.openfeign.FeignClientFactoryBean#getTarget</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">getTarget</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 启动的时候已经有FeignContext了</span></span><br><span class="line">	<span class="type">FeignContext</span> <span class="variable">context</span> <span class="operator">=</span> applicationContext.getBean(FeignContext.class);</span><br><span class="line">       <span class="comment">// 从子容器中获取一个Builder</span></span><br><span class="line">	Feign.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> feign(context);</span><br><span class="line">	<span class="comment">// 如果URL属性为空说明要采用负载均衡方式调用</span></span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(url)) &#123;</span><br><span class="line">           <span class="comment">// 不是以http开头的加上http</span></span><br><span class="line">		<span class="keyword">if</span> (!name.startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">			url = <span class="string">&quot;http://&quot;</span> + name;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			url = name;</span><br><span class="line">		&#125;</span><br><span class="line">           <span class="comment">// 获得一个规范的url</span></span><br><span class="line">           <span class="comment">// 不是以/开头的path加上/ 以/结尾的path删除末尾的/</span></span><br><span class="line">		url += cleanPath();</span><br><span class="line">           <span class="comment">// 返回一个负载均衡调用</span></span><br><span class="line">		<span class="keyword">return</span> (T) loadBalance(builder, context,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">HardCodedTarget</span>&lt;&gt;(type, name, url));</span><br><span class="line">	&#125;</span><br><span class="line">       <span class="comment">// 不为空采用直连方式 直接调用提供者</span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(url) &amp;&amp; !url.startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">		url = <span class="string">&quot;http://&quot;</span> + url;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="built_in">this</span>.url + cleanPath();</span><br><span class="line">       <span class="comment">// 从子容器中获取Client</span></span><br><span class="line">	<span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> getOptional(context, Client.class);</span><br><span class="line">	<span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (client <span class="keyword">instanceof</span> LoadBalancerFeignClient) &#123;</span><br><span class="line">			<span class="comment">// not load balancing because we have a url,</span></span><br><span class="line">			<span class="comment">// but ribbon is on the classpath, so unwrap</span></span><br><span class="line">			client = ((LoadBalancerFeignClient) client).getDelegate();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (client <span class="keyword">instanceof</span> FeignBlockingLoadBalancerClient) &#123;</span><br><span class="line">			<span class="comment">// not load balancing because we have a url,</span></span><br><span class="line">			<span class="comment">// but Spring Cloud LoadBalancer is on the classpath, so unwrap</span></span><br><span class="line">			client = ((FeignBlockingLoadBalancerClient) client).getDelegate();</span><br><span class="line">		&#125;</span><br><span class="line">		builder.client(client);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">Targeter</span> <span class="variable">targeter</span> <span class="operator">=</span> get(context, Targeter.class);</span><br><span class="line">	<span class="keyword">return</span> (T) targeter.target(<span class="built_in">this</span>, builder, context,</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">HardCodedTarget</span>&lt;&gt;(type, name, url));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 	从子容器中获取组件</span></span><br><span class="line"><span class="keyword">protected</span> Feign.Builder <span class="title function_">feign</span><span class="params">(FeignContext context)</span> &#123;</span><br><span class="line">	<span class="type">FeignLoggerFactory</span> <span class="variable">loggerFactory</span> <span class="operator">=</span> get(context, FeignLoggerFactory.class);</span><br><span class="line">	<span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> loggerFactory.create(type);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @formatter:off</span></span><br><span class="line">	Feign.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> get(context, Feign.Builder.class)</span><br><span class="line">			<span class="comment">// required values</span></span><br><span class="line">			.logger(logger)</span><br><span class="line">			.encoder(get(context, Encoder.class))</span><br><span class="line">			.decoder(get(context, Decoder.class))</span><br><span class="line">			.contract(get(context, Contract.class));</span><br><span class="line">	<span class="comment">// @formatter:on</span></span><br><span class="line"></span><br><span class="line">	configureFeign(context, builder);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> builder;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从当前FeignClient的子容器中获取指定类型的实例</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">(FeignContext context, Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">       <span class="comment">// 从FeignClient的上下文中的context中的contexts中指定feign名称contextId的子容器中获取指定type实例</span></span><br><span class="line">	<span class="type">T</span> <span class="variable">instance</span> <span class="operator">=</span> context.getInstance(contextId, type);</span><br><span class="line">	<span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">				<span class="string">&quot;No bean found of type &quot;</span> + type + <span class="string">&quot; for &quot;</span> + contextId);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们分析FeignClient是怎么被创建出来的，也就是上面代码段的第25行，我们接着进入内部方法可以找到feign.Feign.Builder#target(feign.Target<T>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">target</span><span class="params">(Target&lt;T&gt; target)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> build().newInstance(target);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">newInstance</span><span class="params">(Target&lt;T&gt; target)</span> &#123;</span><br><span class="line">    <span class="comment">// key 方法名 value 方法处理器 有几个方法就有几个处理器</span></span><br><span class="line">  Map&lt;String, MethodHandler&gt; nameToHandler = targetToHandlersByName.apply(target);</span><br><span class="line">    <span class="comment">// key 方法 value方法处理器 </span></span><br><span class="line">  Map&lt;Method, MethodHandler&gt; methodToHandler = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;Method, MethodHandler&gt;();</span><br><span class="line">    <span class="comment">// 默认的方法处理器 </span></span><br><span class="line">  List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;DefaultMethodHandler&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Method method : target.type().getMethods()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isDefault(method)) &#123; <span class="comment">// 如果是默认方法 就放入这个集合</span></span><br><span class="line">      <span class="type">DefaultMethodHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMethodHandler</span>(method);</span><br><span class="line">      defaultMethodHandlers.add(handler);</span><br><span class="line">      methodToHandler.put(method, handler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">      methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// 网络请求就是这里发出</span></span><br><span class="line">  <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> factory.create(target, methodToHandler);</span><br><span class="line">    <span class="comment">// 反射机制创建的Feign JDK动态代理</span></span><br><span class="line">  <span class="type">T</span> <span class="variable">proxy</span> <span class="operator">=</span> (T) Proxy.newProxyInstance(target.type().getClassLoader(),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123;target.type()&#125;, handler);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) &#123;</span><br><span class="line">    defaultMethodHandler.bindTo(proxy);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FeignClient发送请求"><a href="#FeignClient发送请求" class="headerlink" title="FeignClient发送请求"></a>FeignClient发送请求</h3><p>上面有个关键信息，FeignClient是通过JDK动态代理创建出来的，然后看到这个InvocationHandler，我们这里肯定是创建了一个和Feign有关的InvocationHandler，所以我们要清楚这个factory.create(target, methodToHandler)到底是创建的什么。</p>
<p>这里是FeignInvocationHandler的创建方法，dispatch就是上面的methodToHandler，就是一个map key&#x3D;method value&#x3D;方法处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Default</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandlerFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> InvocationHandler <span class="title function_">create</span><span class="params">(Target target, Map&lt;Method, MethodHandler&gt; dispatch)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReflectiveFeign</span>.FeignInvocationHandler(target, dispatch);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是FeignInvocationHandler他是InvocationHandler接口的实现类，必然有一个invoke方法来真正调用我们的业务逻辑。这里做的事情就是过滤一些没有必要代理的方法之后，用那个方法处理器map根据具体method选出来的方法处理器来执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FeignInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Target target;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map &lt; Method,</span><br><span class="line">    MethodHandler &gt; dispatch;</span><br><span class="line">    FeignInvocationHandler(Target target, Map &lt; Method, MethodHandler &gt; dispatch) &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = checkNotNull(target, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.dispatch = checkNotNull(dispatch, <span class="string">&quot;dispatch for %s&quot;</span>, target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;equals&quot;</span>.equals(method.getName())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">otherHandler</span> <span class="operator">=</span> args.length &gt; <span class="number">0</span> &amp;&amp; args[<span class="number">0</span>] != <span class="literal">null</span> ? Proxy.getInvocationHandler(args[<span class="number">0</span>]) : <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span> equals(otherHandler);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;hashCode&quot;</span>.equals(method.getName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> hashCode();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;toString&quot;</span>.equals(method.getName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 排除一些基本方法，然后从dispatch发出请求</span></span><br><span class="line">        <span class="comment">// dispatch就是方法处理器map，根据这个method选出一个方法处理器执行就好了</span></span><br><span class="line">        <span class="keyword">return</span> dispatch.get(method).invoke(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入invoke方法，因为是OpenFeign实现的方法所以我们应该找到feign.SynchronousMethodHandler#invoke，这里首先是通过参数构建出一个请求模版，里面的参数是请求方式，URL之类的调用executeAndDecode方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable &#123; </span><br><span class="line">    <span class="comment">// 通过参数构建一个请求模版 </span></span><br><span class="line">    <span class="type">RequestTemplate</span> <span class="variable">template</span> <span class="operator">=</span> buildTemplateFromArgs.create(argv);</span><br><span class="line">    <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> findOptions(argv);</span><br><span class="line">    <span class="type">Retryer</span> <span class="variable">retryer</span> <span class="operator">=</span> <span class="built_in">this</span>.retryer.clone();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发起调用</span></span><br><span class="line">            <span class="keyword">return</span> executeAndDecode(template, options);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(RetryableException e) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                retryer.continueOrPropagate(e);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(RetryableException th) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> th.getCause();</span><br><span class="line">                <span class="keyword">if</span> (propagationPolicy == UNWRAP &amp;&amp; cause != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> cause;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> th;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">                logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入executeAndDecode内部，找到关键一行代码 response &#x3D; client.execute(request, options)，这里的Client就是我们要要使用的负载均衡器，如果@FeignClient声明的时候指定了URL，那就是直连方法请求，我们默认是使用的Ribbon的C负载均衡。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://raw.githubusercontent.com/eurekawm/picgo/main/img/202203250029330.png" alt="image-20220325002936288"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">executeAndDecode</span><span class="params">(RequestTemplate template, Options options)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> targetRequest(template);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        logger.logRequest(metadata.configKey(), logLevel, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response response;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = client.execute(request, options);</span><br><span class="line">        <span class="comment">// ensure the request is set. <span class="doctag">TODO:</span> remove in Feign 12</span></span><br><span class="line">        response = response.toBuilder().request(request).requestTemplate(template).build();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">            logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime(start));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> errorExecuting(request, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">elapsedTime</span> <span class="operator">=</span> TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (decoder != <span class="literal">null</span>) <span class="keyword">return</span> decoder.decode(response, metadata.returnType());</span><br><span class="line"></span><br><span class="line">    CompletableFuture &lt; Object &gt; resultFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span> &lt; &gt;();</span><br><span class="line">    asyncResponseHandler.handleResponse(resultFuture, metadata.configKey(), response, metadata.returnType(), elapsedTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!resultFuture.isDone()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Response handling not done&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultFuture.join();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(CompletionException e) &#123;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> e.getCause();</span><br><span class="line">        <span class="keyword">if</span> (cause != <span class="literal">null</span>) <span class="keyword">throw</span> cause;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后进入response &#x3D; client.execute(request, options)内部，feign.Client.Default#execute方法，因为指定了URL那么就不使用负载均行，而是起一个HTTP连接然后发送请求，获取应答。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> convertAndSend(request, options);</span><br><span class="line">    <span class="keyword">return</span> convertResponse(connection, request);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h3><p>上面发起请求是直连的情况下，如果要用到Ribbon那么在 response &#x3D; client.execute(request, options)这里使用的Client就不再是默认的Client了，而是 org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient#execute。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">asUri</span> <span class="operator">=</span> URI.create(request.url());</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientName</span> <span class="operator">=</span> asUri.getHost();</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uriWithoutHost</span> <span class="operator">=</span> cleanUrl(request.url(), clientName);</span><br><span class="line">        FeignLoadBalancer.<span class="type">RibbonRequest</span> <span class="variable">ribbonRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeignLoadBalancer</span>.RibbonRequest(<span class="built_in">this</span>.delegate, request, uriWithoutHost);</span><br><span class="line"></span><br><span class="line">        <span class="type">IClientConfig</span> <span class="variable">requestConfig</span> <span class="operator">=</span> getClientConfig(options, clientName);</span><br><span class="line">        <span class="comment">// 发起负载均行模式请求</span></span><br><span class="line">        <span class="keyword">return</span> lbClient(clientName).executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ClientException e) &#123;</span><br><span class="line">        <span class="type">IOException</span> <span class="variable">io</span> <span class="operator">=</span> findIOException(e);</span><br><span class="line">        <span class="keyword">if</span> (io != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> io;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">executeWithLoadBalancer</span><span class="params">(<span class="keyword">final</span> S request, <span class="keyword">final</span> IClientConfig requestConfig)</span> <span class="keyword">throws</span> ClientException &#123;</span><br><span class="line">    LoadBalancerCommand &lt; T &gt; command = buildLoadBalancerCommand(request, requestConfig);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 选择一个主机发起请求</span></span><br><span class="line">        <span class="keyword">return</span> command.submit(<span class="keyword">new</span> <span class="title class_">ServerOperation</span> &lt; T &gt; () &#123;<span class="meta">@Override</span> <span class="keyword">public</span> Observable &lt; T &gt; call(Server server) &#123;</span><br><span class="line">                <span class="type">URI</span> <span class="variable">finalUri</span> <span class="operator">=</span> reconstructURIWithServer(server, request.getUri());</span><br><span class="line">                <span class="type">S</span> <span class="variable">requestForServer</span> <span class="operator">=</span> (S) request.replaceUri(finalUri);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.just(AbstractLoadBalancerAwareClient.<span class="built_in">this</span>.execute(requestForServer, requestConfig));</span><br><span class="line">                &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).toBlocking().single();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> e.getCause();</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ClientException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ClientException) t;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="header cap theme"><span>接下来阅读</span></section><section class="body fs14"><a id="next" href="/2022/03/23/SpringCloud-GateWay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">SpringCloud GateWay源码分析<span class="note">较早</span></a><div class="line"></div></section></div>






  <div class='related-wrap md reveal' id="comments">
    <div class='cmt-title cap theme'>
      快来参与讨论吧
    </div>
    <div class='cmt-body beaudar'>
      

<svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="beaudar" repo="eurekawm/blog-comments" issue-term="pathname" theme="preferred-color-scheme" input-position="top" comment-order="desc" loading="false" branch="main"></div>

    </div>
  </div>



      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
<p>本站由 <a href="http://example.com/">@sean</a> 创建，使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.6.1" title="v1.6.1">Stellar</a> 作为主题。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.6.1';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js',
    sitesjs: '/js/plugins/sites.js',
    friendsjs: '/js/plugins/friends.js',
  };

  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@6/swiper-bundle.min.css","js":"https://unpkg.com/swiper@6/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://cdn.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function loadBeaudar() {
    const els = document.querySelectorAll("#comments #beaudar");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.log(error);
      }
      var script = document.createElement('script');
      script.src = 'https://beaudar.lipk.org/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
      loadBeaudar();
  });
</script>




<!-- inject -->


  </div>
</body>
</html>
